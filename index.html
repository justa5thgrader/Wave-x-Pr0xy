<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wave-X</title>
    <style>
        /* Old Windows-style cursors with hard reset (handles all elements, including SVGs/iframes overlay cases) */
:root {
            /* Site-wide custom PNG cursor embedded as data URL (hotspot near tip) with default fallback */
            --cursor-default:
              url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIQAAACECAYAAABu9c2rAAAACXBIWXMAAAsSAAALEgHS3X78AAABc0lEQVR4nO3QMaqDQBQF0f//h3u3mG+v0n2l1m0pQv1yC5y8cVQm0Y2k1JvQyYzv5w7g7mJ9cF3rF3z8HnH2b8zv3r4AABgqzv2mA1rA9b9gqYqg1b8QyQfQx4m9m5v6Q9JvI5wqg8bSJh6hVw4nqR3hQvGJrXy3VbJqf9lqYb0Vtqv1q9gQp8hGfYtqk2qX2tqkZ7V0qvY3qgqX9a0qfYPqkA6l8nYvGkUe5YV3eYpQf0s8b8qgGfYfQmYf0qg8b8kYb9o4bYj1b3X6pBz8g8f0f+0nJ3t0+3lEAAAAAABg9k7xZ7h4kU3g4mYJj3kqJj8kqJh8kKJh8kKJh8kKJh8kKJh8kKJh8kKJh8kKJh8kKJh8kKJh8kKJj+qvZl+q7f3bqf+fX9tQwAAAAAAAAAAACAh3cYJr+9y9o9g0b7yJgAAAAAAADg1l8Bf8cCq1wqv2gAAAAASUVORK5CYII=") 2 2, default;
            /* Keep system fallbacks for others until separate .cur files are available */
            --cursor-pointer: pointer;
            --cursor-text: text;

            /* Other tokens (fallback to system) */
            --cursor-move: move;
            --cursor-ew: ew-resize;
            --cursor-ns: ns-resize;
            --cursor-nesw: nesw-resize;
            --cursor-nwse: nwse-resize;
        }

        /* Baseline everywhere, including pseudo-elements and SVG */
        html, body {
            cursor: var(--cursor-default) !important;
        }
        /* inherit on everything to wipe previous component-level cursor rules */
        *, *::before, *::after, svg, svg * {
            cursor: inherit !important;
        }
        /* Ensure the canvas layer also picks up the custom cursor */
        #matrixCanvas {
            cursor: inherit !important;
        }

        /* Interactive: force hand */
        a, button, [role="button"],
        input[type="button"], input[type="submit"], input[type="reset"],
        .px-btn, .tab, .app-btn, .px-tab, .px-tab-close,
        .game-card, .wavex-logo, .secrets-btn, .favicon-option, .bgc-btn,
        #proxy-launch, #px-restart, #px-newtab, #px-fullscreen, #px-throttle, #px-privacy, #px-clear,
        .mac-item, .mac-dd-item,
        .mac-menubar .brand,
        .tips-bar .tip.active {
            cursor: var(--cursor-pointer) !important;
        }
        /* Also hand on clickable titlebar controls */
        .app-controls .app-btn {
            cursor: var(--cursor-pointer) !important;
        }

        /* Text inputs/areas and contenteditable: I‑beam */
        input[type="text"], input[type="search"], input[type="password"],
        input[type="email"], input[type="url"], input[type="tel"], input[type="number"],
        textarea, [contenteditable="true"] {
            cursor: var(--cursor-text) !important;
        }
        /* generic input/select fallback: if user hovers right on the chrome */
        input, select {
            cursor: var(--cursor-text) !important;
        }
        /* Text cursor inside app windows as well */
        .app-window input, .app-window textarea, .app-window [contenteditable="true"] {
            cursor: var(--cursor-text) !important;
        }

        /* Move/resize */
        .app-titlebar, .dragging, [aria-grabbed="true"] { cursor: var(--cursor-move) !important; }
        .app-resizer, .resize-nwse, [data-cursor="nwse"] { cursor: var(--cursor-nwse) !important; }
        .resize-nesw, [data-cursor="nesw"] { cursor: var(--cursor-nesw) !important; }
        .resize-ew,   [data-cursor="ew"]   { cursor: var(--cursor-ew) !important; }
        .resize-ns,   [data-cursor="ns"]   { cursor: var(--cursor-ns) !important; }

        /* Ensure canvases and overlays don’t force ‘auto’ */
        canvas, iframe, video, img {
            cursor: inherit !important;
        }

        /* Optional: explicit default on large areas to guarantee arrow feel */
        .content-area, .games-grid, #windows-layer, .proxy-view, body {
            cursor: var(--cursor-default) !important;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            background: #000; /* base black */
            position: relative;
            color: #0f0; /* matrix green text */
        }
        /* Scroll lock utility */
        .scroll-lock {
            overflow: hidden !important;
            height: 100vh !important;
        }

        /* Remove old gradient background layer */
        .wave-background {
            display: none;
        }

        /* Remove colorful wave backgrounds */
        .wave { display: none; }

        .wave:nth-child(2) {
            animation-delay: -5s;
            opacity: 0.8;
            animation-duration: 18s;
        }

        .wave:nth-child(3) {
            animation-delay: -10s;
            opacity: 0.6;
            animation-duration: 20s;
        }

        .wave:nth-child(4) {
            animation-delay: -15s;
            opacity: 0.4;
            animation-duration: 22s;
        }

        @keyframes waveMove {
            0% {
                transform: translateX(0) translateY(0);
            }
            25% {
                transform: translateX(-12.5%) translateY(-10px);
            }
            50% {
                transform: translateX(-25%) translateY(0);
            }
            75% {
                transform: translateX(-37.5%) translateY(10px);
            }
            100% {
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Remove floating shapes visuals */
        .floating-shapes {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .shape { display: none; }

        .shape:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .shape:nth-child(2) {
            width: 120px;
            height: 120px;
            top: 60%;
            left: 80%;
            animation-delay: -5s;
        }

        .shape:nth-child(3) {
            width: 60px;
            height: 60px;
            top: 80%;
            left: 20%;
            animation-delay: -10s;
        }

        .shape:nth-child(4) {
            width: 100px;
            height: 100px;
            top: 10%;
            left: 70%;
            animation-delay: -15s;
        }

        /* Code-typing background canvas behind content */
        #matrixCanvas {
            position: fixed;
            inset: 0;
            z-index: -2;
            background: #000;
        }

        .container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            height: auto;
            display: grid;
            grid-template-columns: 260px 1fr; /* sidebar + main */
        }

        .header {
            grid-column: 1 / -1;
            text-align: left;
            padding: 1.25rem 1.5rem;
            color: #0f0;
            border-bottom: 1px solid rgba(0,255,0,0.15);
            background: rgba(0,0,0,0.6);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #0f0;
            text-shadow: 0 0 12px rgba(0,255,0,0.35);
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.85;
            color: #8f8;
        }

        /* Sidebar */
        .tabs-container {
            grid-row: 2 / -1;
            grid-column: 1 / 2;
            display: block;
            margin: 0;
            padding: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.75), rgba(0,0,0,0.4));
            border-right: 1px solid rgba(0,255,0,0.15);
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            background: transparent;
            backdrop-filter: none;
            border-radius: 0;
            border: 0;
            box-shadow: none;
        }

        .tab {
            padding: 0.85rem 1rem;
            background: rgba(0,255,0,0.06);
            border: 1px solid rgba(0,255,0,0.18);
            color: #9f9;
            text-align: left;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            font-family: "Consolas", "Courier New", monospace;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,0,0.25), transparent);
            transition: left 0.5s;
            pointer-events: none;
        }

        .tab:hover::before {
            left: 100%;
        }
        .tab:hover {
            color: #cfffcf;
            box-shadow: 0 0 12px rgba(0,255,0,0.25);
            transform: translateX(2px);
        }
        /* Glitch text effect on hover */
        .tab {
            position: relative;
            overflow: hidden;
        }
        .tab .glitch,
        .tab .glitch::before,
        .tab .glitch::after {
            position: relative;
            display: inline-block;
            transition: transform .25s ease, text-shadow .25s ease, filter .25s ease;
        }
        .tab .glitch::before,
        .tab .glitch::after {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            clip-path: inset(0 0 0 0);
            opacity: 0;
            pointer-events: none;
        }
        .tab:hover .glitch {
            text-shadow: 0 0 8px rgba(0,255,0,0.35);
            filter: saturate(1.2);
        }
        .tab:hover .glitch::before {
            opacity: 1;
            transform: translate(-1px, -0.5px);
            color: #aaffaa;
            mix-blend-mode: screen;
        }
        .tab:hover .glitch::after {
            opacity: 1;
            transform: translate(1px, 0.5px);
            color: #66ff66;
            mix-blend-mode: screen;
        }
        /* Subtle scanline slices on hover */
        .tab:hover .glitch::before { clip-path: inset(0 0 60% 0); }
        .tab:hover .glitch::after  { clip-path: inset(40% 0 0 0); }

        .tab.active {
            background: rgba(0,255,0,0.12);
            color: #dfffdf;
            border-color: rgba(0,255,0,0.35);
            box-shadow: inset 0 0 0 1px rgba(0,255,0,0.25), 0 0 20px rgba(0,255,0,0.15);
        }

        .content-area {
            grid-column: 2 / -1;
            grid-row: 2 / -1;
            display: grid;
            grid-template-rows: 1fr;      /* single row to allow full-height content */
            place-items: stretch;         /* stretch child across */
            padding: 0;                   /* remove inner padding for full-bleed */
            overflow: visible;            /* let children manage their own scroll */
        }

        .content {
            background: transparent;
            backdrop-filter: none;
            border-radius: 0;
            padding: 0;
            text-align: left;
            color: #cfc;
            width: 100%;
            height: 100%;                 /* fill content-area */
            max-height: none;
            overflow: hidden;             /* child handles scroll if needed */
            box-shadow: none;
            border: 0;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.35s ease, transform 0.35s ease;
            margin: 0;
            display: none;                 /* hide by default */
            flex-direction: column;
            align-items: stretch;          /* stretch child width */
            justify-content: stretch;
            gap: 0;
        }

        .content.active {
            display: flex;                 /* show only the active panel */
            opacity: 1;
            transform: translateY(0);
        }
        /* Smooth cross-fade between tabs using a layer container */
        .content-area {
            position: relative;
        }
        .content {
            position: relative;
            will-change: opacity, transform;
        }

        .content h2 {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
            color: #9f9;
            text-shadow: 0 0 10px rgba(0,255,0,0.25);
        }

        .content p {
            font-size: 1rem;
            line-height: 1.6;
            opacity: 0.92;
        }

        .content-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
            filter: drop-shadow(0 0 6px rgba(0,255,0,0.35));
        }

        /* Desktop canvas area for icons (free-form) */
        .games-grid {
            position: relative;           /* absolute-positioned icons live in here */
            margin-top: 0.5rem;
            height: calc(100vh - 120px);  /* fill visible area below header */
            min-height: 360px;
            max-width: none;              /* allow full width */
            margin-left: 0;
            margin-right: 0;
            overflow: auto;               /* scroll internally if content exceeds */
            padding-bottom: 40px;         /* clear the fixed tips bar */
            outline: 1px solid rgba(0,255,0,0.08);
            background: linear-gradient(0deg, rgba(0,255,0,0.06) 1px, transparent 1px) 0 0/100% 44px,
                        linear-gradient(90deg, rgba(0,255,0,0.06) 1px, transparent 1px) 0 0/44px 100%;
            /* subtle desktop snap grid */
        }

        /* Tile: small desktop app icon with label under it (absolute for free-move) */
        .game-card {
            position: absolute;            /* free form movement */
            top: 12px; left: 12px;         /* default; will be restored from storage */
            display: grid;
            grid-template-rows: 92px auto;
            justify-items: center;
            align-items: start;
            width: 120px;
            background: transparent;
            border: 0;
            border-radius: 10px;
            overflow: visible;
            transition: transform 0.06s ease, outline 0.12s ease;
            cursor: pointer;
            padding: 6px 4px 4px;
            outline: 1px solid transparent;
            user-select: none;
            touch-action: none;            /* better pointer dragging on touch */
        }

        .game-card::before {
            /* glassy tile body (the 'app' itself) */
            content: "";
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 92px;
            height: 92px;
            border-radius: 18px;
            background:
              linear-gradient(145deg, rgba(0,255,0,0.12), rgba(0,255,0,0.04)) padding-box,
              radial-gradient(120% 120% at 20% 0%, rgba(255,255,255,0.25), rgba(255,255,255,0)) border-box;
            border: 1px solid rgba(0,255,0,0.28);
            backdrop-filter: blur(8px);
            box-shadow:
              0 2px 10px rgba(0,255,0,0.08),
              inset 0 0 0 1px rgba(0,255,0,0.12);
            z-index: 0;
        }

        .game-card:hover {
            transform: translateY(-2px) scale(1.02);
            outline-color: rgba(0,255,0,0.25);
        }
        .game-card.dragging {
            opacity: 0.9;
            transform: scale(1.03);
            filter: drop-shadow(0 6px 16px rgba(0,255,0,0.25));
            z-index: 5;
        }
        /* selection rectangle */
        .selection-box {
            position: absolute;
            border: 1px dashed rgba(0,255,0,0.35);
            background: rgba(0,255,0,0.08);
            pointer-events: none;
            z-index: 4;
        }
        .game-card.selected {
            outline: 1px solid rgba(0,255,0,0.35);
            outline-offset: 4px;
        }

        /* Context menu */
        .desktop-context {
            position: absolute;
            min-width: 180px;
            background: rgba(0, 20, 0, 0.95);
            border: 1px solid rgba(0,255,0,0.25);
            box-shadow: 0 8px 28px rgba(0,255,0,0.15);
            border-radius: 8px;
            padding: 6px 6px;
            z-index: 3000;
            display: none;
            color: #cfeccf;
            backdrop-filter: blur(8px);
        }
        .desktop-context.open { display: block; }
        .desktop-context .menu-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 12px;
            padding: 6px 8px;
            border-radius: 6px;
            color: #cfeccf;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        .desktop-context .menu-item:hover {
            background: rgba(0,255,0,0.12);
            color: #eaffea;
        }
        .desktop-context .sep {
            height: 1px;
            margin: 6px 4px;
            background: rgba(0,255,0,0.15);
            border: 0;
        }

        /* Folder appearance */
        .folder-card::before {
            background:
              linear-gradient(145deg, rgba(0,255,0,0.18), rgba(0,255,0,0.06)) padding-box,
              radial-gradient(120% 120% at 20% 0%, rgba(255,255,255,0.25), rgba(255,255,255,0)) border-box;
        }
        .folder-thumb {
            width: 72px;
            height: 72px;
            margin-top: 18px;
            border-radius: 16px;
            background:
                linear-gradient(135deg, rgba(0,255,120,0.18), rgba(0,140,60,0.12));
            display: grid;
            place-items: center;
            color: #bfffbf;
            font-family: Consolas, monospace;
            font-size: 11px;
        }

        .game-card:active {
            transform: translateY(0) scale(0.99);
            outline-color: rgba(0,255,0,0.35);
        }

        /* The "icon" area inside the tile */
        .game-thumb {
            width: 72px;
            height: 72px;
            margin-top: 18px; /* centers inside the 92px tile */
            border-radius: 16px;
            background:
                radial-gradient(ellipse at 30% 30%, rgba(0,255,0,0.28), rgba(0,0,0,0.06) 60%),
                linear-gradient(135deg, rgba(0,255,120,0.25), rgba(0,140,60,0.15));
            position: relative;
            z-index: 1;
            box-shadow:
              0 2px 8px rgba(0,255,0,0.12),
              inset 0 0 0 1px rgba(0,255,0,0.18);
        }

        /* subtle grid overlay inside the icon block */
        .game-thumb::after {
            content: "";
            position: absolute;
            inset: 0;
            background:
                linear-gradient(90deg, rgba(0,255,0,0.12) 1px, transparent 1px) 0 0/12px 100%,
                linear-gradient(0deg, rgba(0,255,0,0.08) 1px, transparent 1px) 0 0/100% 12px;
            opacity: 0.35;
            border-radius: inherit;
        }

        /* caption under the tile */
        .game-caption {
            margin-top: 8px;
            font-size: 13px;
            line-height: 1.2;
            color: #cfeccf;
            text-shadow: 0 0 6px rgba(0,255,0,0.18);
            text-align: center;
            max-width: 112px;
            word-break: break-word;
            z-index: 1;
            user-select: none;
        }

        @media (max-width: 1024px) {
            .games-grid { height: calc(100vh - 140px); }
            .game-card { width: 110px; }
            .game-card::before { width: 86px; height: 86px; }
            .game-thumb { width: 66px; height: 66px; margin-top: 16px; }
        }

        @media (max-width: 640px) {
            .games-grid { height: calc(100vh - 160px); }
            .game-card { width: 100px; }
            .game-card::before { width: 80px; height: 80px; border-radius: 16px; }
            .game-thumb { width: 60px; height: 60px; margin-top: 14px; border-radius: 14px; }
            .game-caption { font-size: 12px; max-width: 96px; }
        }


        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            transition: right 0.3s ease;
            z-index: 999;
            padding: 2rem;
            color: white;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .settings-header h2 {
            font-size: 1.5rem;
            font-weight: 300;
        }

        .close-settings {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-settings:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .favicon-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .favicon-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favicon-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .favicon-option.active {
            border-color: #ff6b9d;
            background: rgba(255, 107, 157, 0.2);
        }

        .favicon-option img {
            width: 32px;
            height: 32px;
            margin-bottom: 0.5rem;
        }

        .favicon-option span {
            font-size: 0.9rem;
            display: block;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 220px 1fr;
            }
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            .tabs-container {
                grid-column: 1 / -1;
                grid-row: 2 / 3;
                border-right: 0;
                border-bottom: 1px solid rgba(0,255,0,0.15);
            }
            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .tab {
                border-radius: 8px;
                margin: 0.25rem;
                flex: 1 1 45%;
            }
            .content-area {
                grid-column: 1 / -1;
                display: grid;
                place-items: center;  /* keep centered on small screens */
            }
            .content {
                padding: 1.25rem;
                margin: 1rem;
            }
            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
    <style>
        /* Fixed Wave-X logo bottom-left (no box, no clock) */
        .wavex-wrap {
            position: fixed;
            left: 16px;
            bottom: 16px;
            z-index: 1100;
            display: grid;
            gap: 6px;
            align-items: start;
            width: max-content;
        }
        /* Secrets eye button (above logo) */
        .secrets-btn {
            justify-self: start;
            margin-left: 2px;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(0, 20, 0, 0.6);
            color: #cfffcf;
            border: 1px solid rgba(0,255,0,0.28);
            box-shadow: 0 0 10px rgba(0,255,0,0.18);
            font-family: Consolas, monospace;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background .2s ease, border-color .2s ease, transform .1s ease;
        }
        .secrets-btn:hover {
            background: rgba(0, 35, 0, 0.7);
            border-color: rgba(0,255,0,0.4);
            box-shadow: 0 0 14px rgba(0,255,0,0.25);
        }
        .secrets-btn:active {
            transform: translateY(1px);
        }
        .secrets-btn .eye {
            filter: drop-shadow(0 0 6px rgba(0,255,0,0.35));
        }
        .wavex-logo {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0; /* remove padding box */
            background: transparent; /* remove box background */
            border: 0; /* remove border box */
            border-radius: 0;
            box-shadow: none; /* remove box shadow */
            color: #9f9;
            text-decoration: none;
            user-select: none;
            -webkit-user-drag: none;
            backdrop-filter: none;
        }
        .wavex-logo:hover {
            background: transparent;
            border-color: transparent;
            box-shadow: none;
        }
        .wavex-logo svg {
            width: 28px;
            height: 28px;
            display: block;
            filter: drop-shadow(0 0 6px rgba(0,255,0,0.35));
        }
        .wavex-logo .label {
            font-family: Consolas, monospace;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #cfffcf;
            text-shadow: 0 0 8px rgba(0,255,0,0.2);
        }
        /* removed clock styles */
        @media (max-width: 768px) {
            .wavex-wrap { left: 10px; bottom: 10px; gap: 4px; }
            .wavex-logo .label { font-size: 0.95rem; }
        }
    </style>
    <style>
        /* Proxy (Chrome OS-like) */
        .proxy-shell {
            display: flex;
            flex-direction: column;
            background: rgba(0, 20, 0, 0.45);
            border: 1px solid rgba(0,255,0,0.18);
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            width: 100%;
            height: 100%;                /* full height of content */
            margin: 0;
            align-self: stretch;
        }
        .proxy-toolbar {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(0, 35, 0, 0.75);
            border-bottom: 1px solid rgba(0,255,0,0.18);
        }
        .px-btn {
            height: 30px;
            min-width: 32px;
            padding: 0 8px;
            border-radius: 8px;
            border: 1px solid rgba(0,255,0,0.25);
            background: rgba(0,255,0,0.08);
            color: #bfffbf;
            cursor: pointer;
            font-family: Consolas, monospace;
        }
        .px-btn:hover {
            background: rgba(0,255,0,0.18);
            color: #eaffea;
            box-shadow: 0 0 10px rgba(0,255,0,0.18);
        }
        .proxy-omnibox {
            display: grid;
            grid-template-columns: 24px 1fr auto;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 15, 0, 0.9);
            border: 1px solid rgba(0,255,0,0.2);
            border-radius: 9999px;
            padding: 0 0.4rem 0 0.6rem;
            height: 34px;
            box-shadow: inset 0 0 0 1px rgba(0,255,0,0.06);
        }
        .proxy-omnibox .px-lock { opacity: 0.8; }
        #proxy-url {
            width: 100%;
            outline: none;
            border: none;
            background: transparent;
            color: #dfffd9;
            font-family: Consolas, monospace;
            font-size: 0.95rem;
        }
        .px-go {
            height: 28px;
            padding: 0 12px;
            border-radius: 9999px;
            border: 1px solid rgba(0,255,0,0.25);
            background: rgba(0,255,0,0.12);
            color: #cfc;
            cursor: pointer;
            font-weight: 700;
        }
        .px-go:hover {
            background: rgba(0,255,0,0.18);
        }
        .proxy-tabs {
            display: flex;
            gap: 6px;
            padding: 6px;
            background: rgba(0, 30, 0, 0.65);
            border-bottom: 1px solid rgba(0,255,0,0.18);
            overflow-x: auto;
            flex: 0 0 auto;               /* do not consume extra vertical space */
        }
        .px-tab {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(0,255,0,0.06);
            border: 1px solid rgba(0,255,0,0.18);
            border-radius: 8px;
            min-width: 120px;
            max-width: 240px;
            cursor: pointer;
            color: #bfffbf;
            user-select: none;
        }
        .px-tab:hover { background: rgba(0,255,0,0.12); }
        .px-tab.px-active {
            background: rgba(0,255,0,0.18);
            border-color: rgba(0,255,0,0.35);
            color: #eaffea;
        }
        .px-tab-fav { filter: drop-shadow(0 0 6px rgba(0,255,0,0.25)); }
        .px-tab-close {
            background: transparent;
            border: 0;
            color: #9f9;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .px-tab-close:hover { color: #dfffd9; }
        .proxy-view {
            flex: 1 1 auto;              /* take remaining height */
            min-height: 0;               /* allow child iframe to size correctly */
            background: #000;
            border-top: 1px solid rgba(0,255,0,0.1);
            display: grid;               /* center iframe if needed */
            place-items: stretch;        /* make iframe fill (landscape/full bleed) */
        }
        .proxy-frame {
            width: 100%;
            height: 100%;
            border: 0;
            background: #000;
            display: block;
            /* Ensure iframe takes up all available space without letterboxing */
            object-fit: fill;
        }
        @media (max-width: 768px) {
            .proxy-view { height: 100%; }
        }
    </style>
    <style>
        /* Brainrot mode styles */
        body.brainrot {
            animation: br-flicker 8s infinite linear;
        }
        @keyframes br-flicker {
            0%, 92%, 100% { filter: none; }
            93% { filter: hue-rotate(10deg) saturate(1.2); }
            94% { filter: hue-rotate(-10deg) saturate(1.2); }
            95% { filter: none; }
        }
        body.brainrot .tab,
        body.brainrot .secrets-btn,
        body.brainrot .wavex-logo,
        body.brainrot .proxy-shell,
        body.brainrot .game-card::before {
            box-shadow: 0 0 14px rgba(0,255,0,0.35), 0 0 28px rgba(0,255,0,0.15);
        }
        body.brainrot .game-caption {
            animation: br-wobble 2.2s ease-in-out infinite;
        }
        @keyframes br-wobble {
            0%,100% { transform: translateY(0) rotate(0); text-shadow: 0 0 6px rgba(0,255,0,0.25); }
            25% { transform: translateY(-1px) rotate(-0.6deg); text-shadow: 0 0 10px rgba(0,255,0,0.35); }
            50% { transform: translateY(0) rotate(0.6deg); }
            75% { transform: translateY(1px) rotate(-0.4deg); }
        }
        /* subtle chroma shift on canvas text */
        body.brainrot #matrixCanvas { opacity: 0.98; }

        /* Brainrot clouds & rain */
        .brainrot-clouds,
        .brainrot-gif {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -1; /* behind main UI but above matrix canvas (which is z-index:-2) */
        }
        .brainrot-gif {
            background: url("https://media2.giphy.com/media/v1.Y2lkPTZjMDliOTUyeGY0c254enN6M3A5aGV5b2F2bWE1a2J2aHRyb2dmc3Zwcno2cW1nYSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/Fr5LA2RCQbnVp74CxH/giphy-downsized.gif") center/cover no-repeat;
            opacity: 0;
            transition: opacity .6s ease;
            mix-blend-mode: screen;
        }
        body.brainrot .brainrot-gif { opacity: 0.22; }

        .brainrot-clouds {
            overflow: hidden;
        }
        .brainrot-clouds .cloud {
            position: absolute;
            top: -120px;
            width: 320px;
            height: 120px;
            background: radial-gradient(ellipse at 30% 50%, rgba(255,255,255,0.12), rgba(255,255,255,0) 60%),
                        radial-gradient(ellipse at 60% 50%, rgba(255,255,255,0.12), rgba(255,255,255,0) 60%);
            filter: blur(2px);
            opacity: 0.35;
            animation: cloudDrift linear infinite;
        }
        /* randomized via inline style for left/time/scale on creation */

        @keyframes cloudDrift {
            0%   { transform: translateX(-20vw); }
            100% { transform: translateX(120vw); }
        }

        .brainrot-clouds .raindrop {
            position: absolute;
            width: 22px;
            height: 22px;
            background: center/contain no-repeat url("https://upload.wikimedia.org/wikipedia/en/5/5f/Original_Doge_meme.jpg");
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.25));
            animation: dogeRain linear infinite;
            opacity: 0.92;
        }

        @keyframes dogeRain {
            0%   { transform: translateY(-10vh) rotate(0deg); }
            100% { transform: translateY(120vh) rotate(360deg); }
        }
    </style>
    <style>
        /* Tips bar fixed at bottom */
        .tips-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 34px;
            display: grid;
            place-items: center;
            background: rgba(0, 20, 0, 0.65);
            border-top: 1px solid rgba(0,255,0,0.2);
            box-shadow: 0 -6px 18px rgba(0,255,0,0.08);
            color: #cfeccf;
            font-family: Consolas, monospace;
            font-size: 13px;
            z-index: 1200;
            pointer-events: none; /* let clicks pass through by default */
        }

/* Bottom typing strip removed */
        .tips-bar .tips-track {
            display: grid;
            align-items: center;
            justify-items: center;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        .tips-bar .tip {
            grid-area: 1 / 1;
            opacity: 0;
            transform: translateY(8px) rotateX(12deg);
            transition: opacity .6s ease, transform .6s ease;
            white-space: nowrap;
            text-align: center;
            padding: 0 10px;
            color: #dfffd9;
            text-shadow: 0 0 8px rgba(0,255,0,0.2);
        }
        .tips-bar .tip.active {
            opacity: 1;
            transform: translateY(0) rotateX(0);
        }
        /* progress bar animation helper (width is updated via JS) */
        .tips-bar #tipsProgressBar {
            transition: width linear;
        }
        /* ensure main desktop grid doesn't hide behind bar */
        .games-grid { height: calc(100vh - 120px - 34px); }
        @media (max-width: 1024px) {
            .games-grid { height: calc(100vh - 140px - 34px); }
        }
        @media (max-width: 640px) {
            .games-grid { height: calc(100vh - 160px - 34px); }
        }
    </style>
    <style>
        /* macOS-style top menu bar */
        .mac-menubar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 28px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 8px;
            padding: 0 10px;
            background: rgba(0, 15, 0, 0.85);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(0,255,0,0.18);
            color: #cfeccf;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Consolas", monospace;
            z-index: 1500;
            user-select: none;
        }
        /* topbar extensions pill area */
        .mac-left .ext-pills {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 6px;
            overflow: hidden;
            max-width: 50vw;
        }
        .ext-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(0,255,0,0.10);
            border: 1px solid rgba(0,255,0,0.25);
            color: #eaffea;
            font-size: 12px;
            cursor: default;
            white-space: nowrap;
        }
        .ext-pill .spin {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(0,255,0,0.25);
            border-top-color: rgba(0,255,0,0.9);
            border-radius: 50%;
            animation: extSpin 0.9s linear infinite;
            display: inline-block;
        }
        @keyframes extSpin { to { transform: rotate(360deg); } }
        .mac-left, .mac-center, .mac-right {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .mac-left .brand {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 6px;
            border-radius: 6px;
            color: #eaffea;
            text-shadow: 0 0 8px rgba(0,255,0,0.25);
            cursor: default;
        }
        .mac-left .brand svg {
            width: 16px;
            height: 16px;
            filter: drop-shadow(0 0 4px rgba(0,255,0,0.35));
        }
        .mac-menu {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            flex-wrap: nowrap;
        }
        .mac-item {
            font-size: 13px;
            color: #cfeccf;
            padding: 2px 6px;
            border-radius: 6px;
            cursor: default;
            white-space: nowrap;
            border: 1px solid transparent;
            position: relative;
        }
        .mac-item:hover {
            background: rgba(0,255,0,0.12);
            border-color: rgba(0,255,0,0.18);
            color: #eaffea;
        }
        .mac-item.active {
            background: rgba(0,255,0,0.18);
            border-color: rgba(0,255,0,0.35);
            color: #eaffea;
        }
        /* dropdowns */
        .mac-dropdown {
            position: absolute;
            top: 24px;
            left: 0;
            min-width: 180px;
            background: rgba(0, 20, 0, 0.95);
            border: 1px solid rgba(0,255,0,0.25);
            box-shadow: 0 8px 28px rgba(0,255,0,0.15);
            border-radius: 8px;
            padding: 6px 6px;
            display: none;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }
        .mac-dropdown.open { display: block; }
        .mac-dd-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 12px;
            padding: 6px 8px;
            border-radius: 6px;
            color: #cfeccf;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        .mac-dd-item:hover {
            background: rgba(0,255,0,0.12);
            color: #eaffea;
        }
        .mac-dd-item .kbd {
            opacity: 0.7;
            font-family: Consolas, monospace;
            font-size: 11px;
        }
        .mac-dd-sep {
            height: 1px;
            margin: 6px 4px;
            background: rgba(0,255,0,0.15);
            border: 0;
        }
        .mac-center {
            justify-content: center;
            font-size: 13px;
            opacity: 0.9;
        }
        .mac-right {
            justify-content: flex-end;
            gap: 12px;
        }
        .mac-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #dfffd9;
            text-shadow: 0 0 6px rgba(0,255,0,0.2);
        }
        .mac-status .icon {
            opacity: 0.9;
            filter: drop-shadow(0 0 4px rgba(0,255,0,0.25));
        }
        /* push layout down so it doesn't hide under the menubar */
        body { padding-top: 28px; }
        /* Adjust header top border to start below menubar if needed */
        .header { margin-top: 0; }
        /* Ensure bottom tips bar still visible with menubar present (no change needed) */
    </style>
    <style>
        /* Terminal screen styling tweaks */
        #term-screen .line { white-space: pre-wrap; }
        #term-screen .ok { color:#9f9; }
        #term-screen .err { color:#ff6b6b; }
        #term-screen .muted { color:#8f8; opacity:.8 }
        #term-screen .dir { color:#7fffb4; }
        #term-screen .exe { color:#bfffbf; }
        #term-screen .file { color:#cfe; }
        #term-screen .pkg { color:#aef; }
        #term-screen .sudo { color:#fffa9e; }
        #term-screen .nano { color:#cff; }
        #term-screen .cmeme { color:#ff9ef0; }
    </style>
  </head>
  <body>
    <!-- macOS-style menu bar -->
    <div class="mac-menubar" role="menubar" aria-label="Wave‑X Menu Bar" id="mac-menubar">
        <div class="mac-left">
            <div class="brand" title="Wave‑X">
                <strong>Wave‑X</strong>
            </div>
            <nav class="mac-menu" id="mac-menu">
                <span class="mac-item active" data-menu="extensions">Extensions</span>
            </nav>
            <!-- Installed extensions appear here as pills -->
            <div class="ext-pills" id="ext-pills" aria-label="Installed Extensions"></div>
        </div>
        <div class="mac-center" id="mac-window-title">Desktop</div>
        <div class="mac-right">
            <div class="mac-status">
                <span class="icon" title="Wi‑Fi">📶</span>
                <span class="icon" title="Battery">🔋</span>
                <span class="icon" title="Sound">🔊</span>
                <span id="mac-clock">--:--</span>
            </div>
        </div>
    </div>
    <!-- Tips Bar -->
    <div class="tips-bar" aria-live="polite">
        <div class="tips-track" id="tipsTrack">
            <div class="tip active">the low taper fade meme is still massive</div>
            <div class="tip">Blob-HTML is Tuff</div>
            <div class="tip">click on the secrets button</div>
            <div class="tip">BerryGoodScripting is TUFFFFF</div>
            <div class="tip">wave-x is tuff</div>
            <div class="tip">[INSERT TIP HERE]</div>
            <div class="tip">We are better then yandex</div>
            <div class="tip">hehe</div>
            <div class="tip">who reads these</div>
            <div class="tip">why no music player work :(</div>
        </div>
        <div id="tipsProgress" style="position:absolute;left:8px;right:8px;bottom:5px;height:3px;background:rgba(0,255,0,0.12);border-radius:999px;overflow:hidden;pointer-events:none">
            <div id="tipsProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg, rgba(0,255,120,0.9), rgba(0,180,80,0.9));box-shadow:0 0 8px rgba(0,255,0,0.35);border-radius:999px"></div>
        </div>
    </div>
    <!-- Intro Splash -->
    <style>
        #intro {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 2000;
            overflow: hidden;
        }
        #intro.hidden { display: none; }

        /* Securely blocked "photo" placeholder → White screen with gnome biting a cord */
        .intro-image {
            position: absolute;
            inset: 0;
            /* Keep the Securly image fullscreen the entire intro */
            background:
                url("https://support.securly.com/hc/article_attachments/14982802268951") center/cover no-repeat, #000;
            display: block;
            filter: none;
        }
        /* Remove old centered gnome placeholder element */
        .intro-image::after { content: none; }

        /* Scanning bar */
        .intro-scan {
            position: absolute;
            left: 0;
            right: 0;
            top: -40%;
            height: 40%;
            background: linear-gradient(180deg,
                rgba(0,255,0,0) 0%,
                rgba(0,255,0,0.12) 45%,
                rgba(0,255,0,0.22) 50%,
                rgba(0,255,0,0.12) 55%,
                rgba(0,255,0,0) 100%
            );
            filter: blur(1px);
            animation: introScan 1.4s ease-in-out 0.1s forwards;
        }
        @keyframes introScan {
            0% { top: -40%; }
            100% { top: 100%; }
        }

        /* Crack lines made of green code columns */
        /* Bidirectional sweep cracks: columns animate L->R then R->L */
        .intro-cracks {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: grid;
            grid-template-columns: repeat(32, 1fr);
            opacity: 0;
            animation: cracksIn 0.35s ease forwards 0.35s; /* appear much earlier */
        }
        @keyframes cracksIn { to { opacity: 1; } }

        .intro-cracks .col {
            position: relative;
            overflow: hidden;
            mix-blend-mode: screen;
        }
        .intro-cracks .col::before,
        .intro-cracks .col::after {
            content: attr(data-code);
            position: absolute;
            top: -120%;
            left: 50%;
            transform: translateX(-50%) rotate(90deg);
            white-space: pre;
            color: #0f0;
            text-shadow: 0 0 8px rgba(0,255,0,0.35);
            font: 12px/14px Consolas, monospace;
            opacity: 0.95;
        }
        /* left-to-right pass */
        .intro-cracks.ltr .col::before {
            animation: codeDrop var(--spdA, 1.3s) linear var(--delayA, 0s) forwards;
        }
        /* right-to-left pass (staggered later) */
        .intro-cracks.rtl .col::after {
            animation: codeDrop var(--spdB, 1.1s) linear var(--delayB, 0s) forwards;
        }
        @keyframes codeDrop { to { top: 120%; } }

        /* Shake and crack effect on the blocked page when code breaks through */
        .intro-image.shake {
            animation: introShake 0.2s ease-in-out 8 alternate;
            filter: none;
        }
        @keyframes introShake {
            0%   { transform: translate(0, 0) rotate(0deg); }
            25%  { transform: translate(2px, -2px) rotate(-0.2deg); }
            50%  { transform: translate(-2px, 2px) rotate(0.2deg); }
            75%  { transform: translate(3px, 1px) rotate(-0.3deg); }
            100% { transform: translate(-3px, -1px) rotate(0.3deg); }
        }

        /* Full image break: top-to-bottom fragmentation (no faded background left) */
        .intro-split {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 3;
        }
        .intro-split .half {
            position: absolute;
            inset: 0;
            background: url("https://support.securly.com/hc/article_attachments/14982802268951") center/cover no-repeat #000;
            will-change: clip-path, transform, opacity, filter;
        }
        .intro-split .top { clip-path: inset(0 0 50% 0); transform-origin: bottom center; }
        .intro-split .bottom { clip-path: inset(50% 0 0 0); transform-origin: top center; }

        /* Top-to-bottom shatter with vertical pull apart and slight rotation */
        .intro-split.split .top {
            animation: splitTop 0.7s cubic-bezier(.2,.7,.2,1) forwards;
        }
        .intro-split.split .bottom {
            animation: splitBottom 0.7s cubic-bezier(.2,.7,.2,1) forwards;
        }
        @keyframes splitTop {
            0%   { transform: translateY(0) rotate(0deg); filter: none; }
            50%  { transform: translateY(-10vh) rotate(-1.2deg); filter: brightness(1.1); }
            100% { transform: translateY(-22vh) rotate(-2deg); filter: brightness(0.9); }
        }
        @keyframes splitBottom {
            0%   { transform: translateY(0) rotate(0deg); filter: none; }
            50%  { transform: translateY(10vh) rotate(1.2deg); filter: brightness(1.1); }
            100% { transform: translateY(22vh) rotate(2deg); filter: brightness(0.9); }
        }

        /* Multi horizontal fracture lines that expand top->bottom */
        .intro-split::before,
        .intro-split::after {
            content: "";
            position: absolute;
            left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0,255,0,0.7), transparent);
            box-shadow: 0 0 12px rgba(0,255,0,0.6);
            opacity: 0;
        }
        .intro-split.split::before { top: 35%; animation: crackFlash 0.5s ease forwards; }
        .intro-split.split::after  { top: 65%; animation: crackFlash 0.5s ease 0.1s forwards; }
        @keyframes crackFlash { 0%{opacity:0} 25%{opacity:1} 100%{opacity:.55} }

        /* Mask revealing from left as if code is breaking through the left edge */
        .intro-image.crack-left::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background:
                linear-gradient(90deg, rgba(0,255,0,0.25) 0%, rgba(0,255,0,0.12) 30%, rgba(255,255,255,0) 100%);
            box-shadow: 8px 0 24px rgba(0,255,0,0.25);
            filter: blur(0.3px);
            animation: crackReveal 1.4s ease-out forwards;
        }
        @keyframes crackReveal {
            0%   { width: 0%; }
            40%  { width: 18%; }
            70%  { width: 32%; }
            100% { width: 48%; }
        }

        /* Subtle fracturing lines overlay on the white screen */
        .intro-image.cracked::after {
            /* fracture lines only; no gnome overlay */
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background:
                repeating-linear-gradient(120deg, rgba(0,255,0,0) 0 18px, rgba(0,255,0,0.08) 19px, rgba(0,255,0,0) 20px),
                repeating-linear-gradient(75deg, rgba(0,255,0,0) 0 22px, rgba(0,255,0,0.06) 23px, rgba(0,255,0,0) 24px);
            mix-blend-mode: screen;
        }

        /* Matrix veil for transition out */
        .intro-matrix {
            position: absolute;
            inset: 0;
            background:
                linear-gradient(90deg, rgba(0,255,0,0.08) 1px, transparent 1px) 0 0/20px 100%,
                linear-gradient(0deg, rgba(0,255,0,0.06) 1px, transparent 1px) 0 0/100% 20px,
                rgba(0,0,0,0.25);
            opacity: 0;
            animation: veilIn 0.5s ease 2.2s forwards, veilOut 0.6s ease 3.4s forwards;
        }
        @keyframes veilIn { to { opacity: 1; } }
        @keyframes veilOut { to { opacity: 0; } }

        /* Fade whole intro out */
        .intro-out {
            animation: introOut 0.6s ease forwards;
        }
        @keyframes introOut {
            to { opacity: 0; visibility: hidden; }
        }

        /* Welcome message that appears after image breaks */
        .welcome-banner {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            z-index: 4; /* above split halves (z:3) and matrix veil */
            pointer-events: none;
            opacity: 0;
        }
        .welcome-banner .text {
            font: 700 48px/1 Consolas, 'Courier New', monospace;
            color: #cfffcf;
            text-shadow: 0 0 16px rgba(0,255,0,0.35), 0 0 32px rgba(0,255,0,0.2);
            letter-spacing: 1px;
            opacity: 0;
            transform: translateY(8px);
        }
        /* active state triggers fade-in-out */
        .welcome-banner.show .text {
            animation: welcomeFade 2.2s ease forwards;
            animation-delay: 0s;
        }
        .welcome-banner.show { opacity: 1; }
        @keyframes welcomeFade {
            0%   { opacity: 1; transform: translateY(8px); }
            60%  { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-6px); }
        }

        /* Prevent body scroll while intro active */
        body.intro-lock {
            overflow: hidden !important;
            height: 100vh !important;
        }
    </style>
    <div id="intro" aria-hidden="true">
        <div class="intro-image"></div>
        <div class="intro-scan"></div>
        <div class="intro-cracks" id="introCracks"></div>

        <!-- Full break overlay -->
        <div class="intro-split" id="introSplit" aria-hidden="true">
            <div class="half top"></div>
            <div class="half bottom"></div>
        </div>

        <!-- Welcome text shown after the image breaks -->
        <div class="welcome-banner" id="welcomeBanner" aria-live="polite" aria-atomic="true">
            <div class="text">Welcome!</div>
        </div>

        <div class="intro-matrix"></div>
    </div>

    <!-- Matrix background canvas -->
    <canvas id="matrixCanvas"></canvas>
<!-- Bottom typing strip removed -->
    <!-- Brainrot overlays (added/used when brainrot on) -->
    <div class="brainrot-gif" id="brainrotGif" aria-hidden="true"></div>
    <div class="brainrot-clouds" id="brainrotClouds" aria-hidden="true"></div>

    <!-- Fixed Wave-X Logo (bottom-left) -->
    <div class="wavex-wrap">
        <div class="wavex-logo" aria-label="Wave-X watermark" title="Wave‑X" style="cursor:default">
            <span class="label">WAVE‑X</span>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-settings" onclick="toggleSettings()">×</button>
        </div>
        
        <div class="settings-section">
            <h3>Favicon Theme</h3>
            <div class="favicon-options">
                <div class="favicon-option active" onclick="changeFavicon('default')">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ff6b9d' d='M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z'/%3E%3C/svg%3E" alt="Default">
                    <span>Default</span>
                </div>
                <div class="favicon-option" onclick="changeFavicon('math')">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ff6b9d' d='M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M13,7H15V9H17V11H15V13H13V11H11V9H13V7M7,7H9V9H11V11H9V13H7V11H5V9H7V7M7,15H17V17H7V15Z'/%3E%3C/svg%3E" alt="Math">
                    <span>Math</span>
                </div>
                <div class="favicon-option" onclick="changeFavicon('science')">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ff6b9d' d='M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z'/%3E%3C/svg%3E" alt="Science">
                    <span>Science</span>
                </div>
                <div class="favicon-option" onclick="changeFavicon('history')">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ff6b9d' d='M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z'/%3E%3C/svg%3E" alt="History">
                    <span>History</span>
                </div>
                <div class="favicon-option" onclick="changeFavicon('literature')">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ff6b9d' d='M19,2L14,6.5V17.5L19,13V2M6.5,5C4.55,5 2.45,5.4 1,6.5V21.16C1,21.41 1.25,21.66 1.5,21.66C1.6,21.66 1.65,21.59 1.75,21.59C3.1,20.94 5.05,20.5 6.5,20.5C8.45,20.5 10.55,20.9 12,22C13.35,21.15 15.8,20.5 17.5,20.5C19.15,20.5 20.85,20.81 22.25,21.56C22.35,21.61 22.4,21.59 22.5,21.59C22.75,21.59 23,21.34 23,21.09V6.5C22.4,6.05 21.75,5.75 21,5.5V19C19.9,18.5 18.7,18.5 17.5,18.5C15.8,18.5 13.35,19.15 12,20V6.5C10.55,5.4 8.45,5 6.5,5Z'/%3E%3C/svg%3E" alt="Literature">
                    <span>Literature</span>
                </div>
                <div class="favicon-option" onclick="changeFavicon('art')">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ff6b9d' d='M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z'/%3E%3C/svg%3E" alt="Art">
                    <span>Art</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1></h1>
            <p></p>
        </div>

<div class="tabs-container">
<div class="tabs" id="main-tabs">
                <button class="tab active" data-tab="games" aria-controls="games" aria-selected="true" role="tab">
                    🎮 Games
                </button>
                <button class="tab" data-tab="wave-proxy" aria-controls="wave-proxy" aria-selected="false" role="tab">
                    🌊 Proxy
                </button>
                <button class="tab" data-tab="customization" title="Customization" aria-controls="customization" aria-selected="false" role="tab">
                    🔨 Tools
                </button>
                <button class="tab" data-tab="ai" title="AI Assistant" aria-controls="ai" aria-selected="false" role="tab">
                    🤖 Wave-X AI
                </button>
                <button class="tab" data-tab="terminal" title="Terminal" aria-controls="terminal" aria-selected="false" role="tab">
                    💻 Terminal
                </button>
                <button class="tab" data-tab="changes" title="Recent Changes" aria-controls="changes" aria-selected="false" role="tab">
                    📝 Changes
                </button>
            </div>
        </div>

<div class="content-area" role="region" aria-live="polite">
<div class="content" id="changes" role="tabpanel" aria-labelledby="tab-changes" style="display:none;flex-direction:column;gap:0;min-height:0">
                <!-- Changes header with Report Bug -->
                <div style="padding:10px 12px;border-bottom:1px solid rgba(0,255,0,0.18);background:linear-gradient(180deg, rgba(0,35,0,0.65), rgba(0,20,0,0.5));display:flex;align-items:center;gap:10px">
                    <div style="display:inline-flex;align-items:center;gap:10px">
                        <span class="content-icon" aria-hidden="true">📝</span>
                        <h2 style="margin:0;font-size:1.2rem;letter-spacing:.3px">Recent Changes</h2>
                    </div>
                    <button id="changes-report-bug" class="px-btn" style="margin-left:auto;height:30px;padding:0 12px;font-weight:700" title="Report a bug">Report a bug</button>
                </div>

                <!-- AI-human-like changelog feed -->
                <div id="changes-feed" style="padding:14px;overflow:auto;display:grid;gap:14px;background:
                        radial-gradient(1000px 400px at 20% 0%, rgba(0,255,0,0.05), transparent),
                        rgba(0,0,0,0.20)">
                    <!-- Entries are rendered by JS below -->
                </div>
            </div>
<div class="content active" id="games">
                <!-- Games controls (visible only in Games tab) -->
                <div id="games-controls" style="margin:6px 0 6px 0; padding-left:2px; display:flex; gap:8px; flex-wrap:wrap">
                    <button id="games-sort-alpha" class="px-btn" title="Sort games A→Z" style="height:28px;padding:0 10px">Sort A→Z</button>
                    <button id="games-reset-layout" class="px-btn" title="Reset layout to neat rows" style="height:28px;padding:0 10px">Reset Layout</button>
                </div>
                <!-- Games Grid -->
<div class="games-grid" id="games-grid">
                    <!-- New requested game cards -->
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/racesurvival.html" data-title="Race Survival" data-image="https://read.ebookswest.com.au/images/games/racesurvival.jpg">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/racesurvival.jpg'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Race Survival</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/ragdollarchers.html" data-title="Ragdoll Archers" data-image="https://read.ebookswest.com.au/images/games/ragdollarchers-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/ragdollarchers-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Ragdoll Archers</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/stickmanhook.html" data-title="Stickman Hook" data-image="https://read.ebookswest.com.au/images/games/stickmanhook.jpg">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/stickmanhook.jpg'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Stickman Hook</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/deadlydecent.html" data-title="Deadly Decent" data-image="https://read.ebookswest.com.au/images/games/deadlydecent-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/deadlydecent-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Deadly Decent</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/drifthunters.html" data-title="Drift Hunters" data-image="https://read.ebookswest.com.au/images/games/drifhunters-min.jpg">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/drifhunters-min.jpg'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Drift Hunters</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/blockblast.html" data-title="Block Blast" data-image="https://read.ebookswest.com.au/images/games/blockblast-min.jpg">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/blockblast-min.jpg'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Block Blast</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/capybaraclicker.html" data-title="Capybara Clicker" data-image="https://read.ebookswest.com.au/images/games/capybaraclicker-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/capybaraclicker-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Capybara Clicker</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/1v1lol.html" data-title="1v1.lol" data-image="https://read.ebookswest.com.au/images/games/1v1lol-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/1v1lol-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">1v1.lol</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/adanceoffireandice.html" data-title="A Dance of Fire and Ice" data-image="https://read.ebookswest.com.au/images/games/a-dance-of-fire-and-ice-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/a-dance-of-fire-and-ice-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">A Dance of Fire and Ice</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/arcadecardrift.html" data-title="Arcade Car Drift" data-image="https://read.ebookswest.com.au/images/games/arcadecardrift-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/arcadecardrift-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Arcade Car Drift</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/backrooms.html" data-title="Backrooms" data-image="https://read.ebookswest.com.au/images/games/backrooms-min.jpg">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/backrooms-min.jpg'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Backrooms</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/baldis.html" data-title="Baldi's Basics" data-image="https://read.ebookswest.com.au/images/games/baldisbasics-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/baldisbasics-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Baldi's Basics</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/basketrandom.html" data-title="Basket Random" data-image="https://read.ebookswest.com.au/images/games/basketrandom-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/basketrandom-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Basket Random</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/bikeobby.html" data-title="Bike Obby" data-image="https://tr.rbxcdn.com/180DAY-0aee4808db5c1ebae4fa0c0edae0d78c/768/432/Image/Webp/noFilter">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://tr.rbxcdn.com/180DAY-0aee4808db5c1ebae4fa0c0edae0d78c/768/432/Image/Webp/noFilter'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Bike Obby</div>
                    </div>
                    <div class="game-card" data-url="https://read.ebookswest.com.au/assets/mainstorage/boxingrandom.html" data-title="Boxing Random" data-image="https://read.ebookswest.com.au/images/games/boxingrandom-min.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://read.ebookswest.com.au/images/games/boxingrandom-min.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Boxing Random</div>
                    </div>

                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/slope/index.html" data-title="Slope.io" data-image="https://storage.classroomsarecool.mex.com/images/slope.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/slope.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Slope.io</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/geometrydash/index.html" data-title="Geometry Dash Lite" data-image="https://storage.classroomsarecool.mex.com/images/geometrydashlite.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/geometrydashlite.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Geometry Dash Lite</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/gunspin/index.html" data-title="Gunspin" data-image="https://storage.classroomsarecool.mex.com/images/gunspin.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/gunspin.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Gunspin</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/tombofthemask.html" data-title="Tomb of the Mask" data-image="https://storage.classroomsarecool.mex.com/images/tombofthemask.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/tombofthemask.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Tomb of the Mask</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/sm64/index.html" data-title="Super Mario 64" data-image="https://storage.classroomsarecool.mex.com/images/supermario64.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/supermario64.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Super Mario 64</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/Moto-X3M/index.html" data-title="Moto X3M" data-image="https://storage.classroomsarecool.mex.com/images/motox3m.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/motox3m.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Moto X3M</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/eggy-car/index.html" data-title="Eggy Car" data-image="https://storage.classroomsarecool.mex.com/images/eggycar.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/eggycar.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Eggy Car</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/snowrider3d/index.html" data-title="Snow Rider 3D" data-image="https://storage.classroomsarecool.mex.com/images/snowrider3d.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/snowrider3d.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Snow Rider 3D</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/crossyroad/index.html" data-title="Crossy Road" data-image="https://storage.classroomsarecool.mex.com/images/crossyroad.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/crossyroad.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Crossy Road</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/pacman/index.html" data-title="Pac-Man" data-image="https://storage.classroomsarecool.mex.com/images/pacman.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/pacman.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Pac-Man</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/elasticface/index.html" data-title="Elastic Face" data-image="https://storage.classroomsarecool.mex.com/images/elasticface.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/elasticface.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Elastic Face</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/subwaysurfers-sf/index.html" data-title="Subway Surfers" data-image="https://storage.classroomsarecool.mex.com/images/subwaysurfers.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/subwaysurfers.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Subway Surfers</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/basketball-stars/index.html" data-title="Basketball Stars" data-image="https://storage.classroomsarecool.mex.com/images/basketballstars.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/basketballstars.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Basketball Stars</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/crazy-cars/index.html" data-title="Crazy Cars" data-image="https://storage.classroomsarecool.mex.com/images/crazycars.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/crazycars.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Crazy Cars</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/paperio2/index.html" data-title="Paper.io 2" data-image="https://storage.classroomsarecool.mex.com/images/paperio2.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/paperio2.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Paper.io 2</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/minecraftparkour/index.html" data-title="Minecraft Parkour" data-image="https://storage.classroomsarecool.mex.com/images/minecraftparkour.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/minecraftparkour.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Minecraft Parkour</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/death-run-3d/index.html" data-title="Death Run 3D" data-image="https://storage.classroomsarecool.mex.com/images/deathrun3d.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/deathrun3d.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Death Run 3D</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/highwayriderextreme.html" data-title="Highway Rider Extreme" data-image="https://storage.classroomsarecool.mex.com/images/highwayriderextreme.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/highwayriderextreme.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Highway Rider Extreme</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/stackball/index.html" data-title="Stackball" data-image="https://storage.classroomsarecool.mex.com/images/stackball.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/stackball.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Stackball</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/skibidi-strike/index.html" data-title="Skibidi Strike" data-image="https://storage.classroomsarecool.mex.com/images/skibidistrike.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/skibidistrike.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Skibidi Strike</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/scrapmetal/index.html" data-title="Scrap Metal 3" data-image="">
                        <div class="game-thumb" aria-hidden="true"></div>
                        <div class="game-caption">Scrap Metal 3</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/slow-roads/index.html" data-title="Slow Roads" data-image="https://storage.classroomsarecool.mex.com/images/slowroads.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/slowroads.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Slow Roads</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/jetpack-joyride/index.html" data-title="Jetpack Joyride" data-image="https://storage.classroomsarecool.mex.com/images/jetpackjoyride.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/jetpackjoyride.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Jetpack Joyride</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/gswitch-3/index.html" data-title="G-Switch 3" data-image="https://storage.classroomsarecool.mex.com/images/gswitch3.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/gswitch3.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">G-Switch 3</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/googlesnake.html" data-title="Google Snake" data-image="https://storage.classroomsarecool.mex.com/images/googlesnake.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/googlesnake.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Google Snake</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/fruitninja/index.html" data-title="Fruit Ninja" data-image="https://storage.classroomsarecool.mex.com/images/fruitninja.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/fruitninja.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Fruit Ninja</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/cuttherope-Timetravel/index.html" data-title="Cut the Rope: Time Travel" data-image="https://storage.classroomsarecool.mex.com/images/cuttherope.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/cuttherope.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Cut the Rope: Time Travel</div>
                    </div>
                    <div class="game-card" data-url="https://storage.classroomsarecool.mex.com/clusterrush/index.html" data-title="Cluster Rush" data-image="https://storage.classroomsarecool.mex.com/images/clusterrush.png">
                        <div class="game-thumb" aria-hidden="true" style="background: center/cover no-repeat url('https://storage.classroomsarecool.mex.com/images/clusterrush.png'); border-radius:16px; overflow:hidden;"></div>
                        <div class="game-caption">Cluster Rush</div>
                    </div>
                </div>
            </div>

    <!-- App Windows Layer -->
    <div id="windows-layer" aria-live="polite"></div>


<div class="content" id="customization">
                <!-- Customization apps -->
                <div class="games-grid" id="customization-grid">
                    <!-- Toggle Brainrot -->
                    <div class="game-card tool-brainrot" data-title="Toggle Brainrot">
                        <div class="game-thumb" aria-hidden="true">
                            <div class="avatar" style="position:absolute;inset:0;display:grid;place-items:center;">
                                <svg viewBox="0 0 64 64" width="44" height="44" aria-hidden="true">
                                    <defs>
                                        <linearGradient id="grad-br" x1="0" y1="0" x2="1" y2="1">
                                            <stop offset="0%" stop-color="#bbffbb"/>
                                            <stop offset="100%" stop-color="#33dd77"/>
                                        </linearGradient>
                                    </defs>
                                    <circle cx="32" cy="32" r="30" fill="url(#grad-br)"/>
                                    <text x="50%" y="54%" text-anchor="middle" font-family="Consolas, monospace" font-size="10" fill="#001b00" font-weight="700">ROT</text>
                                </svg>
                            </div>
                        </div>
                        <div class="game-caption">Toggle Brainrot</div>
                    </div>

                    
                </div>
            </div>


<div class="content" id="wave-proxy" style="padding:0;margin:0;display:grid;grid-template-rows:auto 1fr;gap:10px;place-items:stretch;position:relative;flex:1 1 auto;min-height:0;background:radial-gradient(1200px 600px at 50% 50%, rgba(0,255,0,0.06), rgba(0,0,0,0))">
                <!-- Launch + Controls toolbar -->
                <div id="proxy-controls" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;padding:10px;border-bottom:1px solid rgba(0,255,0,0.18);background:linear-gradient(180deg, rgba(0,35,0,0.55), rgba(0,20,0,0.35));position:sticky;top:0;z-index:2">
                    <button id="proxy-launch" class="proxy-launch-btn px-btn" type="button" title="Open Wave‑X Proxy Window" style="height:auto;display:inline-grid;grid-auto-flow:column;align-items:center;gap:10px;padding:12px 18px;font-size:16px;font-weight:800;border-radius:10px;">
                        <span style="filter:drop-shadow(0 0 8px rgba(0,255,0,0.45))">🌊</span>
                        <span>Launch Wave‑X</span>
                    </button>
                    <button id="px-restart" class="px-btn" title="Restart current proxy window">Restart</button>
                    <button id="px-newtab" class="px-btn" title="Open a new tab inside proxy">New Tab</button>
                    <button id="px-fullscreen" class="px-btn" title="Pop into windowed fullscreen">Fullscreen</button>
                    <span style="width:1px;height:20px;background:rgba(0,255,0,0.2)"></span>
                    <button id="px-throttle" class="px-btn" title="Toggle slow network emulation">Throttle: Off</button>
                    <button id="px-privacy" class="px-btn" title="Quick privacy mode (clear + blank)">Privacy Mode</button>
                    <button id="px-clear" class="px-btn" title="Clear proxy cache/history (local)">Clear Cache</button>
                </div>

                <!-- Hidden reveal container kept for future effects -->
                <div id="proxy-reveal" style="position:relative;inset:auto;display:grid;place-items:stretch;pointer-events:auto;opacity:1;transform:none;filter:none;min-height:0;">
                    <div id="proxy-welcome" style="position:absolute;inset:auto 0 0 0;display:none;place-items:center;font:700 36px/1 Consolas,monospace;color:#cfffcf;text-shadow:0 0 16px rgba(0,255,0,0.35);opacity:0;pointer-events:none;">Welcome to Wave‑X</div>
                </div>
            </div>

            <!-- Terminal Tab -->
            <div class="content" id="terminal" style="padding:0;margin:0;display:flex;flex-direction:column;gap:0;min-height:0">
                <div style="padding:10px 12px;border-bottom:1px solid rgba(0,255,0,0.18);background:linear-gradient(180deg, rgba(0,35,0,0.65), rgba(0,20,0,0.5));display:flex;align-items:center;gap:10px">
                    <div style="display:inline-flex;align-items:center;gap:10px">
                        <span class="content-icon" aria-hidden="true">💻</span>
                        <h2 style="margin:0;font-size:1.2rem;letter-spacing:.3px">Wave‑X Terminal</h2>
                    </div>
                    <span id="term-status" style="margin-left:auto;font-size:12px;color:#9f9;opacity:0.85"></span>
                </div>
                <div style="display:grid;grid-template-rows:1fr auto;min-height:0;flex:1 1 auto">
                    <div id="term-screen" style="font-family:Consolas,monospace;background:#000;color:#cfe;border-top:0; padding:12px; overflow:auto; min-height:0; white-space:pre-wrap; outline:1px solid rgba(0,255,0,0.18)"></div>
                    <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;padding:8px 12px;border-top:1px solid rgba(0,255,0,0.18);background:rgba(0,20,0,0.65)">
                        <div id="term-prompt" style="font-family:Consolas,monospace;color:#9f9;align-self:center">$</div>
                        <input id="term-input" spellcheck="false" autocomplete="off" placeholder="type a command and press Enter" style="height:34px;background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:8px;padding:0 10px;font-family:Consolas,monospace"/>
                    </div>
                </div>
            </div>

            <!-- AI Assistant Tab (Wave‑X branded) -->
            <div class="content" id="ai" style="padding:0;margin:0;display:flex;flex-direction:column;gap:0;min-height:0">
                <!-- Header -->
                <div style="padding:10px 12px;border-bottom:1px solid rgba(0,255,0,0.18);background:linear-gradient(180deg, rgba(0,35,0,0.65), rgba(0,20,0,0.5));display:flex;align-items:center;gap:10px">
                    <div style="display:inline-flex;align-items:center;gap:10px">
                        <span class="content-icon" aria-hidden="true">🤖</span>
                        <h2 style="margin:0;font-size:1.2rem;letter-spacing:.3px">Wave‑X AI</h2>
                        
                    </div>
                    <span id="ai-status" style="margin-left:auto;font-size:12px;color:#9f9;opacity:0.85"></span>
                </div>

                <!-- Body -->
                <div style="display:grid;grid-template-rows:auto 1fr auto;flex:1 1 auto;min-height:0">
                    <!-- Wave‑X AI toolbar (minimal) -->
                    <div style="display:flex;gap:10px;align-items:center;padding:8px 12px;background:rgba(0,25,0,0.45);border-bottom:1px solid rgba(0,255,0,0.1)">
                        <div style="font-family:Consolas,monospace;color:#cfc;opacity:.85">Wave‑X AI</div>
                        <div style="margin-left:auto"></div>
                    </div>

                    <!-- Chat area -->
                    <div id="ai-chat" style="padding:14px;overflow:auto;display:grid;gap:10px;background:
                        radial-gradient(1000px 400px at 20% 0%, rgba(0,255,0,0.05), transparent),
                        rgba(0,0,0,0.20)"></div>

                    <!-- Composer -->
                    <form id="ai-form" style="display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border-top:1px solid rgba(0,255,0,0.18);background:rgba(0,20,0,0.65)">
                        <div style="position:relative;display:grid;gap:6px">
                            <textarea id="ai-input" rows="2" autocomplete="off" placeholder="Ask Wave‑X AI…"
                                style="resize:vertical;min-height:44px;max-height:160px;background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:10px;padding:10px 12px 30px 12px;font-family:Consolas,monospace"></textarea>
                            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                                <div style="display:inline-flex;align-items:center;gap:8px">
                                    <label for="ai-image" class="px-btn" style="height:28px;display:inline-grid;place-items:center;padding:0 10px;cursor:pointer">+ Image</label>
                                    <input id="ai-image" type="file" accept="image/*" multiple style="display:none" />
                                    <div id="ai-image-list" style="display:flex;gap:8px;flex-wrap:wrap"></div>
                                </div>
                                <div style="font-size:11px;color:#9f9;opacity:.7;font-family:Consolas,monospace">
                                    Enter to send · Shift+Enter for newline
                                </div>
                            </div>
                        </div>
                        <button id="ai-send" class="px-btn" type="submit" style="height:44px;padding:0 16px;font-weight:700">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wave‑X Terminal Emulator (Linux-like, sandboxed)
        (function wavexTerminal(){
            const screen = document.getElementById('term-screen');
            const input = document.getElementById('term-input');
            const status = document.getElementById('term-status');
            const promptEl = document.getElementById('term-prompt');
            if (!screen || !input) return;

            // persistent storage keys
            const K_USER='wavex.term.user.v1';
            const K_PASS='wavex.term.passhash.v1';
            const K_FS='wavex.term.fs.v1';
            const K_HOME='wavex.term.home.v1';
            const K_ENV='wavex.term.env.v1';

            // helpers
            const now = () => new Date().toLocaleString();
            const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
            const sha1 = async (s) => {
                const enc = new TextEncoder().encode(s);
                const buf = await crypto.subtle.digest('SHA-1', enc);
                return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
            };
            const S = {
                get user(){ return localStorage.getItem(K_USER)||''; },
                set user(v){ try{ localStorage.setItem(K_USER,v);}catch{} },
                get pass(){ return localStorage.getItem(K_PASS)||''; },
                set pass(v){ try{ localStorage.setItem(K_PASS,v);}catch{} },
                get env(){
                    try{ return JSON.parse(localStorage.getItem(K_ENV)||'{}'); }catch{return{}}
                },
                set env(v){ try{ localStorage.setItem(K_ENV, JSON.stringify(v)); }catch{} },
                get fs(){
                    try{ return JSON.parse(localStorage.getItem(K_FS)||''); }catch{return null}
                },
                set fs(v){ try{ localStorage.setItem(K_FS, JSON.stringify(v)); }catch{} },
                get home(){ return localStorage.getItem(K_HOME)||''; },
                set home(v){ try{ localStorage.setItem(K_HOME,v);}catch{} },
            };

            // initialize pseudo filesystem if not present
            function makeFs() {
                return {
                    type:'dir', name:'/', children:{
                        'home':{ type:'dir', name:'home', children:{
                            'wave':{ type:'dir', name:'wave', children:{
                                'readme.txt':{ type:'file', name:'readme.txt', mode:644, data:
`Welcome to Wave‑X Terminal!

This is a sandboxed Linux‑like shell. Nothing touches your machine.

Try commands:
  help
  ls, cd, cat, echo, touch, mkdir, rm, mv, cp
  nano <file> (simple inline editor)
  sudo <cmd> (will prompt for a password once)
  pacman -Ss|-S|-R <pkg> (mock package manager)
  whoami, pwd, env, export KEY=VAL
  clear, date, uname -a, neofetch
  meme, rick, cowsay, fortune
  useradd <name>, passwd <name>, su <name>
  userdel <name>
  creds (view users), mkcreds (interactive)

Files persist via localStorage.` }
                            }},
                        }},
                        'etc':{ type:'dir', name:'etc', children:{
                            'motd':{ type:'file', name:'motd', mode:644, data:'Welcome to Wave‑X.\n' },
                            'passwd':{ type:'file', name:'passwd', mode:644, data:'wave:x:1000:1000::/home/wave:/bin/bash\n' },
                            'shadow':{ type:'file', name:'shadow', mode:600, data:'' },
                            'os-release':{ type:'file', name:'os-release', mode:644, data:'NAME="Wave‑X Linux"\\nID=wavex\\nVERSION_ID="0.1"\\n' }
                        }},
                        'bin':{ type:'dir', name:'bin', children:{}},
                        'usr':{ type:'dir', name:'usr', children:{
                            'share':{ type:'dir', name:'share', children:{
                                'cows':{ type:'dir', name:'cows', children:{
                                    'default.cow':{ type:'file', name:'default.cow', mode:644, data:'(oo)\\n (..)\\n' }
                                }}
                            }}
                        }},
                        'var':{ type:'dir', name:'var', children:{
                            'log':{ type:'dir', name:'log', children:{
                                'pacman.log':{ type:'file', name:'pacman.log', mode:644, data:'' }
                            }}
                        }}
                    }
                };
            }

            // user database persisted in /etc/{passwd,shadow} and simple list
            function parseUsers() {
                const fs = FS.find('/etc/passwd');
                const shadow = FS.find('/etc/shadow');
                const lines = (fs?.data||'').trim().split(/\n/).filter(Boolean);
                const secrets = Object.fromEntries((shadow?.data||'').trim().split(/\n/).filter(Boolean).map(l=>{
                    const [u,hash] = l.split(':'); return [u,hash||''];
                }));
                const map = new Map();
                for (const l of lines) {
                    const [name,_x,uid,gid,desc,home,shell] = l.split(':');
                    map.set(name,{uid:+uid||1000,gid:+gid||1000,home:home||(`/home/${name}`),shell:shell||'/bin/bash',pass:secrets[name]||''});
                }
                return map;
            }

            const FS = {
                root: S.fs || makeFs(),
                save(){ S.fs = this.root; },
                // resolve path
                res(path, cwd){
                    if (!path) path='.';
                    if (path.startsWith('~')) path = path.replace(/^~(?=\/|$)/, S.home || `/home/${S.user||'wave'}`);
                    let parts = path.startsWith('/') ? [''] : (cwd||'/').split('/'); // '' marks root
                    for (const seg of path.split('/')) {
                        if (!seg || seg==='.') continue;
                        if (seg==='..') { if (parts.length>1) parts.pop(); continue; }
                        parts.push(seg);
                    }
                    const norm = (parts[0]===''?'/':parts.join('/')).replace(/\/{2,}/g,'/');
                    return norm;
                },
                node(path){
                    const parts = path.split('/').filter(Boolean);
                    let cur = this.root;
                    if (path==='/') return cur;
                    for (const p of parts) {
                        if (cur.type!=='dir') return null;
                        cur = cur.children[p];
                        if (!cur) return null;
                    }
                    return cur;
                },
                find(path){ return this.node(path); },
                ensureDir(path){
                    const parts = path.split('/').filter(Boolean);
                    let cur = this.root;
                    for (const p of parts) {
                        if (!cur.children[p]) cur.children[p] = {type:'dir', name:p, children:{}};
                        cur = cur.children[p];
                        if (cur.type!=='dir') throw new Error('Not a directory');
                    }
                    this.save();
                    return cur;
                },
                writeFile(path, data, mode=644){
                    const dir = path.split('/').slice(0,-1).join('/')||'/';
                    const base = path.split('/').pop();
                    const d = dir==='/'? this.root : this.ensureDir(dir);
                    d.children[base] = { type:'file', name:base, mode, data:String(data||'') };
                    this.save();
                    return d.children[base];
                },
                remove(path){
                    if (path==='/') return false;
                    const dir = path.split('/').slice(0,-1).join('/')||'/';
                    const base = path.split('/').pop();
                    const d = (dir==='/'? this.root : this.node(dir));
                    if (!d || d.type!=='dir' || !d.children[base]) return false;
                    delete d.children[base];
                    this.save();
                    return true;
                },
                list(path){
                    const n = this.node(path);
                    if (!n || n.type!=='dir') return null;
                    return Object.values(n.children);
                },
                move(a,b){
                    const src = this.node(a);
                    if (!src) return false;
                    const dstDir = b.endsWith('/')? b.slice(0,-1): b;
                    const parentA = a.split('/').slice(0,-1).join('/')||'/';
                    const nameB = b.split('/').pop();
                    const parentNodeA = parentA==='/'? this.root : this.node(parentA);
                    const parentNodeB = (b.includes('/')? this.ensureDir(b.split('/').slice(0,-1).join('/')||'/') : this.root);
                    if (!parentNodeA || !parentNodeB) return false;
                    parentNodeB.children[nameB]= JSON.parse(JSON.stringify(src));
                    delete parentNodeA.children[a.split('/').pop()];
                    this.save();
                    return true;
                },
                copy(a,b){
                    const src = this.node(a);
                    if (!src) return false;
                    const parentNodeB = (b.includes('/')? this.ensureDir(b.split('/').slice(0,-1).join('/')||'/') : this.root);
                    parentNodeB.children[b.split('/').pop()]= JSON.parse(JSON.stringify(src));
                    this.save();
                    return true;
                }
            };

            // state
            let cwd = S.home || `/home/${S.user||'wave'}`;
            let hist = [];
            let histPos = -1;
            let waitingSudo = null; // {cmd, ts}
            let waitingNano = null; // {path, buf}
            let waitingMkCreds = null; // interactive creds creation
            let currentUser = S.user || 'wave';
            let users = parseUsers();

            // bootstrap user/pass once
            async function bootstrap() {
                status.textContent = '';
                if (!S.user) {
                    S.user = 'wave';
                    currentUser = 'wave';
                }
                if (!S.home) {
                    S.home = `/home/${S.user}`;
                    cwd = S.home;
                }
                // seed users if missing
                if (!users.has(currentUser)) {
                    const etcPasswd = FS.find('/etc/passwd');
                    etcPasswd.data += `${currentUser}:x:1000:1000::${S.home}:/bin/bash\n`;
                    FS.save();
                    users = parseUsers();
                }
                if (!S.pass) {
                    printLine(`First-time setup for user '${currentUser}'.`, 'muted');
                    printLine(`Set a sudo password (won't echo):`, 'sudo');
                    // enter passwd mode
                    waitingMkCreds = { step:'passwd1', user: currentUser, p1:'' };
                    promptUpdate();
                    return;
                }
                motd();
            }

            function prompt() {
                const host = 'wavex';
                const path = cwd.replace(/^\/home\/[^/]+/, '~');
                return `${currentUser}@${host}:${path}$`;
            }
            function promptUpdate(){
                promptEl.textContent = prompt() + (waitingNano? ' [nano]' : (waitingSudo? ' [sudo]' : (waitingMkCreds? ' [creds]' : '')));
            }

            function printLine(text='', cls='') {
                const line = document.createElement('div');
                line.className = `line ${cls}`;
                line.textContent = text;
                screen.appendChild(line);
                screen.scrollTop = screen.scrollHeight;
            }
            function print(text='', cls='') {
                const pre = document.createElement('div');
                pre.className = `line ${cls}`;
                pre.innerText = text; // preserve newlines
                screen.appendChild(pre);
                screen.scrollTop = screen.scrollHeight;
            }
            function motd() {
                const rel = FS.find('/etc/os-release')?.data || '';
                printLine(`Last login: ${now()} on tty1`, 'muted');
                print(FS.find('/etc/motd')?.data || '');
                print(rel);
                promptUpdate();
            }

            // utils
            function splitArgs(s) {
                const out=[]; let cur=''; let q=null;
                for (let i=0;i<s.length;i++){
                    const ch=s[i];
                    if (q) {
                        if (ch===q){ q=null; continue; }
                        if (ch==='\\' && i+1<s.length){ cur+=s[++i]; continue; }
                        cur+=ch;
                    } else {
                        if (ch==='"' || ch==="'"){ q=ch; continue; }
                        if (/\s/.test(ch)){ if (cur) { out.push(cur); cur=''; } continue; }
                        cur+=ch;
                    }
                }
                if (cur) out.push(cur);
                return out;
            }
            function resolvePath(p){ return FS.res(p, cwd); }

            // command handlers
            const CMDS = {};
            CMDS.help = () => {
                print(`Available commands:
  help, clear, date, uname, neofetch, whoami, pwd, env, export, echo
  ls, cd, cat, touch, mkdir, rm, mv, cp
  nano <file>  - inline text editor, Ctrl+S to save, Ctrl+X to exit (simulated)
  sudo <cmd>   - run a command as root (needs password set once)
  pacman       - mock package manager: -Ss search, -S install, -R remove
  cowsay, fortune, meme, rick
  creds        - show users
  mkcreds      - interactive user+password creation (saved)
  useradd <u>, passwd <u>, su <u>, userdel <u>
  man <cmd>    - brief description`, 'muted');
            };
            CMDS.man = (args)=>{
                const m = {
                    nano:'Edit or create a text file inline in terminal.',
                    sudo:'Run command with elevated privileges.',
                    pacman:'Package manager mock. Use -Ss, -S, -R.',
                    mkcreds:'Interactive create user and set password.',
                    creds:'List users known to the system.',
                    su:'Switch user for the session.',
                };
                const k=args[0]; if (!k) { printLine('man: specify a command', 'err'); return; }
                printLine(`${k} — ${m[k]||'No manual entry.'}`);
            };
            CMDS.clear = ()=>{ screen.innerHTML=''; };
            CMDS.date = ()=> printLine(new Date().toString());
            CMDS.uname = (a)=> printLine(a.includes('-a')? 'Linux wavex 5.19.0 #1 SMP PREEMPT Wave‑X' : 'Linux');
            CMDS.neofetch = ()=> {
                const art = `
             .------.
            /  .-.  \\    Wave‑X Linux 0.1
           /  /   \\  \\   User: ${currentUser}
           |  |   |  |   Shell: bash (mock)
           \\  \\   /  /   Uptime: forever
            \\  '-'  /    Packages: ${pkgs.size}
             '-----'     Theme: Matrix Green
`;
                print(art);
            };
            CMDS.whoami = ()=> printLine(currentUser);
            CMDS.pwd = ()=> printLine(cwd);
            CMDS.env = ()=> print(JSON.stringify(S.env,null,2));
            CMDS.export = (a)=>{
                for (const kv of a) {
                    const m = kv.match(/^([\w_]+)=(.*)$/);
                    if (m){ const env=S.env; env[m[1]]=m[2]; S.env=env; }
                }
            };
            CMDS.echo = (a)=> printLine(a.join(' '));
            CMDS.ls = (a)=>{
                const path = resolvePath(a[0]||'.');
                const list = FS.list(path);
                if (!list) { printLine('ls: not a directory', 'err'); return; }
                const names = list.map(n=>{
                    const cls = n.type==='dir'?'dir': (n.mode===755?'exe':'file');
                    return `%${cls}%${n.name}`;
                });
                // colorize
                const line = document.createElement('div');
                line.className='line';
                line.innerHTML = names.map(s=>s.replace('%dir%','<span class="dir">').replace('%exe%','<span class="exe">').replace('%file%','<span class="file">')) .map(s=> s + '</span>').join('  ');
                screen.appendChild(line); screen.scrollTop=screen.scrollHeight;
            };
            CMDS.cd = (a)=>{
                const to = resolvePath(a[0]||S.home);
                const node = FS.find(to);
                if (!node || node.type!=='dir'){ printLine(`cd: ${a[0]||''}: Not a directory`, 'err'); return; }
                cwd = to;
            };
            CMDS.cat = (a)=>{
                const f = FS.find(resolvePath(a[0]||''));
                if (!f || f.type!=='file'){ printLine('cat: no such file', 'err'); return; }
                print(f.data);
            };
            CMDS.touch = (a)=>{ if (!a[0]){printLine('touch: file required','err');return;} FS.writeFile(resolvePath(a[0]), ''); };
            CMDS.mkdir = (a)=>{ if (!a[0]){printLine('mkdir: dir required','err');return;} FS.ensureDir(resolvePath(a[0])); };
            CMDS.rm = (a)=>{
                if (!a[0]){ printLine('rm: path required','err'); return; }
                const ok = FS.remove(resolvePath(a[0]));
                if (!ok) printLine('rm: failed','err');
            };
            CMDS.mv = (a)=>{ if (a.length<2){printLine('mv: src dest','err');return;} if(!FS.move(resolvePath(a[0]), resolvePath(a[1]))) printLine('mv: failed','err'); };
            CMDS.cp = (a)=>{ if (a.length<2){printLine('cp: src dest','err');return;} if(!FS.copy(resolvePath(a[0]), resolvePath(a[1]))) printLine('cp: failed','err'); };
            CMDS.nano = (a)=>{
                const p = resolvePath(a[0]||'');
                if (!p){ printLine('nano: file required','err'); return; }
                const f = FS.find(p) || FS.writeFile(p,'');
                waitingNano = { path:p, buf: f.data||'' };
                printLine(`--- nano: editing ${p} ---`, 'nano');
                print(waitingNano.buf);
                printLine(`(Type your content; press Ctrl+S to save, Ctrl+X to exit)`, 'nano');
            };

            // sudo and auth
            async function setPassword(user, plain) {
                const hash = await sha1(plain);
                // store global sudo hash and /etc/shadow entry
                S.pass = hash;
                const shadow = FS.find('/etc/shadow');
                const lines = (shadow?.data||'').split(/\n/).filter(Boolean).filter(l=>!l.startsWith(user+':'));
                lines.push(`${user}:${hash}`);
                shadow.data = lines.join('\n') + '\n';
                FS.save();
                users = parseUsers();
            }
            async function checkPassword(user, plain) {
                const hash = await sha1(plain);
                const saved = S.pass;
                return saved && hash===saved;
            }

            CMDS.sudo = async (a)=>{
                if (!a.length){ printLine('usage: sudo <command> [args]', 'err'); return; }
                waitingSudo = { cmd: a.join(' '), ts: Date.now() };
                printLine(`[sudo] password for ${currentUser}:`, 'sudo');
            };

            // pacman mock
            const pkgs = new Map(); // name -> {installed:boolean, desc}
            const repo = new Map(Object.entries({
                'nano': {desc:'Simple text editor', hook:()=>{}},
                'fortunes': {desc:'Print random fortunes', hook:()=>{}},
                'cowsay': {desc:'Cow ASCII says things', hook:()=>{}},
                'neofetch': {desc:'System info fetcher', hook:()=>{}},
                'rick': {desc:'Never gonna give you up', hook:()=>{}},
            }));
            function logPacman(s){ const log=FS.find('/var/log/pacman.log'); log.data += `[${now()}] ${s}\n`; FS.save(); }
            CMDS.pacman = (a)=>{
                if (!a.length){ printLine('usage: pacman -Ss <term> | -S <pkg> | -R <pkg>'); return; }
                const flag = a[0];
                if (flag==='-Ss'){
                    const q = (a[1]||'').toLowerCase();
                    for (const [n,meta] of repo){
                        if (!q || n.includes(q) || (meta.desc||'').toLowerCase().includes(q)){
                            printLine(`${n} - ${meta.desc||''}`, 'pkg');
                        }
                    }
                } else if (flag==='-S'){
                    const n = a[1]; if (!n){ printLine('pacman -S <pkg>','err'); return; }
                    if (!repo.has(n)){ printLine(`error: target not found: ${n}`, 'err'); return; }
                    pkgs.set(n, {installed:true});
                    logPacman(`installed ${n}`);
                    printLine(`resolving dependencies... done`);
                    printLine(`looking for conflicting packages... none`);
                    printLine(`installing ${n}... done`, 'ok');
                } else if (flag==='-R'){
                    const n = a[1]; if (!n){ printLine('pacman -R <pkg>','err'); return; }
                    if (!pkgs.get(n)?.installed){ printLine(`error: ${n} not installed`, 'err'); return; }
                    pkgs.set(n, {installed:false});
                    logPacman(`removed ${n}`);
                    printLine(`removing ${n}... done`, 'ok');
                } else {
                    printLine('pacman: unsupported flags', 'err');
                }
            };

            // fun
            CMDS.cowsay = (a)=>{
                const msg = a.join(' ') || 'moo';
                const bubble = ` ${'-'.repeat(msg.length+2)}
< ${msg} >
 ${'-'.repeat(msg.length+2)}
        \\   ^__^
         \\  (oo)\\_______
            (__)\\       )\\/\\
                ||----w |
                ||     ||`;
                print(bubble);
            };
            CMDS.fortune = ()=>{
                const lines = [
                    'Never trust a computer you can’t throw out a window.',
                    'There are only two kinds of languages: the ones people complain about and the ones nobody uses.',
                    'To iterate is human, to recurse divine.',
                ];
                printLine(lines[Math.floor(Math.random()*lines.length)]);
            };
            CMDS.meme = ()=>{ printLine('low taper fade still massive.', 'cmeme'); };
            CMDS.rick = ()=>{ printLine('Never gonna give you up 🎵', 'cmeme'); };

            // creds and users
            CMDS.creds = ()=>{
                const arr = Array.from(parseUsers().keys());
                printLine(`Users: ${arr.join(', ')||'(none)'}`);
            };
            CMDS.mkcreds = ()=>{
                if (waitingMkCreds){ printLine('Already creating credentials.','err'); return; }
                printLine('Create a new user:', 'muted');
                waitingMkCreds = { step:'ask-user' };
            };
            CMDS.useradd = (a)=>{
                const u=a[0]; if (!u){ printLine('useradd: username required','err'); return; }
                if (parseUsers().has(u)){ printLine('useradd: user exists','err'); return; }
                const home = `/home/${u}`;
                // update passwd
                const pw = FS.find('/etc/passwd');
                pw.data += `${u}:x:${Math.floor(Math.random()*5000)+1000}:1000::${home}:/bin/bash\n`;
                FS.ensureDir(home);
                FS.writeFile(`${home}/readme.txt`, `Hi ${u}! This is your home.`);
                FS.save();
                users = parseUsers();
                printLine(`useradd: added ${u}`, 'ok');
            };
            CMDS.userdel = (a)=>{
                const u=a[0]; if (!u){ printLine('userdel: username required','err'); return; }
                if (!parseUsers().has(u)){ printLine('userdel: no such user','err'); return; }
                // remove from passwd and shadow
                const pw = FS.find('/etc/passwd');
                pw.data = pw.data.split(/\n/).filter(Boolean).filter(l=>!l.startsWith(u+':')).join('\n')+'\n';
                const sh = FS.find('/etc/shadow');
                sh.data = (sh.data||'').split(/\n/).filter(Boolean).filter(l=>!l.startsWith(u+':')).join('\n')+'\n';
                FS.save(); users=parseUsers();
                printLine(`userdel: removed ${u}`, 'ok');
            };
            CMDS.passwd = async (a)=>{
                const u=a[0]||currentUser;
                if (!parseUsers().has(u)){ printLine('passwd: user does not exist','err'); return; }
                printLine(`Changing password for ${u}. Enter new password:`, 'sudo');
                waitingMkCreds = { step:'passwd1', user:u, p1:'' };
            };
            CMDS.su = (a)=>{
                const u=a[0]; if (!u){ printLine('su: user required','err'); return; }
                if (!parseUsers().has(u)){ printLine('su: user does not exist','err'); return; }
                currentUser = u;
                S.user = u;
                S.home = `/home/${u}`;
                cwd = S.home;
                promptUpdate();
                printLine(`Switched to ${u}`);
            };

            // input handling
            async function handleEnter(cmdline) {
                // interactive states
                if (waitingNano){
                    // in "nano", accept line input append. Control keys via shortcuts
                    waitingNano.buf += (waitingNano.buf.endsWith('\n')?'':'\n') + cmdline;
                    printLine(cmdline);
                    return;
                }
                if (waitingSudo){
                    const ok = await checkPassword(currentUser, cmdline);
                    if (!ok){ printLine('Sorry, try again.', 'err'); printLine(`[sudo] password for ${currentUser}:`, 'sudo'); return; }
                    const cmd = waitingSudo.cmd;
                    waitingSudo = null;
                    printLine(`sudo: ${cmd}`, 'sudo');
                    await run(cmd);
                    promptUpdate();
                    return;
                }
                if (waitingMkCreds){
                    if (waitingMkCreds.step==='ask-user'){
                        const u = (cmdline||'').trim();
                        if (!u){ printLine('username cannot be empty','err'); return; }
                        if (parseUsers().has(u)){ printLine('user exists, choose another','err'); return; }
                        waitingMkCreds = { step:'passwd1', user:u, p1:'' };
                        printLine(`Set password for ${u}:`, 'sudo');
                        return;
                    } else if (waitingMkCreds.step==='passwd1'){
                        waitingMkCreds.p1 = cmdline;
                        waitingMkCreds.step = 'passwd2';
                        printLine(`Confirm password:`, 'sudo');
                        return;
                    } else if (waitingMkCreds.step==='passwd2'){
                        if (cmdline !== waitingMkCreds.p1){ printLine('Passwords do not match.','err'); waitingMkCreds=null; return; }
                        const u = waitingMkCreds.user;
                        if (!parseUsers().has(u)){
                            // create user (like useradd)
                            const home = `/home/${u}`;
                            const pw = FS.find('/etc/passwd');
                            pw.data += `${u}:x:${Math.floor(Math.random()*5000)+1000}:1000::${home}:/bin/bash\n`;
                            FS.ensureDir(home);
                        }
                        await setPassword(u, cmdline);
                        printLine(`Password set for ${u}`, 'ok');
                        waitingMkCreds = null;
                        FS.save(); users=parseUsers();
                        // if this was initial bootstrap for current user: show motd
                        if (u===currentUser) motd();
                        return;
                    }
                }

                // normal command
                await run(cmdline);
            }

            async function run(line) {
                const raw = (line||'').trim();
                printLine(`${prompt()} ${raw}`);
                if (!raw){ promptUpdate(); return; }
                hist.push(raw); histPos = hist.length;

                // simple shortcuts
                if (raw === 'Ctrl+S' && waitingNano){
                    FS.writeFile(waitingNano.path, waitingNano.buf);
                    printLine(`Saved ${waitingNano.path}`, 'ok'); return;
                }
                if (raw === 'Ctrl+X' && waitingNano){
                    printLine(`Exited nano.`, 'nano'); waitingNano=null; promptUpdate(); return;
                }

                const args = splitArgs(raw);
                const cmd = args.shift();

                if (CMDS[cmd]) {
                    const res = CMDS[cmd](args) ;
                    if (res instanceof Promise) await res;
                } else {
                    printLine(`${cmd}: command not found`, 'err');
                }
                promptUpdate();
            }

            // keyboard handling
            input.addEventListener('keydown', (e)=>{
                if (e.key==='Enter'){
                    const v = input.value;
                    input.value = '';
                    handleEnter(v);
                } else if (e.key==='ArrowUp'){
                    e.preventDefault();
                    histPos = clamp(histPos-1, 0, hist.length);
                    input.value = hist[histPos]||'';
                    input.setSelectionRange(input.value.length, input.value.length);
                } else if (e.key==='ArrowDown'){
                    e.preventDefault();
                    histPos = clamp(histPos+1, 0, hist.length);
                    input.value = hist[histPos]||'';
                    input.setSelectionRange(input.value.length, input.value.length);
                } else if (e.ctrlKey && e.key.toLowerCase()==='s'){
                    e.preventDefault();
                    if (waitingNano){
                        FS.writeFile(waitingNano.path, waitingNano.buf);
                        printLine(`Saved ${waitingNano.path}`, 'ok');
                    }
                } else if (e.ctrlKey && e.key.toLowerCase()==='x'){
                    e.preventDefault();
                    if (waitingNano){ printLine(`Exited nano.`, 'nano'); waitingNano=null; promptUpdate(); }
                }
            });

            // focus when terminal tab shown
            const tabs = document.getElementById('main-tabs');
            tabs?.addEventListener('click', (ev)=>{
                const btn = ev.target.closest('.tab');
                if (btn?.getAttribute('data-tab')==='terminal'){
                    setTimeout(()=> input.focus(), 50);
                }
            });

            promptUpdate();
            bootstrap();
        })();

        // Context menu + Folders for Desktop (Games tab)
        (function desktopContextAndFolders(){
            const grid = document.getElementById('games-grid');
            if (!grid) return;

            // Build context menu
            const menu = document.createElement('div');
            menu.className = 'desktop-context';
            // Detect OS flavor for labeling
            const ua = navigator.userAgent || '';
            const isMac = /Macintosh|Mac OS X|Mac_PowerPC|MacIntel/i.test(ua);
            const isWin = /Windows NT|Win64|Win32/i.test(ua);
            const osLabel = isMac ? 'macOS' : (isWin ? 'Windows' : 'System');

            menu.innerHTML = `
                <div class="menu-item" data-action="new-folder">📁 New Folder</div>
                <div class="sep"></div>
                <div class="menu-item" data-action="reset-layout">↺ Reset Layout</div>
                <div class="menu-item" data-action="sort-az">A→Z Sort</div>
                <div class="sep"></div>
                <div class="menu-item" data-action="os-settings">⚙️ Open ${osLabel} Settings</div>
                <div class="menu-item" data-action="os-files">${isMac ? '🗂️ Open Finder' : '🗁 Open File Explorer'}</div>
                <div class="menu-item" data-action="os-terminal">⌨️ Open ${isMac ? 'Terminal' : 'Command Prompt'}</div>
                <div class="sep"></div>
                <div class="menu-item" data-action=" personalize">🎨 Personalize…</div>
                <div class="menu-item" data-action=" refresh">🔄 Refresh</div>
            `;
            document.body.appendChild(menu);

            // Per-card context menu for game items
            const cardMenu = document.createElement('div');
            cardMenu.className = 'desktop-context';
            cardMenu.innerHTML = `
                <div class="menu-item" data-action="open">Open</div>
                <div class="menu-item" data-action="add-to-folder">Add to Folder…</div>
            `;
            // Lightweight folder picker modal
            const folderPicker = document.createElement('div');
            folderPicker.style.cssText = 'position:fixed;inset:0;display:none;place-items:center;z-index:4000;background:rgba(0,0,0,0.35)';
            folderPicker.innerHTML = `
              <div style="min-width:280px;max-width:420px;background:rgba(0,20,0,0.95);border:1px solid rgba(0,255,0,0.25);border-radius:10px;box-shadow:0 8px 28px rgba(0,255,0,0.18);padding:12px;color:#cfeccf;font-family:Consolas,monospace">
                <div style="font-weight:800;margin-bottom:8px">Add to Folder</div>
                <div style="display:grid;gap:8px">
                  <label for="fp-select" style="font-size:12px;opacity:.85">Choose folder:</label>
                  <select id="fp-select" style="background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:8px;padding:6px"></select>
                  <div style="display:flex;gap:8px;justify-content:flex-end">
                    <button id="fp-cancel" class="px-btn" style="height:28px;padding:0 10px">Cancel</button>
                    <button id="fp-add" class="px-btn" style="height:28px;padding:0 10px">Add</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(folderPicker);
            const fpSelect = () => folderPicker.querySelector('#fp-select');
            const fpShow = () => folderPicker.style.display = 'grid';
            const fpHide = () => folderPicker.style.display = 'none';
            folderPicker.querySelector('#fp-cancel').addEventListener('click', fpHide);
            folderPicker.addEventListener('click', (e) => {
                if (e.target === folderPicker) fpHide();
            });
            document.body.appendChild(cardMenu);

            let cardMenuTarget = null;

            function hideCardMenu() {
                cardMenu.classList.remove('open');
                cardMenuTarget = null;
            }
            function showCardMenu(x, y, target) {
                cardMenuTarget = target;
                cardMenu.style.left = x + 'px';
                cardMenu.style.top = y + 'px';
                const r = cardMenu.getBoundingClientRect();
                const vw = window.innerWidth, vh = window.innerHeight;
                if (r.right > vw - 4) cardMenu.style.left = (vw - r.width - 4) + 'px';
                if (r.bottom > vh - 4) cardMenu.style.top = (vh - r.height - 4) + 'px';
                cardMenu.classList.add('open');
            }

            // Populate folder picker with current folders
            function populateFolderPicker() {
                const select = fpSelect();
                if (!select) return;
                select.innerHTML = '';
                const folders = Array.from(grid.querySelectorAll('.game-card.folder-card'));
                if (!folders.length) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = '(No folders found)';
                    select.appendChild(opt);
                    select.disabled = true;
                } else {
                    select.disabled = false;
                    folders.forEach(f => {
                        const title = f.getAttribute('data-title') || 'Folder';
                        const opt = document.createElement('option');
                        opt.value = f.id || '';
                        opt.textContent = title;
                        // ensure has id
                        if (!f.id) f.id = (title.toLowerCase().replace(/\s+/g,'-')) + '-' + Date.now();
                        opt.value = f.id;
                        select.appendChild(opt);
                    });
                }
            }

            function hideMenu() {
                menu.classList.remove('open');
            }
            function showMenu(x, y) {
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
                // keep inside viewport
                const r = menu.getBoundingClientRect();
                const vw = window.innerWidth, vh = window.innerHeight;
                if (r.right > vw - 4) menu.style.left = (vw - r.width - 4) + 'px';
                if (r.bottom > vh - 4) menu.style.top = (vh - r.height - 4) + 'px';
                menu.classList.add('open');
            }

            // Right-click handling
            grid.addEventListener('contextmenu', (e) => {
                const onCard = e.target.closest('.game-card');
                if (onCard) {
                    e.preventDefault();
                    // Only allow per-card menu for game cards (not folders)
                    if (!onCard.classList.contains('folder-card')) {
                        showCardMenu(e.clientX, e.clientY, onCard);
                    }
                    return;
                }
                e.preventDefault();
                showMenu(e.clientX, e.clientY);
            });
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target)) hideMenu();
                if (!cardMenu.contains(e.target)) hideCardMenu();
            });

            // Handle card context menu actions
            cardMenu.addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.getAttribute('data-action');
                const card = cardMenuTarget;
                hideCardMenu();
                if (!card) return;

                if (action === 'open') {
                    // simulate a double-click open
                    card.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
                    return;
                }
                if (action === 'add-to-folder') {
                    populateFolderPicker();
                    fpShow();
                    const addBtn = folderPicker.querySelector('#fp-add');
                    // Remove previous handler if any
                    const newAddBtn = addBtn.cloneNode(true);
                    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
                    newAddBtn.addEventListener('click', () => {
                        const select = fpSelect();
                        const folderId = select && select.value;
                        if (!folderId) { fpHide(); return; }
                        const folderEl = document.getElementById(folderId);
                        if (!folderEl) { fpHide(); return; }
                        try {
                            addChildToFolder(folderEl, card);
                        } catch {}
                        fpHide();
                    });
                }
            });
            window.addEventListener('blur', () => { hideMenu(); hideCardMenu(); });
            window.addEventListener('resize', () => { hideMenu(); hideCardMenu(); });
            document.addEventListener('scroll', () => { hideMenu(); hideCardMenu(); }, true);

            // Utilities from desktopFreeForm scope
            const GRID_SIZE = 44;
            const STORAGE_POS_GAMES = 'wavex.games.pos.v1';
            function snap(v) { return Math.max(4, Math.round(v / GRID_SIZE) * GRID_SIZE); }
            function savePositions(positions) {
                try { localStorage.setItem(STORAGE_POS_GAMES, JSON.stringify(positions)); } catch {}
            }
            function loadPositions() {
                try { return JSON.parse(localStorage.getItem(STORAGE_POS_GAMES) || '{}'); } catch { return {}; }
            }
            function ensureId(el) {
                if (!el.id) {
                    el.id = (el.getAttribute('data-title') || 'folder') .toLowerCase().replace(/\s+/g,'-') + '-' + Date.now();
                }
                return el.id;
            }

            // Create a folder at approximate viewport position mapped into grid coordinates
            function createFolderAt(clientX, clientY) {
                const rect = grid.getBoundingClientRect();
                const x = snap(clientX - rect.left);
                const y = snap(clientY - rect.top);

                const folder = document.createElement('div');
                folder.className = 'game-card folder-card';
                folder.setAttribute('data-title', 'New Folder');

                folder.innerHTML = `
                    <div class="folder-thumb" aria-hidden="true">FOLDER</div>
                    <div class="game-caption" contenteditable="false" spellcheck="false" title="Double-click to open, F2 to rename">New Folder</div>
                `;

                folder.style.left = x + 'px';
                folder.style.top = y + 'px';

                // open/close on double-click: toggles a contained area for children
                folder.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    openFolderWindow(folder);
                });

                // keyboard rename (F2)
                folder.addEventListener('keydown', (e) => {
                    if (e.key === 'F2') {
                        e.preventDefault();
                        startRename(folder);
                    }
                });

                // pointer rename via slow double click on caption
                const caption = folder.querySelector('.game-caption');
                caption.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    startRename(folder);
                });

                grid.appendChild(folder);

                // persist position
                const positions = loadPositions();
                positions[ensureId(folder)] = { x, y };
                savePositions(positions);

                // make folder droppable for game-cards
                makeDroppable(folder);

                return folder;
            }

            // Simple windowed view of folder contents using existing window manager
            function openFolderWindow(folder) {
                const title = (folder.getAttribute('data-title') || 'Folder');
                const win = createAppWindow('about:blank', title);
                const body = win.querySelector('.app-body');
                body.style.padding = '10px';
                body.style.display = 'grid';
                body.style.gap = '8px';
                body.style.color = '#cfc';
                body.style.fontFamily = 'Consolas, monospace';

                const list = document.createElement('div');
                list.style.display = 'flex';
                list.style.flexWrap = 'wrap';
                list.style.gap = '8px';
                body.appendChild(list);

                // Build from data-folder-children ids
                const childIds = (folder.getAttribute('data-children') || '').split(',').filter(Boolean);
                if (!childIds.length) {
                    const empty = document.createElement('div');
                    empty.textContent = '(Empty folder)';
                    empty.style.opacity = '0.8';
                    body.appendChild(empty);
                } else {
                    childIds.forEach(id => {
                        const card = document.getElementById(id);
                        if (!card) return;
                        const chip = document.createElement('button');
                        chip.className = 'px-btn';
                        chip.textContent = card.getAttribute('data-title') || 'App';
                        chip.addEventListener('click', () => {
                            // simulate double-click open
                            card.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
                        });
                        list.appendChild(chip);
                    });
                }
            }

            function startRename(folder) {
                const caption = folder.querySelector('.game-caption');
                if (!caption) return;
                caption.setAttribute('contenteditable', 'true');
                caption.focus();
                const range = document.createRange();
                range.selectNodeContents(caption);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);

                function finish(ok) {
                    caption.removeEventListener('blur', onBlur);
                    caption.removeEventListener('keydown', onKey);
                    caption.setAttribute('contenteditable', 'false');
                    if (ok) {
                        const name = caption.textContent.trim() || 'Folder';
                        caption.textContent = name;
                        folder.setAttribute('data-title', name);
                    } else {
                        // revert display text to attribute
                        caption.textContent = folder.getAttribute('data-title') || 'Folder';
                    }
                }
                function onBlur() { finish(true); }
                function onKey(e) {
                    if (e.key === 'Enter') { e.preventDefault(); finish(true); }
                    if (e.key === 'Escape') { e.preventDefault(); finish(false); }
                }
                caption.addEventListener('blur', onBlur);
                caption.addEventListener('keydown', onKey);
            }

            // Track children inside folder via data-children (comma separated ids)
            function addChildToFolder(folder, card) {
                const id = ensureId(card);
                const raw = folder.getAttribute('data-children') || '';
                const set = new Set(raw ? raw.split(',').filter(Boolean) : []);
                set.add(id);
                folder.setAttribute('data-children', Array.from(set).join(','));
                // optional: visually indicate count
                updateFolderBadge(folder);
                // Persist members to localStorage under folder key
                persistFolders();
            }
            function removeChildFromFolder(folder, card) {
                const id = card.id;
                const raw = folder.getAttribute('data-children') || '';
                const list = raw ? raw.split(',').filter(Boolean) : [];
                const next = list.filter(x => x !== id);
                folder.setAttribute('data-children', next.join(','));
                updateFolderBadge(folder);
                persistFolders();
            }
            function updateFolderBadge(folder) {
                // could render count overlay; keep minimal for now
            }

            // Persist all folders' children list so membership survives reload
            const STORAGE_FOLDERS = 'wavex.games.folders.v1';
            function persistFolders() {
                const data = {};
                Array.from(grid.querySelectorAll('.game-card.folder-card')).forEach(f => {
                    const id = f.id || '';
                    const title = f.getAttribute('data-title') || 'Folder';
                    const children = (f.getAttribute('data-children') || '');
                    if (id) data[id] = { title, children };
                });
                try { localStorage.setItem(STORAGE_FOLDERS, JSON.stringify(data)); } catch {}
            }
            function restoreFolders() {
                let saved = {};
                try { saved = JSON.parse(localStorage.getItem(STORAGE_FOLDERS) || '{}'); } catch { saved = {}; }
                Object.entries(saved).forEach(([id, obj]) => {
                    const el = document.getElementById(id);
                    if (el && el.classList.contains('folder-card')) {
                        el.setAttribute('data-title', obj.title || 'Folder');
                        el.setAttribute('data-children', obj.children || '');
                        const cap = el.querySelector('.game-caption');
                        if (cap) cap.textContent = obj.title || 'Folder';
                    }
                });
            }
            // run once on load
            restoreFolders();

            // Make folder droppable and grid root droppable to "remove from folder"
            function makeDroppable(folder) {
                folder.addEventListener('dragover', (e) => { e.preventDefault(); });
                folder.addEventListener('drop', (e) => {
                    const id = e.dataTransfer.getData('text/plain');
                    const card = document.getElementById(id);
                    if (!card || card === folder) return;
                    // only accept game-card (not folder into folder)
                    if (card.classList.contains('folder-card')) return;
                    addChildToFolder(folder, card);
                    // hide original from desktop when moved into folder
                    card.style.display = 'none';
                });
            }

            // Enable dragging of game-cards through native DnD without breaking existing pointer-drag layout
            function enableDragForCards() {
                document.querySelectorAll('#games-grid .game-card').forEach(card => {
                    if (card.classList.contains('folder-card')) return;
                    // Add draggable ghost for HTML5 DnD
                    card.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', ensureId(card));
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    // Allow starting a native drag when holding Ctrl (so we don't conflict with pointer layout drag)
                    card.addEventListener('pointerdown', (e) => {
                        if (e.ctrlKey) {
                            // temporarily set draggable to true to allow native DnD
                            card.setAttribute('draggable', 'true');
                        } else {
                            card.setAttribute('draggable', 'false');
                        }
                    });
                    card.addEventListener('pointerup', () => {
                        card.setAttribute('draggable', 'false');
                    });
                });

                // Root grid: dropping back removes from folder and shows on desktop again at drop position
                grid.addEventListener('dragover', (e) => { e.preventDefault(); });
                grid.addEventListener('drop', (e) => {
                    const id = e.dataTransfer.getData('text/plain');
                    const card = document.getElementById(id);
                    if (!card) return;
                    // find any folder that currently contains it and remove
                    document.querySelectorAll('#games-grid .folder-card').forEach(f => removeChildFromFolder(f, card));
                    // place it at drop location on grid
                    const rect = grid.getBoundingClientRect();
                    const nx = snap(e.clientX - rect.left);
                    const ny = snap(e.clientY - rect.top);
                    card.style.left = nx + 'px';
                    card.style.top  = ny + 'px';
                    card.style.display = '';
                    // persist new position
                    const positions = loadPositions();
                    positions[ensureId(card)] = { x: nx, y: ny };
                    savePositions(positions);
                });
            }

            enableDragForCards();

            // Wire menu actions
            menu.addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = (item.getAttribute('data-action') || '').trim();
                hideMenu();

                if (action === 'new-folder') {
                    // place folder roughly at menu position; menu's current left/top
                    const x = parseInt(menu.style.left || '100', 10) + 8;
                    const y = parseInt(menu.style.top || '100', 10) + 8;
                    const folder = createFolderAt(x, y);
                    // immediately rename
                    startRename(folder);
                    return;
                }
                if (action === 'reset-layout') {
                    const btn = document.getElementById('games-reset-layout');
                    btn && btn.click();
                    return;
                }
                if (action === 'sort-az') {
                    const btn = document.getElementById('games-sort-alpha');
                    btn && btn.click();
                    return;
                }
                // OS-like helpers (open in in-site window manager)
                if (action === 'os-settings') {
                    // Open a settings/help window with OS tips
                    const win = createAppWindow('about:blank', `${osLabel} Settings`);
                    const body = win.querySelector('.app-body');
                    body.innerHTML = `
                      <div style="padding:12px;color:#cfc;font-family:Consolas,monospace;display:grid;gap:10px">
                        <div style="font-weight:800">Quick ${osLabel} Settings</div>
                        <div style="opacity:.9;font-size:13px">
                          This is a simulated shortcut. Use the buttons below to adjust Wave‑X appearance and behavior.
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                          <button id="os-open-ext" class="px-btn">Open Extensions</button>
                          <button id="os-open-bg" class="px-btn">Background</button>
                          <button id="os-open-contrast" class="px-btn">High Contrast</button>
                        </div>
                      </div>
                    `;
                    body.querySelector('#os-open-ext')?.addEventListener('click', () => openExtensionsWindow());
                    body.querySelector('#os-open-bg')?.addEventListener('click', () => openBackgroundChanger());
                    body.querySelector('#os-open-contrast')?.addEventListener('click', async () => {
                        try {
                            openExtensionsWindow('High‑Contrast Mode');
                        } catch {}
                    });
                    return;
                }
                if (action === 'os-files') {
                    // Simulated file manager: open games grid in a list inside window
                    const win = createAppWindow('about:blank', isMac ? 'Finder' : 'File Explorer');
                    const body = win.querySelector('.app-body');
                    const items = Array.from(document.querySelectorAll('#games-grid .game-card:not(.folder-card)')).slice(0, 50);
                    body.innerHTML = `
                      <div style="padding:10px;color:#cfc;font-family:Consolas,monospace;display:grid;gap:8px">
                        <div style="font-weight:800">${isMac ? 'Finder' : 'Explorer'}</div>
                        <div style="display:grid;gap:6px" id="fm-list"></div>
                      </div>
                    `;
                    const list = body.querySelector('#fm-list');
                    items.forEach(card => {
                        const title = card.getAttribute('data-title') || 'App';
                        const row = document.createElement('button');
                        row.className = 'px-btn';
                        row.style.cssText = 'justify-content:flex-start';
                        row.textContent = title;
                        row.addEventListener('click', () => {
                            // simulate open
                            card.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
                        });
                        list.appendChild(row);
                    });
                    return;
                }
                if (action === 'os-terminal') {
                    // Simple in-site terminal-like window (no real shell)
                    const win = createAppWindow('about:blank', isMac ? 'Terminal' : 'Command Prompt');
                    const body = win.querySelector('.app-body');
                    body.innerHTML = `
                      <div style="padding:10px;font-family:Consolas,monospace;color:#cfc;display:grid;grid-template-rows:1fr auto;gap:8px;height:100%">
                        <pre id="term-out" style="margin:0;white-space:pre-wrap;overflow:auto;border:1px solid rgba(0,255,0,0.2);border-radius:8px;padding:8px;background:#000;min-height:160px">Wave‑X ${isMac ? 'sh' : 'cmd'} (simulated)
Type 'help' for commands.
</pre>
                        <form id="term-form" style="display:grid;grid-template-columns:1fr auto;gap:8px">
                          <input id="term-input" autocomplete="off" placeholder="${isMac ? 'whoami' : 'dir'}" style="background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:8px;padding:8px"/>
                          <button class="px-btn" type="submit">Run</button>
                        </form>
                      </div>
                    `;
                    const out = body.querySelector('#term-out');
                    const form = body.querySelector('#term-form');
                    const input = body.querySelector('#term-input');
                    const commands = {
                        help() { return "Available: help, echo <text>, date, clear, open-extensions, open-proxy"; },
                        date() { return new Date().toString(); },
                        clear() { out.textContent = ''; return ''; },
                        'open-extensions'() { try { openExtensionsWindow(); } catch {} return 'Opening Extensions…'; },
                        'open-proxy'() { try { document.querySelector('.tab[data-tab="wave-proxy"]')?.click(); } catch {} return 'Switching to Proxy tab…'; }
                    };
                    form.addEventListener('submit', (ev) => {
                        ev.preventDefault();
                        const cmd = (input.value || '').trim();
                        if (!cmd) return;
                        out.textContent += `\n$ ${cmd}\n`;
                        const [name, ...rest] = cmd.split(/\s+/);
                        if (name === 'echo') {
                            out.textContent += rest.join(' ') + '\n';
                        } else if (commands[name]) {
                            const r = commands[name]();
                            if (typeof r === 'string' && r) out.textContent += r + '\n';
                        } else {
                            out.textContent += `Unknown command: ${name}\n`;
                        }
                        input.value = '';
                        out.scrollTop = out.scrollHeight;
                    });
                    return;
                }
                if (action === 'personalize') {
                    openBackgroundChanger();
                    return;
                }
                if (action === 'refresh') {
                    // Soft refresh: re-run autosort if available and re-render tips progress
                    try {
                        const grid = document.getElementById('games-grid');
                        grid && grid.__autoLayout && grid.__autoLayout();
                    } catch {}
                    // Visual feedback via tips bar progress reset
                    try {
                        const bar = document.getElementById('tipsProgressBar');
                        if (bar) { bar.style.transitionDuration = '0s'; bar.style.width = '0%'; setTimeout(()=>{ bar.style.transitionDuration='5s'; bar.style.width='100%'; }, 30); }
                    } catch {}
                    return;
                }
            });

            // Handle per-card context menu actions
            cardMenu.addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.getAttribute('data-action');
                const target = cardMenuTarget;
                hideCardMenu();
                if (!target) return;

                if (action === 'open') {
                    // Simulate double-click to open the game
                    target.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
                    return;
                }
                if (action === 'add-to-folder') {
                    // Collect existing folders
                    const folders = Array.from(document.querySelectorAll('#games-grid .folder-card'));
                    if (!folders.length) {
                        // If no folders, create one near the menu and prompt rename, then add
                        const x = parseInt(cardMenu.style.left || '100', 10) + 8;
                        const y = parseInt(cardMenu.style.top || '100', 10) + 8;
                        const folder = createFolderAt(x, y);
                        startRename(folder);
                        addChildToFolder(folder, target);
                        // Hide icon since it's inside folder now
                        target.style.display = 'none';
                        return;
                    }

                    // Build a small chooser popover next to the menu
                    const chooser = document.createElement('div');
                    chooser.className = 'desktop-context';
                    chooser.style.minWidth = '220px';
                    chooser.innerHTML = `
                        <div style="padding:6px 8px 4px 8px;color:#aef">Add to folder</div>
                        <div class="sep"></div>
                        <div id="folder-list"></div>
                        <div class="sep"></div>
                        <div class="menu-item" data-action="new-folder-inline">+ New Folder…</div>
                    `;
                    document.body.appendChild(chooser);

                    // Populate folder list
                    const list = chooser.querySelector('#folder-list');
                    folders.forEach(f => {
                        const name = f.getAttribute('data-title') || f.querySelector('.game-caption')?.textContent?.trim() || 'Folder';
                        const row = document.createElement('div');
                        row.className = 'menu-item';
                        row.textContent = name;
                        row.addEventListener('click', () => {
                            addChildToFolder(f, target);
                            target.style.display = 'none';
                            chooser.remove();
                        });
                        list.appendChild(row);
                    });

                    // Position chooser near the card menu
                    const mx = parseInt(cardMenu.style.left || '100', 10);
                    const my = parseInt(cardMenu.style.top || '100', 10);
                    chooser.style.left = (mx + 8) + 'px';
                    chooser.style.top = (my + 8) + 'px';
                    // ensure viewport
                    const cr = chooser.getBoundingClientRect();
                    const vw = window.innerWidth, vh = window.innerHeight;
                    if (cr.right > vw - 4) chooser.style.left = (vw - cr.width - 4) + 'px';
                    if (cr.bottom > vh - 4) chooser.style.top = (vh - cr.height - 4) + 'px';
                    chooser.classList.add('open');

                    const cleanup = (ev) => {
                        if (!chooser.contains(ev.target)) {
                            chooser.remove();
                            document.removeEventListener('click', cleanup, true);
                            window.removeEventListener('blur', cleanup, true);
                            window.removeEventListener('resize', cleanup, true);
                            document.removeEventListener('scroll', cleanup, true);
                        }
                    };
                    document.addEventListener('click', cleanup, true);
                    window.addEventListener('blur', cleanup, true);
                    window.addEventListener('resize', cleanup, true);
                    document.addEventListener('scroll', cleanup, true);

                    chooser.addEventListener('click', (ev) => {
                        const it = ev.target.closest('.menu-item');
                        if (!it) return;
                        if (it.getAttribute('data-action') === 'new-folder-inline') {
                            // Create folder near chooser, rename, then add
                            const x = parseInt(chooser.style.left || '100', 10) + 8;
                            const y = parseInt(chooser.style.top || '100', 10) + 8;
                            const folder = createFolderAt(x, y);
                            startRename(folder);
                            addChildToFolder(folder, target);
                            target.style.display = 'none';
                            chooser.remove();
                        }
                    });
                }
            });
        })();
        // macOS-style menu bar: clock + title sync + functional menus
        (function macMenuBar() {
            // Ensure DOM elements exist before wiring events
            const waitFor = (sel, root = document) => new Promise(res => {
                const el = root.querySelector(sel);
                if (el) return res(el);
                const obs = new MutationObserver(() => {
                    const el2 = root.querySelector(sel);
                    if (el2) { obs.disconnect(); res(el2); }
                });
                obs.observe(document.documentElement, { childList: true, subtree: true });
            });

            const clockEl = document.getElementById('mac-clock');
            const titleEl = document.getElementById('mac-window-title');

            function tick() {
                try {
                    const now = new Date();
                    const t = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                    if (clockEl) clockEl.textContent = t;
                } catch {}
            }
            tick();
            setInterval(tick, 30000);

            function setTitle(txt) {
                if (titleEl) titleEl.textContent = txt;
            }
            setTitle('Desktop');

            // Single “Extensions” menu that opens the Extensions window
            const menuDefs = {
                // Remove File/Edit by simply not defining them.
                extensions: [
                    { label: 'Open Extensions', kbd: '⌘E', action: () => openExtensionsWindow() },
                    'sep',
                    { label: 'Popular: uBlock Origin', kbd: '', action: () => openExtensionsWindow('uBlock Origin') },
                    { label: 'Popular: Dark Reader', kbd: '', action: () => openExtensionsWindow('Dark Reader') },
                    { label: 'Popular: BetterTTV', kbd: '', action: () => openExtensionsWindow('BetterTTV') },
                ],
            };

            const menuRoot = document.getElementById('mac-menu');
            if (!menuRoot) {
                // Defer wiring if menu isn't in DOM yet
                waitFor('#mac-menu').then(initMenus);
            } else {
                initMenus(menuRoot);
            }

            function initMenus(root = menuRoot || document.getElementById('mac-menu')) {
                if (!root) return;
                // wire top-level menu interactions
                root.querySelectorAll('.mac-item').forEach(item => {
                    item.style.cursor = 'pointer';
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const key = item.dataset.menu;

                        // Special-case Extensions to open immediately like game cards do (no dropdown)
                        if (key === 'extensions') {
                            closeDropdown();
                            try { openExtensionsWindow(); } catch {}
                            return;
                        }

                        if (openState.trigger === item) {
                            closeDropdown();
                        } else {
                            openDropdown(item, key);
                        }
                    });
                    // hover to switch between menus while open (macOS-like)
                    item.addEventListener('mouseenter', () => {
                        if (openState.dd) {
                            const key = item.dataset.menu;
                            // Do not open a dropdown for Extensions (it opens a window directly)
                            if (key === 'extensions') return;
                            openDropdown(item, key);
                        }
                    });
                });
            }
            const openState = { dd: null, trigger: null };

            function buildDropdown(items) {
                const dd = document.createElement('div');
                dd.className = 'mac-dropdown';
                items.forEach(it => {
                    if (it === 'sep') {
                        const hr = document.createElement('div');
                        hr.className = 'mac-dd-sep';
                        dd.appendChild(hr);
                        return;
                    }
                    const row = document.createElement('div');
                    row.className = 'mac-dd-item';
                    row.innerHTML = `<span class="lbl">${it.label}</span><span class="kbd">${it.kbd || ''}</span>`;
                    row.addEventListener('click', (e) => {
                        e.stopPropagation();
                        try { it.action && it.action(); } finally { closeDropdown(); }
                    });
                    dd.appendChild(row);
                });
                return dd;
            }

            function closeDropdown() {
                if (openState.dd && openState.dd.parentNode) openState.dd.remove();
                if (openState.trigger) openState.trigger.classList.remove('active');
                openState.dd = null;
                openState.trigger = null;
            }

            function openDropdown(trigger, key) {
                closeDropdown();
                const items = menuDefs[key];
                if (!items) return;
                const dd = buildDropdown(items);
                trigger.classList.add('active');
                trigger.appendChild(dd);
                // position: ensure within viewport
                const rect = trigger.getBoundingClientRect();
                const ddRect = dd.getBoundingClientRect();
                if (rect.left + ddRect.width > window.innerWidth - 8) {
                    dd.style.left = Math.max(0, window.innerWidth - ddRect.width - rect.left - 8) + 'px';
                }
                openState.dd = dd;
                openState.trigger = trigger;
            }

            document.addEventListener('click', () => closeDropdown());
            window.addEventListener('blur', () => closeDropdown());

            // keyboard shortcuts (Cmd-like using Ctrl on Windows)
                    document.addEventListener('keydown', (e) => {
                        const meta = e.ctrlKey || e.metaKey;
                        if (!meta) return;
                        const k = e.key.toLowerCase();
                        if (k === 'n') { e.preventDefault(); createAppWindow('about:blank', 'New Window'); }
                        if (k === 'w') { e.preventDefault(); const top = document.querySelector('.app-window.active') || document.querySelector('.app-window:last-of-type'); top && top.remove(); }
                        if (k === 'q') { e.preventDefault(); document.querySelectorAll('.app-window').forEach(w => w.remove()); }
                        if (k === 'e') { e.preventDefault(); openExtensionsWindow(); }
                        if (k === '1') { e.preventDefault(); document.querySelector('[data-tab="games"]').click(); }
                        if (k === '2') { e.preventDefault(); document.querySelector('[data-tab="customization"]').click(); }
                        if (k === '3') { e.preventDefault(); document.querySelector('[data-tab="wave-proxy"]').click(); }
                    });

            // Sync center title on tab switches
            // If tabs are already in DOM, wire now; otherwise wait for them
            function wireTabs() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const titleMap = { 'games': 'Desktop', 'wave-proxy': 'Proxy', 'customization': 'Customization', 'ai': 'AI' };
                        setTitle(titleMap[tab.dataset.tab] || 'Wave‑X');
                        document.querySelectorAll('.mac-item').forEach(i => i.classList.remove('active'));
                        const ext = document.querySelector('.mac-item[data-menu="extensions"]');
                        if (ext) ext.classList.add('active');
                        closeDropdown();
                    });
                });
            }
            if (document.querySelector('.tab')) {
                wireTabs();
            } else {
                waitFor('.tab').then(() => wireTabs());
            }
        })();
        // Clock + location + IP removed
        (function wavexClock() {
            return;

            // live time/date from browser locale
            function tick() {
                try {
                    const now = new Date();
                    const t = now.toLocaleTimeString(undefined, { hour12: true });
                    const d = now.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    const tEl = elTime(), dEl = elDate();
                    if (tEl) tEl.textContent = t;
                    if (dEl) dEl.textContent = d;
                } catch {}
            }
            tick();
            setInterval(tick, 1000);

            // location via Intl API (timezone as place fallback)
            try {
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
                if (tz && elPlace()) elPlace().textContent = tz.replaceAll('_',' ');
            } catch {
                if (elPlace()) elPlace().textContent = 'Local';
            }

            // attempt to refine place using geolocation (user permission)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const { latitude, longitude } = pos.coords;
                        // reverse geocode via free Nominatim (no key, rate-limited)
                        const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
                        const data = await resp.json();
                        const city = data.address?.city || data.address?.town || data.address?.village || data.address?.municipality;
                        const state = data.address?.state || data.address?.region || data.address?.county;
                        const country = data.address?.country_code ? data.address.country_code.toUpperCase() : data.address?.country || '';
                        const label = [city, state, country].filter(Boolean).join(', ');
                        if (label && elPlace()) elPlace().textContent = label;
                    } catch {}
                }, () => {
                    // keep timezone text
                }, { maximumAge: 3600000, timeout: 5000 });
            }

            // public IP via ipify (simple JSON)
            (async function fetchIp() {
                try {
                    const r = await fetch('https://api.ipify.org?format=json');
                    const j = await r.json();
                    if (j?.ip && elIp()) elIp().textContent = j.ip;
                } catch {
                    if (elIp()) elIp().textContent = 'Unavailable';
                }
            })();
        })();

        // Tab switching functionality
        // Top tabs: robust click handler with null checks to avoid "buttons broken"
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.content');

        function activateTab(tabEl) {
            if (!tabEl) return;
            const targetId = tabEl.dataset ? tabEl.dataset.tab : null;
            const targetContent = targetId ? document.getElementById(targetId) : null;
            if (!targetContent) return;
            // deactivate all
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            // activate selected
            tabEl.classList.add('active');
            // defer to allow CSS transition
            setTimeout(() => targetContent.classList.add('active'), 0);
        }

        tabs.forEach(tab => {
            // ensure they are focusable/clickable
            tab.setAttribute('type', 'button');
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                activateTab(tab);
            });
            // also support keyboard activation
            tab.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    activateTab(tab);
                }
            });
        });

        // Ensure there is always one active on load and that its panel is shown
        (function ensureInitialActive() {
            const currentActive = document.querySelector('.tab.active') || document.querySelector('.tab');
            activateTab(currentActive);
        })();

        // Settings functionality
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
            // Apply scroll lock when settings panel is open
            if (panel.classList.contains('open')) {
                document.body.classList.add('scroll-lock');
            } else {
                document.body.classList.remove('scroll-lock');
            }
        }

        // Favicon change functionality
        function changeFavicon(theme) {
            const faviconOptions = document.querySelectorAll('.favicon-option');
            faviconOptions.forEach(option => option.classList.remove('active'));
            event.target.closest('.favicon-option').classList.add('active');
            
            // Update page title based on theme
            const titles = {
                'default': 'Wave-X',
                'math': 'Wave-X',
                'science': 'Wave-X',
                'history': 'Wave-X',
                'literature': 'Wave-X',
                'art': 'Wave-X'
            };
            
            document.title = titles[theme] || 'Wave-X';
            
            // You can also change the actual favicon here
            // const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
            // link.type = 'image/x-icon';
            // link.rel = 'shortcut icon';
            // link.href = `favicon-${theme}.ico`;
            // document.getElementsByTagName('head')[0].appendChild(link);
        }

/* Single stream, slow left-to-right real-time typing from just past the sidebar
   Enhanced with a scripted prompt sequence used by Launch Wave‑X:
   - prints fake proxy boot lines
   - asks "Launch Wave‑X?" then prints "Yes."
   - asks "Confirm?" then prints "Yes."
   - triggers crash shake, opens window, then resumes normal typing
*/
(function singleLineTypingBG() {
            const canvas = document.getElementById('matrixCanvas');
            const ctx = canvas.getContext('2d');
            // expose small API to orchestrate effects on demand
            const MatrixFX = { crash: () => {}, reset: () => {}, runScript: async () => {} };
            window.__MatrixFX = MatrixFX;

            // Extended code snippets to provide more variety/length
            const codeLines = [
                "init(); // boot sequence",
                "const key = generateKey(256);",
                "connect('wss://node-17');",
                "auth(handshake(key));",
                "let session = openTunnel({ cipher: 'chacha20' });",
                "for (let i = 0; i < 3; i++) scanPort(10_000 + i);",
                "const payload = encode({ id: uid(), ts: Date.now() });",
                "send(session, payload);",
                "await delay(150);",
                "if (ack()) log('ACK received'); else retry();",
                "trace('channel open');",
                "map(nodes, n => probe(n.ip));",
                "let hash = sha256(JSON.stringify(payload)).slice(0,16);",
                "updateState({ ready: true, hash });",
                "commit('pipeline.stage.3');",
                "emit('ready');",
                "// --- diagnostics ---",
                "const st = stats(session); log(JSON.stringify(st));",
                "route.add('alpha', { ttl: 30000 });",
                "on('packet', p => analyze(p));",
                "const sig = sign(payload, key); verify(sig);",
                "buffer.write(hex(rand(32)));",
                "queue.push({ job: 'persist', data: payload });",
                "flush(queue);",
                "done();",
                "// --- extended pipeline ---",
                "const cfg = loadConfig('net.yaml');",
                "const peers = discover({ region: 'us-west' });",
                "peers.forEach(p => link(p).negotiate());",
                "sync.clock(peers);",
                "let window = new SlidingWindow(128);",
                "stream = multiplex(session, window);",
                "stream.write(encrypt(payload, key));",
                "stream.flush();",
                "audit.track({ event: 'stream.flush', ts: Date.now() });",
                "const ack2 = await until(() => stream.acked(), { timeout: 2000 });",
                "if (!ack2) { backoff *= 2; retry(); }",
                "rotateKeyIfNeeded(key, usageCount);",
                "gc.cleanup({ ttl: 600000 });",
                "heartbeat.tick();",
                "telemetry.push(sampleCPU(), sampleMem());",
                "kv.put('hash', hash);",
                "kv.expire('hash', 120000);",
                "bus.emit('sync', { peers: peers.length });",
                "finalize(session);"
            ];

            let width = 0, height = 0;
            let fontSize = 16;
            let lineHeight = 22;
            let currentLineIndex = 0;
            let currentChar = 0;
            let currentX = 12; // will be set based on sidebar width in resize()
            let currentY = 24; // slightly lower so it's clearly visible
let frame = 0;

// scripted sequence state (drives custom prompts)
let scripting = false;
let script = null; // { lines: string[], index, char, atX, atY, after: function }
const SCRIPT_LINE_PAUSE = 1200; // ms between lines (WAY slower boot pacing)

            // crash state
            let crashing = false;
            let crashT = 0;              // time since crash began (frames)
            let shards = [];             // flying text shards

            function resize() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;

                // Slightly smaller font to fit more characters horizontally
                fontSize = Math.max(12, Math.min(16, Math.floor(height / 50)));
                lineHeight = Math.round(fontSize * 1.4);
                ctx.font = `${fontSize}px Consolas, 'Courier New', monospace`;
                ctx.textBaseline = 'top';

                // Align start position slightly past the sidebar so it's clearly visible
                const sidebarBase = (width <= 1024 ? 220 : 260);
                currentX = Math.floor(sidebarBase + 24); // 24px padding past the sidebar
                // keep Y within top area
                if (currentY < 24) currentY = 24;
            }

            resize();
            window.addEventListener('resize', resize);

function draw() {
                // very slow fade to leave trails but keep readable
                ctx.fillStyle = crashing ? 'rgba(0,0,0,0.12)' : 'rgba(0,0,0,0.08)';
                ctx.fillRect(0, 0, width, height);

                // choose what to type: scripted or normal
                let fullLine;
                if (scripting && script) {
                    fullLine = script.lines[script.index] || '';
                } else {
                    fullLine = codeLines[currentLineIndex];
                }
                const visibleChars = Math.min(fullLine.length, currentChar);
                const textToDraw = fullLine.slice(0, visibleChars);

/* Draw current partial line at current cursor position */
ctx.shadowColor = 'rgba(0,255,0,0.35)';
ctx.shadowBlur = 8;
ctx.fillStyle = '#0f0';
ctx.fillText(textToDraw, currentX, currentY);

// blinking cursor
ctx.shadowBlur = 0;
if (!crashing && (frame % 60) < 30) {
    ctx.fillStyle = '#9f9';
    const w = ctx.measureText(textToDraw).width;
    ctx.fillRect(currentX + w + 1, currentY + 2, 8, Math.max(2, fontSize - 6));
}

// advance typing
// Slow the per-character typing to make the boot/proxy script feel "way slower"
if (!crashing && frame % 3 === 0) { // faster cadence
    currentChar++;
}

                // Determine when to go to next line:
                // 1) We typed the whole string and paused sufficiently, OR
                // 2) The typed width reaches near the right edge (leave some margin)
                const typedWidth = ctx.measureText(textToDraw).width;
                const rightMargin = 32;
                const nearRightEdge = currentX + typedWidth > width - rightMargin;

if (!crashing) {
    if (scripting && script) {
        const typedWidth = ctx.measureText(textToDraw).width;
        const rightMargin = 32;
        const nearRightEdge = currentX + typedWidth > width - rightMargin;

        // finish line when done or edge reached
        if ((currentChar > fullLine.length + 2) || nearRightEdge) {
            // move to next line
            const sidebarBase = (width <= 1024 ? 220 : 260);
            currentX = Math.floor(sidebarBase + 24);
            currentY += lineHeight;

            // clamp and soft-clear if needed
            if (currentY + lineHeight > height - 16) {
                currentY = 24;
                ctx.fillStyle = 'rgba(0,0,0,0.4)';
                ctx.fillRect(0, 0, width, height);
            }

            // move script index after a pause
            const next = () => {
                script.index++;
                currentChar = 0;
                if (script.index >= script.lines.length) {
                    // script finished → run after callback then exit scripting
                    const after = script.after;
                    script = null;
                    scripting = false;
                    after && after();
                }
            };
            // pause to mimic thinking
            setTimeout(next, SCRIPT_LINE_PAUSE);
        }
    } else {
        // normal free typing
        if ((currentChar > fullLine.length + 28) || nearRightEdge) {
            const sidebarBase = (width <= 1024 ? 220 : 260);
            currentX = Math.floor(sidebarBase + 24);
            currentY += lineHeight;

            if (currentY + lineHeight > height - 16) {
                currentY = 24;
                ctx.fillStyle = 'rgba(0,0,0,0.4)';
                ctx.fillRect(0, 0, width, height);
            }

            currentLineIndex = (currentLineIndex + 1) % codeLines.length;
            currentChar = 0;
        }
    }
}

                // if crashing, animate shards flying inwards and colliding
                if (crashing) {
                    crashT++;
                    // periodically emit shards from left/right edges
                    if (frame % 3 === 0 && shards.length < 400) {
                        const y = Math.random() * height;
                        const s = {
                            x: Math.random() < 0.5 ? -40 : width + 40,
                            y,
                            vx:  (Math.random() < 0.5 ? 1 : -1) * (2 + Math.random() * 3),
                            vy:  (Math.random() - 0.5) * 1.2,
                            txt: codeLines[(currentLineIndex + Math.floor(Math.random()*codeLines.length)) % codeLines.length].slice(0, 6 + Math.floor(Math.random()*8)),
                            size: fontSize,
                            life: 240
                        };
                        // aim toward center
                        s.vx = s.x < 0 ? (3 + Math.random()*2) : (-3 - Math.random()*2);
                        shards.push(s);
                    }
                    // draw/update shards
                    ctx.font = `${fontSize}px Consolas, 'Courier New', monospace`;
                    ctx.fillStyle = '#8f8';
                    ctx.shadowColor = 'rgba(0,255,0,0.35)';
                    ctx.shadowBlur = 6;
                    for (let i = shards.length - 1; i >= 0; i--) {
                        const p = shards[i];
                        p.x += p.vx;
                        p.y += p.vy;
                        // slight gravity toward center line to create “collision”
                        const cx = width / 2;
                        p.vx += (cx - p.x) * 0.0006;
                        p.vy *= 0.99;
                        ctx.fillText(p.txt, p.x, p.y);
                        if (--p.life <= 0) shards.splice(i,1);
                    }
                    ctx.shadowBlur = 0;
                }

                frame++;
                requestAnimationFrame(draw);
            }

            draw();

/* crash API */
MatrixFX.crash = () => { crashing = true; crashT = 0; };
MatrixFX.reset = () => { crashing = false; crashT = 0; shards = []; };

/* scripted prompt API used by Launch Wave‑X
   lines: array of strings to type line-by-line
   after: callback executed when script finishes
*/
MatrixFX.runScript = (lines, after) => {
    if (!Array.isArray(lines) || !lines.length) return;
    // prime script session
    scripting = true;
    script = {
        lines,
        index: 0,
        char: 0,
        atX: Math.floor((width <= 1024 ? 220 : 260) + 24),
        atY: Math.floor(height * 0.30),
        after
    };
    currentX = script.atX;
    currentY = script.atY;
    currentChar = 0;

    // wipe a bit stronger to draw attention
    try {
        ctx.fillStyle = 'rgba(0,0,0,0.85)';
        ctx.fillRect(0, 0, width, height);
    } catch {}
};
        })();



        // Add smooth scroll effect on tab click
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const contentArea = document.querySelector('.content-area');
                contentArea.style.opacity = '0.7';
                setTimeout(() => {
                    contentArea.style.opacity = '1';
                }, 300);
            });
        });

        // AI Assistant (Wave‑X branded; using local proxy server)
        (function wireAiTab(){
            const chat = document.getElementById('ai-chat');
            const form = document.getElementById('ai-form');
            const input = document.getElementById('ai-input');
            const status = document.getElementById('ai-status');
            const modelPill = null;
            const keyPill = null;
            const btnClear = null;
            const btnSample = null;
            const fileInput = document.getElementById('ai-image');
            const fileList = document.getElementById('ai-image-list');
            // hold selected images as data URLs for multimodal messages
            const pendingImages = []; // [{ name, mime, dataUrl, size }]

            // Production API endpoint (HTTPS via Nginx+Certbot on api.saxbuddy.xyz)
            const API_URL = 'https://api.saxbuddy.xyz/api/chat';
            // Horizon family example; adjust to a model you have access to on your account
            // Common stable options include: 'openai/gpt-4o-mini', 'anthropic/claude-3.5-sonnet', etc.
            let MODEL = 'openrouter/horizon-beta';

            function bubble(role, text) {
                const wrap = document.createElement('div');
                wrap.style.cssText = 'display:grid;gap:6px;max-width:900px';

                const header = document.createElement('div');
                header.style.cssText = 'display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center;font-family:Consolas,monospace;font-size:12px;color:#9f9;opacity:.9';
                if (role === 'user') {
                    header.innerHTML = `<span style="filter:drop-shadow(0 0 6px rgba(0,255,0,0.35))">🧑</span><b>You</b>`;
                } else {
                    header.innerHTML = `<span style="filter:drop-shadow(0 0 6px rgba(0,255,0,0.35))">🌊</span><b>Wave‑X</b>`;
                }

                const card = document.createElement('div');
                card.style.cssText = `
                    padding:10px 12px;
                    border:1px solid rgba(0,255,0,0.25);
                    border-radius:10px;
                    background:${role === 'user' ? 'rgba(0,255,0,0.04)' : 'linear-gradient(180deg, rgba(0,255,0,0.06), rgba(0,255,0,0.03))'};
                    color:#cfc;
                    white-space:pre-wrap;
                    box-shadow: inset 0 0 0 1px rgba(0,255,0,0.08);
                `;
                card.innerHTML = `<div style="margin-top:2px">${escapeHtml(text)}</div>`;

                wrap.appendChild(header);
                wrap.appendChild(card);
                chat.appendChild(wrap);
                chat.scrollTop = chat.scrollHeight;
            }

            function escapeHtml(s) {
                // minimal escape, keep backticks etc for code-ish feel
                return (s || '').replace(/[&<>"]/g, c => ({'&':'&','<':'<','>':'>','"':'"'}[c]));
            }

            // turn File -> dataURL
            function fileToDataUrl(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // Allow overriding model by typing: model: <model-id> in chat
            function maybeCaptureInlineOverrides(text) {
                const mModel = text.match(/\bmodel:\s*([^\n]+)\b/i);
                if (mModel) {
                    MODEL = mModel[1].trim();
                    if (modelPill) modelPill.textContent = MODEL;
                }
                return text.replace(/\bmodel:\s*[^\n]+/gi, '').trim();
            }

            async function sendPrompt(prompt) {
                status.textContent = 'Thinking...';
                const cleaned = maybeCaptureInlineOverrides(prompt);

                // Build multimodal user content: text + images (as image_url items)
                const userParts = [];
                if (cleaned) {
                    userParts.push({ type: 'text', text: cleaned });
                }
                if (pendingImages.length) {
                    pendingImages.forEach(img => {
                        userParts.push({
                            type: 'image_url',
                            image_url: { url: img.dataUrl }
                        });
                    });
                }

                // Model note: Many OpenRouter models accept this OpenAI-format array-of-parts.
                // Use a vision-capable model for images (examples: openai/gpt-4o-mini, openrouter/horizon-beta if it supports images).
                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: MODEL,
                            messages: [
                                { role: 'system', content: 'You are Wave‑X assistant. Be concise. If images are provided, analyze them carefully before answering.' },
                                { role: 'user', content: userParts.length ? userParts : cleaned }
                            ],
                            temperature: 0.5,
                            max_tokens: 512,
                            // Optional metadata for the server
                            // extra_headers: {
                            //     referer: (location && location.origin) ? String(location.origin) : 'http://74.208.79.126/',
                            //     title: 'Wave-X'
                            // }
                        })
                    });
                    let bodyText = '';
                    try { bodyText = await res.clone().text(); } catch {}
                    if (!res.ok) {
                        bubble('assistant', `Error ${res.status}: ${bodyText || 'Unknown error'}`);
                        status.textContent = '';
                        return;
                    }
                    const data = bodyText ? JSON.parse(bodyText) : await res.json();
                    const msg = data?.choices?.[0]?.message?.content || '(no output)';
                    bubble('assistant', msg);
                } catch (e) {
                    bubble('assistant', `Request failed: ${e?.message || e}`);
                } finally {
                    status.textContent = '';
                }
            }

            // controls
            // Remove Clear/Sample buttons per request; keep chat clear at top-level via reload if needed.

            // file input handling
            fileInput?.addEventListener('change', async () => {
                if (!fileInput.files?.length) return;
                // Limit to a few images and reasonable size
                const maxFiles = 4;
                const maxSize = 8 * 1024 * 1024; // 8MB per image
                const selected = Array.from(fileInput.files).slice(0, maxFiles);
                for (const f of selected) {
                    if (!/^image\//.test(f.type)) continue;
                    if (f.size > maxSize) {
                        bubble('assistant', `Skipped ${f.name}: too large (>${Math.round(maxSize/1024/1024)}MB).`);
                        continue;
                    }
                    try {
                        const dataUrl = await fileToDataUrl(f);
                        pendingImages.push({ name: f.name, mime: f.type, size: f.size, dataUrl });
                    } catch (e) {
                        bubble('assistant', `Failed to read ${f.name}`);
                    }
                }
                // refresh thumbnails
                if (fileList) {
                    fileList.innerHTML = '';
                    pendingImages.forEach((img, idx) => {
                        const item = document.createElement('div');
                        item.style.cssText = 'position:relative;border:1px solid rgba(0,255,0,0.25);border-radius:8px;overflow:hidden;background:#000';
                        item.innerHTML = `
                            <img alt="" src="${img.dataUrl}" style="width:56px;height:56px;object-fit:cover;display:block"/>
                            <button data-i="${idx}" title="Remove" style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);border:1px solid rgba(0,255,0,0.35);color:#9f9;border-radius:6px;cursor:pointer;font-size:12px;padding:2px 4px">✕</button>
                        `;
                        fileList.appendChild(item);
                    });
                    fileList.querySelectorAll('button[data-i]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const i = Number(btn.getAttribute('data-i'));
                            if (!Number.isNaN(i)) {
                                pendingImages.splice(i, 1);
                                // re-render
                                const evt = new Event('change');
                                fileInput.dispatchEvent(evt);
                            }
                        });
                    });
                }
            });

            // send UX: Enter to send, Shift+Enter for newline
            input?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    form?.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            });

            form?.addEventListener('submit', (e) => {
                e.preventDefault();
                const q = (input?.value || '').trim();
                if (!q && !pendingImages.length) return;
                // Show a composite user bubble with count of images if any
                if (pendingImages.length) {
                    const count = pendingImages.length;
                    bubble('user', (q ? q + '\n\n' : '') + `[+ ${count} image${count>1?'s':''}]`);
                } else {
                    bubble('user', q);
                }
                input.value = '';
                sendPrompt(q).finally(() => {
                    // Clear images after send
                    pendingImages.splice(0, pendingImages.length);
                    if (fileList) fileList.innerHTML = '';
                    if (fileInput) fileInput.value = '';
                });
            });
        })();

        // Launch Wave‑X: button in Proxy tab opens as an app window (like games)
(function wireLaunchWaveX(){
            // hover effects for big green button (delegated once)
            document.addEventListener('mouseover', (e) => {
                const b = e.target.closest('#proxy-launch');
                if (!b) return;
                b.style.background = 'rgba(0,255,0,0.18)';
                b.style.borderColor = 'rgba(0,255,0,0.45)';
                b.style.boxShadow = '0 0 28px rgba(0,255,0,0.28), inset 0 0 0 1px rgba(0,255,0,0.14)';
                b.style.transform = 'translateY(-1px)';
            }, true);
            document.addEventListener('mouseout', (e) => {
                const b = e.target.closest('#proxy-launch');
                if (!b) return;
                b.style.background = 'rgba(0,255,0,0.10)';
                b.style.borderColor = 'rgba(0,255,0,0.35)';
                b.style.boxShadow = '0 0 20px rgba(0,255,0,0.12), inset 0 0 0 1px rgba(0,255,0,0.10)';
                b.style.transform = 'translateY(0)';
            }, true);
            // sidebar button (optional) still switches to Proxy tab
            const sideBtn = document.getElementById('launch-wavex');
            if (sideBtn) {
                sideBtn.addEventListener('click', () => {
                    const proxyTab = document.querySelector('.tab[data-tab="wave-proxy"]');
                    proxyTab && proxyTab.click();
                });
            }
/* proxy tab launch button now opens an app-window containing the proxy iframe */
function attachProxyLaunch() {
    const launch = document.getElementById('proxy-launch');
    if (!launch) return false;
launch.addEventListener('click', () => {
        // Compose scripted sequence: slow boot proxy subsystem + confirm flow (no fast crash/animation)
        const lines = [
            "> boot proxy subsystem …",
            "> resolving upstream via uvv2",
            "> hydrating tunnel: chacha20 · ok",
            "> peer sync: 3/3",
            "",
            "Confirm?",
            "Yes.",
            "Launching…",
        ];

        // Run script; when done: open window only (no crash shake), then reset typing
        try {
            window.__MatrixFX && window.__MatrixFX.runScript(lines, () => {
                const url = 'https://uvv2.rhw.one/active/';
                const win = createAppWindow(url, 'Wave‑X Proxy');
                // expose handle globally for control buttons
                window.__proxyAppWin = win;
                try {
                    // Larger initial size by default
                    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
                    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
                    const targetW = Math.floor(Math.min(1100, vw - 40));
                    const targetH = Math.floor(Math.min(740, vh - 120));
                    win.style.width = targetW + 'px';
                    win.style.height = targetH + 'px';
                    const grid = document.querySelector('.games-grid') || document.body;
                    const gb = grid.getBoundingClientRect();
                    const left = Math.max(12, gb.left + (gb.width - targetW) * 0.5);
                    const top  = Math.max(56, gb.top + 24);
                    win.style.left = left + 'px';
                    win.style.top  = top  + 'px';
                } catch {}
                // reset effect back to normal code typing (no crash/reset animation)
                setTimeout(() => { try { window.__MatrixFX && window.__MatrixFX.reset(); } catch {} }, 200);
            });
        } catch {
            // Fallback: open immediately if scripting API missing
            const url = 'https://uvv2.rhw.one/active/';
            createAppWindow(url, 'Wave‑X Proxy');
            setTimeout(() => { try { window.__MatrixFX && window.__MatrixFX.reset(); } catch {} }, 200);
        }
    });
    return true;
}
            // try now; if content panel not yet active, observe for it
            if (!attachProxyLaunch()) {
                const obs = new MutationObserver(() => {
                    if (attachProxyLaunch()) obs.disconnect();
                });
                obs.observe(document.body, { childList: true, subtree: true });
            }

            // Wire extra toolbar buttons in Proxy tab
            (function wireProxyControls(){
                const byId = (id) => document.getElementById(id);
                const btnRestart = byId('px-restart');
                const btnNewTab  = byId('px-newtab');
                const btnFull    = byId('px-fullscreen');
                const btnThrottle= byId('px-throttle');
                const btnPrivacy = byId('px-privacy');
                const btnClear   = byId('px-clear');

                function withProxyIframe(fn) {
                    const win = window.__proxyAppWin;
                    if (!win) return;
                    const iframe = win.querySelector('iframe.app-iframe');
                    if (!iframe) return;
                    fn(iframe, win);
                }

                // Restart: reload current proxy window iframe
                btnRestart?.addEventListener('click', () => {
                    withProxyIframe((iframe) => {
                        try { iframe.contentWindow?.location?.reload(); } catch {}
                        // fallback hard reload
                        const src = iframe.src;
                        iframe.src = src;
                    });
                });

                // New Tab: open another in-site window to same start page
                btnNewTab?.addEventListener('click', () => {
                    createAppWindow('https://uvv2.rhw.one/active/', 'Wave‑X Proxy');
                });

                // Fullscreen: toggle maximize on the proxy window if open, else launch then maximize
                btnFull?.addEventListener('click', () => {
                    if (window.__proxyAppWin) {
                        window.__proxyAppWin.classList.toggle('maximized');
                    } else {
                        // launch then maximize
                        const fakeClick = new Event('click');
                        document.getElementById('proxy-launch')?.dispatchEvent(fakeClick);
                        setTimeout(() => {
                            window.__proxyAppWin && window.__proxyAppWin.classList.add('maximized');
                        }, 300);
                    }
                });

                // Throttle: rudimentary delay injector for setTimeout/fetch inside the proxy iframe
                let throttled = false;
                btnThrottle?.addEventListener('click', () => {
                    throttled = !throttled;
                    btnThrottle.textContent = `Throttle: ${throttled ? 'On' : 'Off'}`;
                    withProxyIframe((iframe) => {
                        try {
                            const w = iframe.contentWindow;
                            if (!w) return;
                            // inject minimal shim; safe-guard multiple times
                            const script = w.document.createElement('script');
                            script.textContent = `
                                (function(){
                                    if (window.__throttleShimInstalled) { window.__netThrottle=${throttled?'true':'false'}; return; }
                                    window.__throttleShimInstalled = true;
                                    window.__netThrottle = ${throttled?'true':'false'};
                                    const origFetch = window.fetch.bind(window);
                                    window.fetch = function(...args){
                                        const go = () => origFetch(...args);
                                        return window.__netThrottle ? new Promise(res=>setTimeout(()=>res(go()), 600)) : go();
                                    };
                                    const origSetTimeout = window.setTimeout.bind(window);
                                    window.setTimeout = function(fn, t, ...rest){
                                        const d = window.__netThrottle ? Math.min(1200, (t||0)+180) : (t||0);
                                        return origSetTimeout(fn, d, ...rest);
                                    };
                                })();
                            `;
                            w.document.documentElement.appendChild(script);
                        } catch {}
                    });
                });

                // Privacy mode: close all app windows and open a fresh blank proxy
                btnPrivacy?.addEventListener('click', () => {
                    document.querySelectorAll('.app-window').forEach(w => w.remove());
                    window.__proxyAppWin = null;
                    const win = createAppWindow('about:blank', 'Wave‑X Proxy (Private)');
                    window.__proxyAppWin = win;
                    setTimeout(() => {
                        const iframe = win.querySelector('iframe.app-iframe');
                        if (iframe) iframe.src = 'https://uvv2.rhw.one/active/';
                    }, 50);
                });

                // Clear "cache": script then clear localStorage keys used by this site and reload proxy iframe
                btnClear?.addEventListener('click', () => {
                    const lines = [
                        "> cache: clearing wavex.* keys …",
                        "> local storage: ok",
                        "> refreshing proxy …"
                    ];
                    proxyFx(lines, () => {
                        try {
                            Object.keys(localStorage).forEach(k => {
                                if (k.startsWith('wavex.')) localStorage.removeItem(k);
                            });
                        } catch {}
                        withProxyIframe((iframe) => {
                            const src = iframe.src;
                            iframe.src = 'about:blank';
                            setTimeout(()=> iframe.src = src, 60);
                        });
                    });
                });

            })();
        })();

        // Minimal "OS-like" window manager for game cards
        const windowsLayer = document.getElementById('windows-layer');

        // Styles for windows injected once
        (function injectWindowStyles() {
            const style = document.createElement('style');
            style.textContent = `
            #windows-layer {
                position: fixed;
                inset: 0;
                pointer-events: none; /* allow clicks through except on windows */
                z-index: 900; /* above content but below settings icon */
            }
            .app-window {
                position: absolute;
                top: 80px;
                left: 320px;
                width: min(900px, 70vw);
                height: min(600px, 65vh);
                background: rgba(0, 20, 0, 0.85);
                border: 1px solid rgba(0,255,0,0.35);
                border-radius: 10px;
                box-shadow: 0 10px 40px rgba(0,255,0,0.15), 0 0 0 1px rgba(0,255,0,0.15) inset;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                pointer-events: auto; /* capture interactions */
                backdrop-filter: blur(6px);
                transition: box-shadow 0.2s ease, transform 0.2s ease;
            }
            .app-window:focus-within, .app-window.active {
                box-shadow: 0 10px 50px rgba(0,255,0,0.25), 0 0 0 1px rgba(0,255,0,0.35) inset;
            }
            .app-titlebar {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.5rem 0.75rem;
                background: rgba(0, 40, 0, 0.9);
                border-bottom: 1px solid rgba(0,255,0,0.25);
                user-select: none;
                cursor: move;
                font-family: Consolas, monospace;
                color: #9f9;
            }
            .app-titlebar .title {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 700;
            }
            .app-controls {
                display: flex;
                gap: 0.5rem;
            }
            .app-btn {
                width: 28px;
                height: 24px;
                display: grid;
                place-items: center;
                background: rgba(0,255,0,0.1);
                border: 1px solid rgba(0,255,0,0.25);
                color: #9f9;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.15s ease;
            }
            .app-btn:hover {
                background: rgba(0,255,0,0.2);
                color: #dfffd9;
                box-shadow: 0 0 10px rgba(0,255,0,0.25);
            }
            .app-iframe {
                width: 100%;
                height: 100%;
                border: 0;
                background: #000;
            }
            .app-body {
                flex: 1;
                min-height: 0;
            }
            .app-resizer {
                position: absolute;
                right: 0;
                bottom: 0;
                width: 14px;
                height: 14px;
                cursor: nwse-resize;
                background: linear-gradient(135deg, transparent 50%, rgba(0,255,0,0.35) 50%);
                opacity: 0.8;
            }
            .app-window.maximized {
                top: 56px !important;
                left: calc((var(--sidebar, 260px)) + 8px) !important;
                width: calc(100vw - (var(--sidebar, 260px)) - 16px) !important;
                height: calc(100vh - 72px) !important;
                border-radius: 10px;
            }
            @media (max-width: 1024px) {
                .app-window {
                    left: 260px;
                    width: min(900px, 74vw);
                }
                .app-window.maximized {
                    left: calc((var(--sidebar, 220px)) + 8px) !important;
                    width: calc(100vw - (var(--sidebar, 220px)) - 16px) !important;
                }
            }
            @media (max-width: 768px) {
                .app-window {
                    left: 12px;
                    width: calc(100vw - 24px);
                }
                .app-window.maximized {
                    left: 8px !important;
                    width: calc(100vw - 16px) !important;
                }
            }
            `;
            document.head.appendChild(style);
        })();

        function sidebarWidth() {
            const mq = window.matchMedia('(max-width: 1024px)');
            return mq.matches ? 220 : 260;
        }

function createAppWindow(url, titleText) {
    // Always sandbox navigation to our in-site window manager: never open real browser tabs
    // Force target URLs to load inside iframe, and prevent target=_blank popouts
    try {
        // Absolute URL normalization for safety (no javascript:, mailto:, etc.)
        const a = document.createElement('a');
        a.href = url || 'about:blank';
        const safe = a.protocol === 'http:' || a.protocol === 'https:' ? a.href : 'about:blank';
        url = safe;
    } catch {
        url = 'about:blank';
    }
            const win = document.createElement('div');
            win.className = 'app-window active';
            win.style.setProperty('--sidebar', sidebarWidth() + 'px');

            const titlebar = document.createElement('div');
            titlebar.className = 'app-titlebar';

            const titleEl = document.createElement('div');
            titleEl.className = 'title';
            titleEl.innerHTML = `<span style="filter: drop-shadow(0 0 4px rgba(0,255,0,0.35))">🗔</span> <span>${titleText}</span>`;

            const controls = document.createElement('div');
            controls.className = 'app-controls';

            const btnFullscreen = document.createElement('button');
            btnFullscreen.className = 'app-btn';
            btnFullscreen.title = 'Fullscreen';
            btnFullscreen.innerHTML = '⛶';

            const btnClose = document.createElement('button');
            btnClose.className = 'app-btn';
            btnClose.title = 'Close';
            btnClose.innerHTML = '✕';

            controls.appendChild(btnFullscreen);
            controls.appendChild(btnClose);

            titlebar.appendChild(titleEl);
            titlebar.appendChild(controls);

            const body = document.createElement('div');
            body.className = 'app-body';

            const iframe = document.createElement('iframe');
            iframe.className = 'app-iframe';
            iframe.loading = 'lazy';
            iframe.referrerPolicy = 'no-referrer';
            // Sandbox to stop any window.open/popups and keep navigation inside
            // allow-same-origin is kept to let images render; disallow top-navigation
            iframe.sandbox = 'allow-scripts allow-forms allow-same-origin';
            iframe.src = url;

            // Block attempts by content to open new real browser tabs/windows
            iframe.addEventListener('load', () => {
                try {
                    const w = iframe.contentWindow;
                    if (!w) return;
                    // Neutralize window.open to open inside our app window manager instead
                    w.open = (u, t) => {
                        // ignore targets; always open another in-site app window
                        const abs = (() => {
                            try { const a = w.document.createElement('a'); a.href = u; return a.href; } catch { return 'about:blank'; }
                        })();
                        createAppWindow(abs, (u || '').toString().slice(0, 42) || 'Link');
                        return null;
                    };
                    // Intercept anchor clicks with target=_blank and route them to our window manager
                    w.document.addEventListener('click', (e) => {
                        const a = e.target && (e.target.closest ? e.target.closest('a') : null);
                        if (!a) return;
                        const href = a.getAttribute('href');
                        if (!href) return;
                        const tgt = (a.getAttribute('target') || '').toLowerCase();
                        if (tgt === '_blank') {
                            e.preventDefault();
                            // open within site window manager
                            try {
                                const abs = new URL(href, w.location.href).href;
                                createAppWindow(abs, (a.textContent || a.href || 'Link').slice(0, 42));
                            } catch {
                                createAppWindow(href, (a.textContent || 'Link').slice(0, 42));
                            }
                        }
                    }, true);
                } catch {}
            });

            body.appendChild(iframe);

            const resizer = document.createElement('div');
            resizer.className = 'app-resizer';

            win.appendChild(titlebar);
            win.appendChild(body);
            win.appendChild(resizer);

            // bring to front when interacted
            win.addEventListener('mousedown', () => {
                document.querySelectorAll('.app-window').forEach(w => w.classList.remove('active'));
                win.classList.add('active');
                // bump z-index based on time
                win.style.zIndex = String(1000 + Date.now() % 100000);
            });

            // drag logic
            (function makeDraggable() {
                let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;

                titlebar.addEventListener('mousedown', (e) => {
                    if (win.classList.contains('maximized')) return;
                    dragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = win.getBoundingClientRect();
                    startLeft = rect.left;
                    startTop = rect.top;
                    document.body.style.userSelect = 'none';
                });
                window.addEventListener('mousemove', (e) => {
                    if (!dragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    win.style.left = Math.max(8, startLeft + dx) + 'px';
                    win.style.top = Math.max(56, startTop + dy) + 'px';
                });
                window.addEventListener('mouseup', () => {
                    dragging = false;
                    document.body.style.userSelect = '';
                });
            })();

            // resize logic (bottom-right handle)
            (function makeResizable() {
                let resizing = false, startX = 0, startY = 0, startW = 0, startH = 0;
                resizer.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    if (win.classList.contains('maximized')) return;
                    resizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = win.getBoundingClientRect();
                    startW = rect.width;
                    startH = rect.height;
                    document.body.style.userSelect = 'none';
                });
                window.addEventListener('mousemove', (e) => {
                    if (!resizing) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    win.style.width = Math.max(400, startW + dx) + 'px';
                    win.style.height = Math.max(300, startH + dy) + 'px';
                });
                window.addEventListener('mouseup', () => {
                    resizing = false;
                    document.body.style.userSelect = '';
                });
            })();

            // fullscreen toggle
            btnFullscreen.addEventListener('click', () => {
                win.classList.toggle('maximized');
                // if maximizing, snap near sidebar; otherwise keep current position
                if (win.classList.contains('maximized')) {
                    win.style.top = '';
                    win.style.left = '';
                    win.style.width = '';
                    win.style.height = '';
                }
            });

            // close
            btnClose.addEventListener('click', () => {
                win.remove();
            });

            windowsLayer.appendChild(win);
            return win;
        }

        // Remove redundant outer dblclick handler to prevent duplicate opens.
        // Opening is fully handled inside desktopFreeForm() via openCard and the per-card dblclick there.
        // (No-op here on purpose.)

        /* =====================
           FPS COUNTER (HUD)
        ====================== */
        let __fpsHud;
        function ensureFpsHud() {
            if (!__fpsHud) {
                __fpsHud = document.createElement('div');
                __fpsHud.id = 'fps-hud';
                __fpsHud.style.cssText = `
                    position: fixed;
                    top: 12px;
                    left: calc(260px + 16px);
                    padding: 6px 10px;
                    background: rgba(0, 25, 0, 0.85);
                    color: #cfc;
                    border: 1px solid rgba(0,255,0,0.35);
                    border-radius: 8px;
                    font-family: Consolas, monospace;
                    font-size: 12px;
                    z-index: 1200;
                    display: grid;
                    grid-auto-flow: column;
                    gap: 12px;
                    align-items: center;
                    box-shadow: 0 0 12px rgba(0,255,0,0.2);
                `;
                __fpsHud.innerHTML = `<span>FPS: <b id="fps-now">--</b></span><span>Avg: <b id="fps-avg">--</b></span><button id="fps-close" style="background:transparent;border:1px solid rgba(0,255,0,0.35);color:#9f9;border-radius:6px;padding:2px 6px;cursor:pointer">✕</button>`;
                document.body.appendChild(__fpsHud);
                document.getElementById('fps-close').onclick = () => {
                    cancelAnimationFrame(fpsAnimId);
                    __fpsSamples.length = 0;
                    __fpsHud.remove();
                    __fpsHud = null;
                };
                // reposition on resize based on sidebar width
                window.addEventListener('resize', () => {
                    const sidebar = window.matchMedia('(max-width: 1024px)').matches ? 220 : 260;
                    __fpsHud.style.left = `calc(${sidebar}px + 16px)`;
                });
            }
            startFpsLoop();
        }
        let fpsAnimId = 0;
        const __fpsSamples = [];
        let __last = performance.now();
        function startFpsLoop() {
            function tick(now) {
                const dt = now - __last;
                __last = now;
                const fps = dt > 0 ? 1000 / dt : 0;
                __fpsSamples.push(fps);
                if (__fpsSamples.length > 120) __fpsSamples.shift(); // keep last ~2s at 60fps

                const fpsNow = document.getElementById('fps-now');
                const fpsAvg = document.getElementById('fps-avg');
                if (fpsNow && fpsAvg) {
                    fpsNow.textContent = Math.round(fps).toString();
                    const avg = __fpsSamples.reduce((a,b)=>a+b,0) / __fpsSamples.length;
                    fpsAvg.textContent = Math.round(avg).toString();
                }
                fpsAnimId = requestAnimationFrame(tick);
            }
            cancelAnimationFrame(fpsAnimId);
            fpsAnimId = requestAnimationFrame(tick);
        }

        /* =====================
           BACKGROUND CHANGER
        ====================== */
        function openBackgroundChanger() {
            const html = `
                <div style="padding:10px;display:grid;gap:10px;color:#cfc;font-family:Consolas,monospace">
                    <div style="display:grid;gap:8px">
                        <label>Theme:</label>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="bgc-btn" data-bg="matrix" title="Matrix">Matrix</button>
                            <button class="bgc-btn" data-bg="grid" title="Scan Grid">Scan Grid</button>
                            <button class="bgc-btn" data-bg="plain" title="Plain Black">Plain</button>
                        </div>
                    </div>
                    <div style="display:grid;gap:8px">
                        <label>Primary color (hex):</label>
                        <input id="bgc-color" value="#00ff00" style="background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;padding:6px;border-radius:6px" />
                    </div>
                    <div style="opacity:0.85;font-size:12px">Note: Matrix mode uses the live typing effect already on the site.</div>
                </div>
            `;
            const win = createAppWindow('about:blank', 'Background Changer');
            const doc = win.querySelector('.app-body');
            doc.innerHTML = html;

            // style buttons
            doc.querySelectorAll('.bgc-btn').forEach(btn => {
                btn.style.cssText = 'padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer';
                btn.addEventListener('mouseenter', ()=> btn.style.background='rgba(0,255,0,0.18)');
                btn.addEventListener('mouseleave', ()=> btn.style.background='rgba(0,255,0,0.08)');
            });

            const colorInput = doc.querySelector('#bgc-color');

            function applyBg(mode) {
                const canvas = document.getElementById('matrixCanvas');
                if (!canvas) return;
                const color = colorInput.value || '#00ff00';
                // Set CSS variable color influence by updating document style where we used fixed green
                // For simplicity, adjust canvas fade and body color theme
                if (mode === 'plain') {
                    canvas.style.background = '#000';
                } else if (mode === 'grid') {
                    // draw faint grid overlay via CSS
                    canvas.style.background = `
                        radial-gradient(circle at 50% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 40%, rgba(0,0,0,0.1) 60%, rgba(0,0,0,0.2) 100%),
                        linear-gradient(90deg, ${hexToRgba(color,0.08)} 1px, transparent 1px) 0 0/24px 100%,
                        linear-gradient(0deg, ${hexToRgba(color,0.06)} 1px, transparent 1px) 0 0/100% 24px, #000
                    `;
                } else {
                    canvas.style.background = '#000'; // matrix typing runs as canvas content already
                }
                // tint header and borders using chosen color
                document.documentElement.style.setProperty('--accent', color);
                // optional: update some border colors live
                document.querySelectorAll('.content, .game-card, .proxy-shell').forEach(el=>{
                    el.style.borderColor = hexToRgba(color, 0.25);
                });
            }

            doc.addEventListener('click', (e) => {
                const t = e.target;
                if (t.classList && t.classList.contains('bgc-btn')) {
                    applyBg(t.getAttribute('data-bg'));
                }
            });
            colorInput.addEventListener('change', ()=> applyBg('grid'));

            function hexToRgba(hex, a=1) {
                const m = hex.replace('#','');
                const bigint = parseInt(m.length===3? m.split('').map(s=>s+s).join(''): m,16);
                const r = (bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
                return `rgba(${r},${g},${b},${a})`;
            }
        }

        /* =====================
           BACKGROUND UPLOADER (image/video)
        ====================== */
        (function wireBackgroundUploader(){
            // ephemeral object URLs cleanup
            const __bgState = { url: '', type: 'none' };
            function revokeUrl() {
                try { __bgState.url && URL.revokeObjectURL(__bgState.url); } catch {}
                __bgState.url = '';
            }

            // Create a single reusable elements layer for background
            function ensureBgLayers() {
                let img = document.getElementById('bgImage');
                let vid = document.getElementById('bgVideoFile');
                if (!img) {
                    img = document.createElement('img');
                    img.id = 'bgImage';
                    img.alt = '';
                    img.style.cssText = 'position:fixed;inset:0;z-index:-3;object-fit:cover;width:100vw;height:100vh;display:none;background:#000';
                    document.body.appendChild(img);
                }
                if (!vid) {
                    vid = document.createElement('video');
                    vid.id = 'bgVideoFile';
                    vid.muted = true;
                    vid.loop = true;
                    vid.playsInline = true;
                    vid.style.cssText = 'position:fixed;inset:0;z-index:-3;object-fit:cover;width:100vw;height:100vh;display:none;background:#000';
                    document.body.appendChild(vid);
                }
                return { img, vid };
            }

            function applyBackgroundFromFile(file) {
                const { img, vid } = ensureBgLayers();
                // Hide both first
                img.style.display = 'none';
                vid.style.display = 'none';
                // Reset video
                try { vid.pause(); vid.removeAttribute('src'); vid.load(); } catch {}
                // Cleanup previous URL
                revokeUrl();
                const url = URL.createObjectURL(file);
                __bgState.url = url;

                const ext = (file.name.split('.').pop() || '').toLowerCase();
                const isVideo = ['mp4','webm','ogg','mov','m4v'].includes(ext) || file.type.startsWith('video/');
                const isImage = ['png','jpg','jpeg','gif','webp','bmp','avif'].includes(ext) || file.type.startsWith('image/');

                if (isVideo) {
                    vid.src = url;
                    vid.style.display = 'block';
                    // Slightly dim matrix canvas for visibility
                    const canvas = document.getElementById('matrixCanvas');
                    if (canvas) canvas.style.opacity = '0.25';
                    vid.play().catch(()=>{});
                    __bgState.type = 'video';
                } else if (isImage) {
                    img.src = url;
                    img.style.display = 'block';
                    const canvas = document.getElementById('matrixCanvas');
                    if (canvas) canvas.style.opacity = '0.55';
                    __bgState.type = 'image';
                } else {
                    // unsupported
                    const win = createAppWindow('about:blank', 'Unsupported File');
                    const body = win.querySelector('.app-body');
                    body.innerHTML = `<div style="padding:12px;color:#cfc;font-family:Consolas,monospace">Unsupported file type.</div>`;
                }
            }

            // Open the app window for uploading
            // Guard against double-open caused by overlapping click/dblclick handlers or bubbling.
            // We place a short-lived reentrancy lock and also reuse an existing window if already open.
            let __bgUploaderOpening = false;
            function openBackgroundUploader() {
                if (__bgUploaderOpening) return;
                __bgUploaderOpening = true;
                setTimeout(() => { __bgUploaderOpening = false; }, 250);

                // Reuse existing "Change Background" window if present
                const existing = Array.from(document.querySelectorAll('.app-window .app-titlebar .title span:last-child'))
                    .find(span => span.textContent === 'Change Background');
                if (existing) {
                    const winEl = existing.closest('.app-window');
                    if (winEl) {
                        // bring to front and activate
                        document.querySelectorAll('.app-window').forEach(w => w.classList.remove('active'));
                        winEl.classList.add('active');
                        winEl.style.zIndex = String(1000 + Date.now() % 100000);
                        return;
                    }
                }

                const win = createAppWindow('about:blank', 'Change Background');
                const body = win.querySelector('.app-body');
                body.innerHTML = `
                  <div style="padding:14px;display:grid;gap:12px;color:#cfc;font-family:Consolas,monospace">
                    <div style="font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px">
                      <span style="filter:drop-shadow(0 0 6px rgba(0,255,0,0.35))">🖼️</span>
                      <span>Change Background</span>
                    </div>
                    <div style="display:grid;gap:8px">
                      <label for="bg-file">Choose an image (gif, webp, png, jpg) or video (mp4, webm, mov):</label>
                      <input id="bg-file" type="file" accept="image/*,video/*" style="background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:8px;padding:8px"/>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                      <button id="bg-apply" class="bgc-btn" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">Apply</button>
                      <button id="bg-clear" class="bgc-btn" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">Clear</button>
                    </div>
                    <div style="font-size:12px;opacity:.85">Note: Files are applied locally and not uploaded to a server.</div>
                  </div>
                `;
                const fileInput = body.querySelector('#bg-file');
                const btnApply  = body.querySelector('#bg-apply');
                const btnClear  = body.querySelector('#bg-clear');

                btnApply.addEventListener('click', () => {
                    const f = fileInput.files && fileInput.files[0];
                    if (!f) { return; }
                    applyBackgroundFromFile(f);
                });
                btnClear.addEventListener('click', () => {
                    const { img, vid } = ensureBgLayers();
                    img.style.display = 'none';
                    vid.style.display = 'none';
                    try { vid.pause(); vid.removeAttribute('src'); vid.load(); } catch {}
                    const canvas = document.getElementById('matrixCanvas');
                    if (canvas) canvas.style.opacity = '1';
                    revokeUrl();
                    __bgState.type = 'none';
                });
            }

            // Hook the desktop tile with a single handler to avoid duplicate window creation.
            // Use pointerup to avoid firing both click and dblclick paths.
            document.addEventListener('pointerup', (e) => {
                const card = e.target && e.target.closest && e.target.closest('.game-card.tool-bg-uploader');
                if (!card) return;
                // Only act on double-click intent (detail===2) or Enter/Space will be handled by keyboard elsewhere
                if (e.detail === 2) {
                    e.preventDefault();
                    e.stopPropagation();
                    openBackgroundUploader();
                }
            }, true);
        })();

        /* =====================
           TEST FEATURES
        ====================== */
        function openSecretsApp() {
            const win = createAppWindow('about:blank', 'Secrets');
            const body = win.querySelector('.app-body');
            body.innerHTML = `
                <div style="padding:12px;display:grid;gap:10px;color:#cfc;font-family:Consolas,monospace">
                    <div style="font-size:18px;display:flex;align-items:center;gap:8px">
                        <span style="filter:drop-shadow(0 0 6px rgba(0,255,0,0.35))">👁️</span>
                        <strong>Secrets</strong>
                    </div>
                    <div style="font-size:13px;opacity:.9">A hidden panel for quick notes and links.</div>
                    <textarea id="secrets-notes" placeholder="Type your secrets here..." style="min-height:120px;background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:8px;padding:8px;resize:vertical;font-family:Consolas,monospace"></textarea>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <input id="secrets-link" placeholder="https://example.com" style="flex:1;min-width:220px;background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:8px;padding:6px;font-family:Consolas,monospace"/>
                        <button id="secrets-open" class="bgc-btn" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">Open Link</button>
                        <button id="secrets-save" class="bgc-btn" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">Save</button>
                        <span id="secrets-status" style="align-self:center;font-size:12px;color:#9f9;opacity:.9"></span>
                    </div>
                    <div style="margin-top:6px;display:flex;align-items:center;gap:8px">
                        <label style="display:inline-flex;align-items:center;gap:8px;">
                            <input id="brainrot-toggle-inapp" type="checkbox" style="accent-color:#00ff88;width:14px;height:14px"/>
                            <span>Brainrot mode</span>
                        </label>
                        <span id="brainrot-state" style="font-size:12px;opacity:.8"></span>
                    </div>
                </div>
            `;
            const notesEl = body.querySelector('#secrets-notes');
            const linkEl = body.querySelector('#secrets-link');
            const statusEl = body.querySelector('#secrets-status');
            const brToggle = body.querySelector('#brainrot-toggle-inapp');
            const brState = body.querySelector('#brainrot-state');

            // Load persisted notes/link
            try {
                notesEl.value = localStorage.getItem('wavex.secrets.notes') || '';
                linkEl.value = localStorage.getItem('wavex.secrets.link') || '';
            } catch {}

            // Initialize brainrot toggle based on global state
            const isBr = !!JSON.parse(localStorage.getItem('wavex.brainrot') || 'false');
            brToggle.checked = isBr;
            brState.textContent = isBr ? '(on)' : '(off)';

            brToggle.addEventListener('change', () => {
                toggleBrainrot(brToggle.checked);
                brState.textContent = brToggle.checked ? '(on)' : '(off)';
                // sync outer quick toggle if present
                const outer = document.getElementById('brainrot-toggle');
                if (outer) outer.checked = brToggle.checked;
            });

            body.querySelector('#secrets-open').addEventListener('click', () => {
                const url = (linkEl.value || '').trim();
                if (!url) { statusEl.textContent = 'Enter a link first.'; return; }
                // Open inside a new app window using our window manager
                const u = /^(https?:\/\/)/i.test(url) ? url : `https://${url}`;
                createAppWindow(u, 'Secret Link');
            });

            body.querySelector('#secrets-save').addEventListener('click', () => {
                try {
                    localStorage.setItem('wavex.secrets.notes', notesEl.value || '');
                    localStorage.setItem('wavex.secrets.link', linkEl.value || '');
                    statusEl.textContent = 'Saved.';
                    setTimeout(()=> statusEl.textContent = '', 1500);
                } catch {
                    statusEl.textContent = 'Save failed.';
                    setTimeout(()=> statusEl.textContent = '', 1500);
                }
            });
        }

        function openTestFeatures() {
            const html = `
                <div style="padding:12px;display:grid;gap:10px;color:#cfc;font-family:Consolas,monospace">
                    <label><input type="checkbox" id="tf-center" /> Force center content</label>
                    <label><input type="checkbox" id="tf-hide-sidebar" /> Hide sidebar</label>
                    <label><input type="checkbox" id="tf-raise-contrast" /> Raise contrast</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
                        <button id="tf-reset" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">Reset</button>
                    </div>
                </div>
            `;
            const win = createAppWindow('about:blank', 'Test Features');
            const doc = win.querySelector('.app-body');
            doc.innerHTML = html;

            const qs = sel => doc.querySelector(sel);
            const toggle = (cond, on, off) => cond ? on() : off && off();

            qs('#tf-center').addEventListener('change', (e)=> {
                toggle(e.target.checked,
                    ()=> document.querySelector('.content-area').style.placeItems = 'center',
                    ()=> document.querySelector('.content-area').style.placeItems = '');
            });
            qs('#tf-hide-sidebar').addEventListener('change', (e)=> {
                toggle(e.target.checked,
                    ()=> document.querySelector('.tabs-container').style.display = 'none',
                    ()=> document.querySelector('.tabs-container').style.display = '');
            });
            qs('#tf-raise-contrast').addEventListener('change', (e)=> {
                toggle(e.target.checked,
                    ()=> document.body.style.color = '#0f0',
                    ()=> document.body.style.color = '');
            });
            qs('#tf-reset').addEventListener('click', ()=> {
                document.querySelector('.content-area').style.placeItems = '';
                document.querySelector('.tabs-container').style.display = '';
                document.body.style.color = '';
                doc.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
            });
        }

        // Close settings panel when clicking outside
        document.addEventListener('click', (e) => {
        const panel = document.getElementById('settingsPanel');
        const settingsIcon = document.querySelector('.settings-icon');
        
        if (!panel.contains(e.target) && !settingsIcon && panel.classList.contains('open')) {
            panel.classList.remove('open');
            document.body.classList.remove('scroll-lock');
        }
        });

        // Brainrot runtime toggle (global)
        function toggleBrainrot(on) {
            try {
                if (on) {
                    document.body.classList.add('brainrot');
                    ensureBrainrotEffects();
                    startBrainrotRain();
                    startBrainrotTabs();
                } else {
                    document.body.classList.remove('brainrot');
                    stopBrainrotRain();
                    stopBrainrotTabs();
                }
                localStorage.setItem('wavex.brainrot', JSON.stringify(!!on));
            } catch {}
        }

        // Brainrot visual helpers
        let __brRainTimer = 0;
        let __brTabTimer = 0;
        const BRAINROT_TABS = [
            { title: "skibidi", url: "https://substackcdn.com/image/fetch/$s_!INYk!,w_520,h_272,c_fill,f_auto,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5d565fe-8522-40e9-a7f9-77009865ed04_686x386.jpeg" },
            { title: "tralalero tralala", url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSLXHHDb7PzhhlVYvp9QnsQe4BzZDIQnZ0ynA&s" },
            { title: "tung tung tung sahur", url: "https://brushme.com/static/uploads/media/products/product_thumb_12927_68348a383fe072.97120940.jpg" },
            { title: "jhon pork", url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQzV_h4QEYhyBmaHBABLWME2dwGEMnmObwhTw&s" },
            { title: "handsome squidward", url: "https://i.ytimg.com/vi/LQt88uZLujo/maxresdefault.jpg" }
        ];
        function ensureBrainrotEffects() {
            const gif = document.getElementById('brainrotGif');
            const clouds = document.getElementById('brainrotClouds');
            if (!gif || !clouds) return;

            // Seed some clouds if none
            if (!clouds.querySelector('.cloud')) {
                const count = 6;
                for (let i = 0; i < count; i++) {
                    const c = document.createElement('div');
                    c.className = 'cloud';
                    const top = Math.random() * 30 + 5;      // 5vh - 35vh
                    const scale = Math.random() * 0.7 + 0.7; // 0.7 - 1.4
                    const dur = Math.random() * 20 + 35;     // 35s - 55s
                    const delay = -Math.random() * dur;      // spread start
                    c.style.cssText = `
                        top: ${top}vh;
                        left: -25vw;
                        transform-origin: left center;
                        transform: scale(${scale});
                        animation-duration: ${dur}s;
                        animation-delay: ${delay}s;
                    `;
                    clouds.appendChild(c);
                }
            }
        }

        function startBrainrotRain() {
            stopBrainrotRain(); // reset
            const clouds = document.getElementById('brainrotClouds');
            if (!clouds) return;

            // spawn doge "raindrops" at an interval
            function spawn() {
                if (!document.body.classList.contains('brainrot')) return; // stop if mode off
                const d = document.createElement('div');
                d.className = 'raindrop';
                // random horizontal position
                const x = Math.random() * 100; // vw
                const size = Math.random() * 48 + 42; // 42 - 90px (bigger)
                const dur = Math.random() * 2.5 + 3.5; // 3.5s - 6s
                const rotStart = Math.floor(Math.random() * 360);
                d.style.cssText = `
                    left: ${x}vw;
                    top: -12vh;
                    width: ${size}px;
                    height: ${size}px;
                    animation-duration: ${dur}s;
                    transform: rotate(${rotStart}deg);
                `;
                clouds.appendChild(d);
                // cleanup after animation ends
                setTimeout(() => d.remove(), (dur + 0.2) * 1000);
            }
            // faster spawn rate for "rain"
            __brRainTimer = window.setInterval(spawn, 160);
        }

        // Periodically open random tabs/windows with specified meme images
        // Note: "open tabs in the site" = use in-page window manager only (no external window.open).
        function startBrainrotTabs() {
            // Guard: ensure our override for window.open is active globally to prevent accidental real tabs
            try {
                // Override the page-level window.open as a last line of defense
                window.open = (u, t) => {
                    const abs = (() => { try { return new URL(u, location.href).href; } catch { return 'about:blank'; } })();
                    createAppWindow(abs, (u || '').toString().slice(0, 42) || 'Link');
                    return null;
                };
            } catch {}
            stopBrainrotTabs();
            function openRandom() {
                if (!document.body.classList.contains('brainrot')) return;
                const pick = BRAINROT_TABS[Math.floor(Math.random() * BRAINROT_TABS.length)];
                // Only open inside our site using the app window manager
                try {
                    createAppWindow(pick.url, pick.title);
                } catch {}
            }
            // every ~10 seconds, but add a small jitter to avoid perfect cadence
            const base = 10000;
            __brTabTimer = window.setInterval(() => {
                // small random delay 0-1200ms
                setTimeout(openRandom, Math.random() * 1200);
            }, base);
        }

        function stopBrainrotTabs() {
            if (__brTabTimer) {
                clearInterval(__brTabTimer);
                __brTabTimer = 0;
            }
        }

        function stopBrainrotRain() {
            if (__brRainTimer) {
                clearInterval(__brRainTimer);
                __brRainTimer = 0;
            }
            const clouds = document.getElementById('brainrotClouds');
            if (clouds) {
                clouds.querySelectorAll('.raindrop').forEach(n => n.remove());
            }
        }
        // initialize from persisted state + sync any toggle UI if present
        (function initBrainrot() {
            const saved = !!JSON.parse(localStorage.getItem('wavex.brainrot') || 'false');
            if (saved) {
                document.body.classList.add('brainrot');
                ensureBrainrotEffects();
            }
            // removed outer brainrot toggle; nothing to sync here
        })();

        // Changes tab: "AI-human-like" blog-style entries + Report Bug button
(function tabSwitcher(){
            // Generic tab switching for .tab/.content with data-tab/id match
            const tabsRoot = document.getElementById('main-tabs') || document.querySelector('.tabs');
            const tabs = Array.from(tabsRoot?.querySelectorAll('.tab') || []);
            const panels = Array.from(document.querySelectorAll('.content'));

            function activate(name){
                // deactivate all
                tabs.forEach(t => {
                    const is = t.getAttribute('data-tab') === name;
                    t.classList.toggle('active', is);
                    t.setAttribute('aria-selected', String(is));
                });
                panels.forEach(p => {
                    const is = p.id === name;
                    p.classList.toggle('active', is);
                    // display is controlled by .content.active CSS, but also force display for safety
                    p.style.display = is ? 'flex' : 'none';
                });
                // update menubar title if present
                const titleNode = document.getElementById('mac-window-title');
                if (titleNode) {
                    const t = tabs.find(tb => tb.getAttribute('data-tab') === name);
                    const label = t ? t.textContent.trim() : name;
                    titleNode.textContent = label.replace(/\s+/g,' ').trim();
                }
            }

            // Enhance tab labels with .glitch wrapper for hover effect
            tabs.forEach(t => {
                // wrap inner text once
                if (!t.querySelector('.glitch')) {
                    const text = (t.textContent || '').trim();
                    const span = document.createElement('span');
                    span.className = 'glitch';
                    span.setAttribute('aria-hidden', 'false');
                    span.setAttribute('data-text', text);
                    span.textContent = text;
                    t.innerHTML = '';
                    t.appendChild(span);
                }
                t.addEventListener('click', () => activate(t.getAttribute('data-tab')));
                // give each tab an id for a11y
                if (!t.id) t.id = 'tab-' + (t.getAttribute('data-tab') || ('t-' + Math.random().toString(36).slice(2)));
            });

            // Ensure initial state consistent with any .active present
            const activeTab = tabs.find(t => t.classList.contains('active'))?.getAttribute('data-tab') || 'games';
            activate(activeTab);
        })();

        (function changesTab() {
            const FEED_ID = 'changes-feed';
            const REPORT_BTN_ID = 'changes-report-bug';
            const BUG_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSe5MFkJcZlOWjbr3fXGeBegkyPvRZYTsydxHrDjSs5YOTIOeA/viewform?usp=header';

            // A few seed entries; first load is cached to localStorage to persist user session
            const seedEntries = [
                // August 2025
                {
                    date: '2025-08-05',
                    title: 'New “Changes” tab lands',
                    body: [
                        'Shipped a dedicated Changes tab to keep updates tidy and readable.',
                        'The tab mirrors the Wave‑X look‑and‑feel and scales well on smaller screens.',
                        'This is the new home for release notes and site tweaks.'
                    ],
                    tone: 'Confident'
                },
                {
                    date: '2025-08-05',
                    title: 'Report a bug, the fast way',
                    body: [
                        'Added a Report a bug button right in the header. One click opens our form in a sandboxed window.',
                        'Bug reports go straight into our triage queue. Screenshots and steps‑to‑repro are gold.'
                    ],
                    tone: 'Helpful'
                },
                {
                    date: '2025-08-04',
                    title: 'Desktop feels smoother',
                    body: [
                        'Fine‑tuned drag thresholds and layout snapping for desktop tiles.',
                        'Small polish, big feel: selections behave more predictably and reset is snappier.'
                    ],
                    tone: 'Calm'
                },

                // July 2025 – blog posts backfilled from July 10 (Early Beta) forward
                {
                    date: '2025-07-31',
                    title: 'Proxy window polish',
                    body: [
                        'Refined the Chrome‑OS‑like proxy shell toolbar with clearer icons and spacing.',
                        'Improved tab title syncing from iframe load events and added loading state.',
                        'Hardened sandbox settings and normalized URL handling (search fallback, protocol inference).'
                    ],
                    tone: 'Polish'
                },
                {
                    date: '2025-07-28',
                    title: 'Desktop selection + multi‑drag',
                    body: [
                        'Introduced marquee selection with a dashed selection rectangle.',
                        'Multi‑select now supports group dragging with grid snapping and bounds clamping.',
                        'Persisted positions per tile with localStorage for stable layouts across reloads.'
                    ],
                    tone: 'Productivity'
                },
                {
                    date: '2025-07-26',
                    title: 'Team assembles: roles and roadmap',
                    body: [
                        'Formalized the core team: product, frontend, design, and DX. Defined on‑call rotations.',
                        'Drafted a 6‑week roadmap covering desktop UX, proxy polish, and accessibility upgrades.',
                        'Adopted lightweight RFCs for bigger changes; weekly demo cadence established.'
                    ],
                    tone: 'Org'
                },
                {
                    date: '2025-07-24',
                    title: 'Window manager stability',
                    body: [
                        'Tightened z‑index and activation logic for in‑page app windows.',
                        'ESC quick‑close shipped as an optional extension for privacy‑minded users.',
                        'Smoothed focus and prevention of accidental double opens.'
                    ],
                    tone: 'Stable'
                },
                {
                    date: '2025-07-22',
                    title: 'Feature additions: extensions and pills',
                    body: [
                        'Introduced in‑site “Extensions” with install/uninstall and persistent state.',
                        'Added top‑bar pills to reflect installed extensions with live status.',
                        'Laid the APIs for extension‑owned UI (e.g., toggle buttons in the tips bar).'
                    ],
                    tone: 'Feature'
                },
                {
                    date: '2025-07-21',
                    title: 'Brainrot visual effects (optional)',
                    body: [
                        'Added clouds and “rain” overlays gated behind Brainrot mode.',
                        'Implemented periodic fun tabs inside our in‑site window system (no external popups).',
                        'All effects are reversible and persisted with a simple toggle.'
                    ],
                    tone: 'Playful'
                },
                {
                    date: '2025-07-20',
                    title: 'Team growth: design + QA join',
                    body: [
                        'Welcomed a dedicated designer to standardize the Matrix aesthetic and component library.',
                        'Expanded QA coverage with regression checklists for drag/select, proxy tabs, and settings.',
                        'Started accessibility passes: color contrast and ARIA roles prioritized.'
                    ],
                    tone: 'Team'
                },
                {
                    date: '2025-07-18',
                    title: 'Performance HUD and autosort',
                    body: [
                        'Performance HUD extension shows FPS overlay and rolling average.',
                        'Desktop Autosort listens to container resizes and reflows tiles into neat rows.',
                        'Both features are modular extensions with install/uninstall and persistent state.'
                    ],
                    tone: 'Insightful'
                },
                {
                    date: '2025-07-16',
                    title: 'Feature additions: desktop controls',
                    body: [
                        'Added A→Z sorting and one‑click layout reset controls directly above the desktop grid.',
                        'Persisted layouts per tile and improved bounds clamping on window resize.',
                        'Prepped folder groundwork and per‑tile context menu hooks.'
                    ],
                    tone: 'Feature'
                },
                {
                    date: '2025-07-15',
                    title: 'Matrix aesthetic baseline',
                    body: [
                        'Standardized typography, grid backgrounds, and glow accents across components.',
                        'Consolidated button styles (.px‑btn) and tab visuals for consistency.',
                        'Improved accessibility: ARIA roles for tabs and panels, better focus targets.'
                    ],
                    tone: 'Design'
                },
                {
                    date: '2025-07-13',
                    title: 'Early beta desktop interactions',
                    body: [
                        'Stabilized drag thresholds for tiles to reduce accidental drags on clicks.',
                        'Introduced visual selected state and subtle hover transforms.',
                        'Captured initial user feedback on spacing and snap grid size.'
                    ],
                    tone: 'Beta'
                },
                {
                    date: '2025-07-12',
                    title: 'Desktop icons go free‑form',
                    body: [
                        'Game/app tiles now behave like a desktop: drag, snap, and persist.',
                        'Added A→Z sorting and one‑click layout reset controls.',
                        'Laid groundwork for folders and per‑tile context menus.'
                    ],
                    tone: 'Foundational'
                },
                {
                    date: '2025-07-11',
                    title: 'Early beta: tabs and panels',
                    body: [
                        'Implemented the sidebar tabs (Games, Proxy, Customization, AI) and content panels.',
                        'Hooked up an initial tab switcher and a consistent header treatment per panel.',
                        'Established a content grid to support full‑height apps like the proxy shell.'
                    ],
                    tone: 'Beta'
                },
                {
                    date: '2025-07-10',
                    title: 'Early beta & development kickoff',
                    body: [
                        'Bootstrapped Wave‑X with the Matrix canvas background and core layout (menubar, sidebar tabs, content panels).',
                        'Established styling tokens and custom cursor system with broad element coverage.',
                        'Set up local storage namespaces and utility scaffolding; formed the initial working group.'
                    ],
                    tone: 'Kickoff'
                }
            ];

            function loadEntries() {
                try {
                    const raw = localStorage.getItem('wavex.changes.entries.v1');
                    if (raw) return JSON.parse(raw);
                } catch {}
                // Seed on first run
                try { localStorage.setItem('wavex.changes.entries.v1', JSON.stringify(seedEntries)); } catch {}
                return seedEntries;
            }

            function humanize(dateStr) {
                try {
                    const d = new Date(dateStr + 'T00:00:00');
                    return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                } catch { return dateStr; }
            }

            function renderFeed(entries) {
                const feed = document.getElementById(FEED_ID);
                if (!feed) return;
                feed.innerHTML = '';
                entries.forEach(e => {
                    const toneBadge = e.tone ? `<span style="font-size:11px;opacity:.8;border:1px solid rgba(0,255,0,0.25);padding:2px 6px;border-radius:999px;background:rgba(0,255,0,0.06)">${e.tone}</span>` : '';
                    const bodyHtml = (e.body || []).map(p => `<p style="margin:0 0 8px 0;opacity:.92">${escapeHtml(p)}</p>`).join('');
                    const card = document.createElement('article');
                    card.style.cssText = 'border:1px solid rgba(0,255,0,0.18);border-radius:10px;background:rgba(0,255,0,0.04);padding:12px;display:grid;gap:8px';
                    card.innerHTML = `
                        <header style="display:flex;align-items:center;gap:10px">
                            <div style="display:grid">
                                <div style="font-weight:800;color:#eaffea">${escapeHtml(e.title || 'Update')}</div>
                                <div style="font-size:12px;opacity:.8">${humanize(e.date || '')}</div>
                            </div>
                            <div style="margin-left:auto;display:inline-flex;gap:6px;align-items:center">${toneBadge}</div>
                        </header>
                        <div>${bodyHtml}</div>
                    `;
                    feed.appendChild(card);
                });
            }

function escapeHtml(s) {
                // Proper escaping
                return String(s || '')
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>')
                    .replace(/"/g, '"')
                    .replace(/'/g, '&#039;');
            }

            // Wire report bug button to open in an in-page window (uses createAppWindow)
            function wireReportBug() {
                const btn = document.getElementById(REPORT_BTN_ID);
                if (!btn) return;
                btn.addEventListener('click', () => {
                    try { createAppWindow(BUG_FORM_URL, 'Report a bug'); } catch {
                        // Fallback to a new tab override (our window.open has been patched to use createAppWindow)
                        try { window.open(BUG_FORM_URL, '_blank'); } catch {}
                    }
                });
            }

/**
             * Initialize feed now so the “Changes” tab shows content immediately after page loads.
             * Feed persists in localStorage and can be extended later by pushing into wavex.changes.entries.v1.
             */
            renderFeed(loadEntries());
            wireReportBug();
        })();

        // Proxy tab logic (Chrome OS-like)
        (function proxyApp() {
            const shell = document.querySelector('#wave-proxy .proxy-shell');
            if (!shell) return;

            const tabsBar = shell.querySelector('.proxy-tabs');
            const view = shell.querySelector('.proxy-view');
            const urlInput = shell.querySelector('#proxy-url');
            const btnGo = shell.querySelector('.px-go');
            const btnBack = shell.querySelector('.px-back');
            const btnFwd = shell.querySelector('.px-forward');
            const btnReload = shell.querySelector('.px-reload');
            const btnNewTab = shell.querySelector('.px-newtab');
            const btnFull = shell.querySelector('.px-full');

            let activeIndex = 0;
            const frames = new Map(); // index -> iframe
            const histories = new Map(); // index -> { stack: [url], pos: number }

            function createFrame(index, src = 'about:blank') {
                const iframe = document.createElement('iframe');
                iframe.className = 'proxy-frame';
                iframe.id = `proxy-frame-${index}`;
                iframe.referrerPolicy = 'no-referrer';
                iframe.sandbox = 'allow-scripts allow-forms allow-same-origin';
                iframe.src = src;
                view.innerHTML = '';
                view.appendChild(iframe);
                frames.set(index, iframe);
                // init history
                histories.set(index, { stack: src === 'about:blank' ? [] : [src], pos: src === 'about:blank' ? -1 : 0 });
                bindFrameEvents(iframe, index);
                return iframe;
            }

            function bindFrameEvents(iframe, index) {
                iframe.addEventListener('load', () => {
                    try {
                        const title = iframe.contentDocument?.title || urlInput.value || 'New Tab';
                        const tab = tabsBar.querySelector(`.px-tab[data-index="${index}"] .px-tab-title`);
                        if (tab) tab.textContent = title.substring(0, 28);
                    } catch {
                        // cross-origin title access may fail
                    }
                });
            }

            function normalizeUrl(input) {
                const trimmed = input.trim();
                if (!trimmed) return '';
                const looksLikeUrl = /^(https?:\/\/)|^localhost|^\d{1,3}(\.\d{1,3}){3}|^[\w-]+\.[a-z]{2,}/i.test(trimmed);
                if (looksLikeUrl) {
                    return trimmed.match(/^https?:\/\//i) ? trimmed : `https://${trimmed}`;
                }
                // default to search
                const q = encodeURIComponent(trimmed);
                return `https://duckduckgo.com/?q=${q}`;
            }

            function setActiveTab(index) {
                activeIndex = index;
                tabsBar.querySelectorAll('.px-tab').forEach(t => t.classList.remove('px-active'));
                const tab = tabsBar.querySelector(`.px-tab[data-index="${index}"]`);
                if (tab) tab.classList.add('px-active');

                // show the matching frame (we recreate in view to keep simple)
                const iframe = frames.get(index);
                if (iframe) {
                    view.innerHTML = '';
                    view.appendChild(iframe);
                    try {
                        urlInput.value = iframe.contentWindow?.location?.href || '';
                    } catch {
                        urlInput.value = histories.get(index)?.stack[histories.get(index).pos] || '';
                    }
                } else {
                    createFrame(index);
                }
            }

            function addTab(src = 'about:blank') {
                const idx = Date.now(); // lightweight unique id
                const tab = document.createElement('div');
                tab.className = 'px-tab';
                tab.dataset.index = String(idx);
                tab.innerHTML = `<span class="px-tab-fav">🌐</span><span class="px-tab-title">New Tab</span><button class="px-tab-close" title="Close">✕</button>`;
                tabsBar.appendChild(tab);

                createFrame(idx, src);
                tab.addEventListener('click', (e) => {
                    if ((e.target).classList?.contains('px-tab-close')) return;
                    setActiveTab(idx);
                });
                tab.querySelector('.px-tab-close').addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(idx);
                });
                setActiveTab(idx);
            }

            function closeTab(index) {
                const tab = tabsBar.querySelector(`.px-tab[data-index="${index}"]`);
                if (tab) tab.remove();
                const wasActive = activeIndex === index;
                const iframe = frames.get(index);
                if (iframe) iframe.remove();
                frames.delete(index);
                histories.delete(index);

                const remaining = tabsBar.querySelector('.px-tab');
                if (wasActive && remaining) {
                    setActiveTab(Number(remaining.dataset.index));
                } else if (!remaining) {
                    // ensure at least one blank tab
                    addTab('about:blank');
                }
            }

            function navigateTo(input) {
                const url = normalizeUrl(input);
                if (!url) return;
                const iframe = frames.get(activeIndex) || createFrame(activeIndex);
                iframe.src = url;
                // update history
                const hist = histories.get(activeIndex) || { stack: [], pos: -1 };
                hist.stack = hist.stack.slice(0, hist.pos + 1);
                hist.stack.push(url);
                hist.pos++;
                histories.set(activeIndex, hist);
                urlInput.value = url;
                // update tab title icon to show loading state
                const tab = tabsBar.querySelector(`.px-tab[data-index="${activeIndex}"] .px-tab-title`);
                if (tab) tab.textContent = 'Loading...';
            }

            function goBack() {
                const hist = histories.get(activeIndex);
                if (!hist || hist.pos <= 0) return;
                hist.pos--;
                const url = hist.stack[hist.pos];
                frames.get(activeIndex).src = url;
                urlInput.value = url;
            }

            function goForward() {
                const hist = histories.get(activeIndex);
                if (!hist || hist.pos >= hist.stack.length - 1) return;
                hist.pos++;
                const url = hist.stack[hist.pos];
                frames.get(activeIndex).src = url;
                urlInput.value = url;
            }

            function reloadFrame() {
                const iframe = frames.get(activeIndex);
                if (!iframe) return;
                iframe.contentWindow?.location?.reload();
                // Fallback reload by reassigning src to same value
                setTimeout(() => {
                    if (!iframe.contentWindow) {
                        const src = iframe.src;
                        iframe.src = src;
                    }
                }, 300);
            }

            // wire events
            btnGo.addEventListener('click', () => navigateTo(urlInput.value));
            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') navigateTo(urlInput.value);
            });
            btnBack.addEventListener('click', goBack);
            btnFwd.addEventListener('click', goForward);
            btnReload.addEventListener('click', reloadFrame);
            btnNewTab.addEventListener('click', () => addTab('about:blank'));
            btnFull.addEventListener('click', () => {
                // open current proxy view into an app-window for immersive fullscreen-like mode
                const currentUrl = urlInput.value || 'about:blank';
                const shellRect = shell.getBoundingClientRect();
                const app = createAppWindow(currentUrl, 'Proxy');
                app.style.top = Math.max(56, shellRect.top + window.scrollY + 16) + 'px';
                app.style.left = Math.max(8, shellRect.left + 16) + 'px';
                app.classList.add('maximized');
            });

            // ensure initial tab/frame exists
            setActiveTab(0);
        })();
        // Tips rotator with 5s duration and progress bar
        (function tipsRotator(){
            const tips = Array.from(document.querySelectorAll('.tips-bar .tip'));
            const bar = document.getElementById('tipsProgressBar');
            if (!tips.length || !bar) return;
            let i = tips.findIndex(t => t.classList.contains('active'));
            if (i < 0) i = 0;
            const DUR = 5000; // 5s per tip
            function setProgress(pct, ms) {
                // set transition duration dynamically to sync with remaining time
                bar.style.transitionDuration = (ms/1000) + 's';
                requestAnimationFrame(() => { bar.style.width = pct + '%'; });
            }
            function cycle() {
                // move to next tip
                const prev = tips[i];
                i = (i + 1) % tips.length;
                const next = tips[i];
                if (prev) prev.classList.remove('active');
                if (next) next.classList.add('active');
                // reset and animate progress
                bar.style.transitionDuration = '0s';
                bar.style.width = '0%';
                // allow layout to apply then animate to 100%
                setTimeout(() => setProgress(100, DUR), 30);
            }
            // kick off initial progress for current active tip
            bar.style.width = '0%';
            setTimeout(() => setProgress(100, DUR), 30);
            setInterval(cycle, DUR);
        })();

/* Bottom ECG strip removed */
(function bottomECG() {
    return;

    let width = 0, height = 0;
    const fadeAlpha = 0.12;
    const lineMain = '#00ff7a';
    const lineGlow = 'rgba(0,255,120,0.45)';
    const gridColor = 'rgba(0,255,120,0.08)';

    // Beat parameters (randomized beat-to-beat with plausible limits)
    let bpm = 72;
    let cyclePx = 220;
    let ampScale = 1.0;
    let yDrift = 0;
    let scrollPx = 0;

    function lerp(a,b,t){ return a + (b-a)*t; }
    function rand(a,b){ return a + Math.random()*(b-a); }

    function resize() {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        width = Math.floor(window.innerWidth);
        const cssH = parseFloat(getComputedStyle(canvas).height);
        height = Math.max(28, Math.floor(cssH || 42));
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resize();
    window.addEventListener('resize', resize);

    // ECG morphology: x in [0,1] → normalized amplitude
    function ecgSample(x) {
        // timing windows (fraction of cycle)
        const pStart = 0.07, pEnd = 0.18;            // P wave dome
        const qStart = 0.24, rPeak = 0.29, sEnd = 0.35; // QRS complex
        const tStart = 0.52, tEnd = 0.82;            // T wave dome
        let y = 0;

        if (x >= pStart && x <= pEnd) {
            const u = (x - pStart) / (pEnd - pStart);
            y = Math.sin(u * Math.PI) * 0.16; // gentle atrial depolarization
        } else if (x >= qStart && x < rPeak) {
            const u = (x - qStart) / (rPeak - qStart);
            y = -0.28 * Math.sin(u * Math.PI); // Q dip
        } else if (x >= rPeak && x < sEnd) {
            const u = (x - rPeak) / (sEnd - rPeak);
            // sharp R with quick fall to S
            y = (1 - u) * 1.2 - u * 0.38;
        } else if (x >= tStart && x <= tEnd) {
            const u = (x - tStart) / (tEnd - tStart);
            y = Math.sin(u * Math.PI) * 0.34; // T wave repolarization
        } else {
            // slight baseline noise
            y = 0.012 * Math.sin((x + scrollPx * 0.002) * Math.PI * 10);
        }
        return y;
    }

    function retargetBeat() {
        // heart rate variability 58–92 bpm
        const targetBpm = rand(62, 88);
        // faster bpm → slightly smaller width to keep density natural
        const targetCycle = Math.max(150, Math.min(280, (70 / targetBpm) * 230));
        const targetAmp = rand(0.92, 1.15);
        const targetDrift = rand(-height * 0.08, height * 0.08);

        bpm = lerp(bpm, targetBpm, 0.55);
        cyclePx = lerp(cyclePx, targetCycle, 0.55);
        ampScale = lerp(ampScale, targetAmp, 0.55);
        yDrift = lerp(yDrift, targetDrift, 0.22);
    }

    // initialize randomized state
    bpm = rand(64, 84);
    cyclePx = rand(170, 250);
    ampScale = rand(0.95, 1.08);
    yDrift = rand(-height * 0.05, height * 0.05);

    let lastWrap = 0;

    function draw() {
        // fade old trail
        ctx.fillStyle = `rgba(0,0,0,${fadeAlpha})`;
        ctx.fillRect(0, 0, width, height);

        // subtle centerline grid
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.beginPath();
        const midY = Math.floor(height / 2) + 0.5;
        ctx.moveTo(0, midY);
        ctx.lineTo(width, midY);
        ctx.stroke();

        // scroll speed proportional to bpm
        const pxPerSec = Math.max(90, Math.min(280, bpm * 1.25));
        // assume ~60fps; trail fade covers jitter
        const dt = 1 / 60;
        const prev = scrollPx % cyclePx;
        scrollPx = (scrollPx + pxPerSec * dt) % cyclePx;
        const now = scrollPx % cyclePx;
        // detect wrap to new beat
        if (now < prev) {
            // avoid retargeting too frequently due to numerical quirks
            const t = performance.now();
            if (t - lastWrap > 200) {
                retargetBeat();
                lastWrap = t;
            }
        }

        // draw ECG line
        const base = height * 0.5 + yDrift;
        const amp = Math.max(6, height * 0.36) * ampScale;

        ctx.lineWidth = 2;
        ctx.strokeStyle = lineMain;
        ctx.beginPath();
        let first = true;
        for (let x = 0; x <= width; x++) {
            const xn = ((x + scrollPx) % cyclePx) / cyclePx;
            const y = base - ecgSample(xn) * amp;
            if (first) { ctx.moveTo(x + 0.5, y + 0.5); first = false; }
            else { ctx.lineTo(x + 0.5, y + 0.5); }
        }
        ctx.stroke();

        // glow pass
        ctx.shadowColor = lineGlow;
        ctx.shadowBlur = 8;
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'rgba(0,255,120,0.35)';
        ctx.stroke();
        ctx.shadowBlur = 0;

        requestAnimationFrame(draw);
    }

    requestAnimationFrame(draw);
})();

        // Extensions Window - now includes extensions that modify the site at runtime
        function openExtensionsWindow(focusName) {
            const win = createAppWindow('about:blank', 'Extensions');
            const body = win.querySelector('.app-body');

            // Helpers to sync pills in the top bar
            // Persistent install state
            const EXT_STORAGE_KEY = 'wavex.extensions.installed.v1';
            function loadInstalledSet() {
                try {
                    const raw = localStorage.getItem(EXT_STORAGE_KEY);
                    if (!raw) return new Set();
                    const arr = JSON.parse(raw);
                    return new Set(Array.isArray(arr) ? arr : []);
                } catch { return new Set(); }
            }
            function saveInstalledSet(set) {
                try {
                    localStorage.setItem(EXT_STORAGE_KEY, JSON.stringify(Array.from(set)));
                } catch {}
            }

            function pillIdFor(name){ return `pill-${name.replace(/\s+/g,'-').toLowerCase()}`; }

            function addExtPill(name, tag, installing=false, active=false) {
                const bar = document.getElementById('ext-pills');
                if (!bar) return;
                const id = pillIdFor(name);
                if (document.getElementById(id)) return;
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = 'ext-pill';
                pill.id = id;
                pill.setAttribute('data-name', name);
                pill.setAttribute('data-tag', tag);
                pill.setAttribute('aria-pressed', active ? 'true' : 'false');
                pill.title = active ? 'Click to disable' : 'Click to enable';
                pill.innerHTML = `${installing ? '<span class="spin" aria-hidden="true"></span>' : ''}<span class="nm">${name}</span><span class="tg" style="opacity:.75;font-size:11px">· ${tag}</span>`;
                bar.appendChild(pill);
            }
            function setExtPillInstalling(name, installing) {
                const pill = document.getElementById(pillIdFor(name));
                if (!pill) return;
                const has = pill.querySelector('.spin');
                if (installing && !has) {
                    const s = document.createElement('span');
                    s.className = 'spin';
                    pill.insertBefore(s, pill.firstChild);
                } else if (!installing && has) {
                    has.remove();
                }
            }
            function setExtPillActive(name, active) {
                const pill = document.getElementById(pillIdFor(name));
                if (!pill) return;
                pill.setAttribute('aria-pressed', active ? 'true' : 'false');
                pill.title = active ? 'Click to disable' : 'Click to enable';
            }
            function removeExtPill(name) {
                document.getElementById(pillIdFor(name))?.remove();
            }

            // Registry of site-actual extensions: each has install() and uninstall()
            const installedSet = loadInstalledSet();

            const EXTENSIONS = [
                {
                    name: 'Dark Matrix++',
                    desc: 'Deepens contrast, tweaks glow, and adds a global dark theme toggle.',
                    tag: 'Theme',
                    icon: '🌑',
                    installed: installedSet.has('Dark Matrix++'),
                    async install() {
                        if (document.getElementById('ext-dark-matrix-style')) return;
                        addExtPill(this.name, this.tag, true, false);
                        await new Promise(res => setTimeout(res, 22000 + Math.floor(Math.random()*8000)));
                        const s = document.createElement('style');
                        s.id = 'ext-dark-matrix-style';
                        s.textContent = `
                          :root { --mx-accent: #00ff88; }
                          body { color: #cfe; }
                          .content, .proxy-shell, .game-card::before {
                            box-shadow: 0 0 16px rgba(0,255,0,0.12), inset 0 0 0 1px rgba(0,255,0,0.08) !important;
                          }
                          .games-grid {
                            background:
                              linear-gradient(0deg, rgba(0,255,0,0.08) 1px, transparent 1px) 0 0/100% 44px,
                              linear-gradient(90deg, rgba(0,255,0,0.08) 1px, transparent 1px) 0 0/44px 100% !important;
                          }
                        `;
                        document.head.appendChild(s);
                        setExtPillInstalling(this.name, false);
                        addExtPill(this.name, this.tag, false, true);
                        this.installed = true;
                        installedSet.add(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, true);
                    },
                    uninstall() {
                        document.getElementById('ext-dark-matrix-style')?.remove();
                        this.installed = false;
                        installedSet.delete(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, false);
                    }
                },
                {
                    name: 'Desktop Autosort',
                    desc: 'Automatically lays out the desktop icons into neat rows on resize.',
                    tag: 'Productivity',
                    icon: '🗂️',
                    installed: installedSet.has('Desktop Autosort'),
                    _ro: null,
                    async install() {
                        if (this._ro) return;
                        addExtPill(this.name, this.tag, true, false);
                        await new Promise(res => setTimeout(res, 20000 + Math.floor(Math.random()*8000)));
                        const grid = document.querySelector('#games .games-grid');
                        if (!grid) return;
                        const auto = grid.__autoLayout;
                        if (!auto) return;
                        const ro = new ResizeObserver(() => {
                            try { localStorage.removeItem('wavex.games.pos.v1'); } catch {}
                            auto();
                        });
                        ro.observe(grid);
                        this._ro = ro;
                        setExtPillInstalling(this.name, false);
                        addExtPill(this.name, this.tag, false, true);
                        this.installed = true;
                        installedSet.add(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, true);
                    },
                    uninstall() {
                        if (this._ro) { try { this._ro.disconnect(); } catch {} this._ro = null; }
                        this.installed = false;
                        installedSet.delete(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, false);
                    }
                },
                {
                    name: 'Performance HUD',
                    desc: 'Shows FPS overlay and average frame rate.',
                    tag: 'Tools',
                    icon: '📈',
                    installed: installedSet.has('Performance HUD'),
                    async install() {
                        addExtPill(this.name, this.tag, true, false);
                        await new Promise(res => setTimeout(res, 20000 + Math.floor(Math.random()*8000)));
                        try { ensureFpsHud(); } catch {}
                        setExtPillInstalling(this.name, false);
                        addExtPill(this.name, this.tag, false, true);
                        this.installed = true;
                        installedSet.add(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, true);
                    },
                    uninstall() {
                        const close = document.getElementById('fps-close');
                        if (close) close.click();
                        this.installed = false;
                        installedSet.delete(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, false);
                    }
                },
                {
                    name: 'Privacy Quick‑Close',
                    desc: 'Adds ESC to close the topmost app window instantly.',
                    tag: 'Privacy',
                    icon: '🛡️',
                    installed: installedSet.has('Privacy Quick‑Close'),
                    _handler: null,
                    async install() {
                        if (this._handler) return;
                        addExtPill(this.name, this.tag, true, false);
                        await new Promise(res => setTimeout(res, 20000 + Math.floor(Math.random()*8000)));
                        const handler = (e) => {
                            if (e.key === 'Escape') {
                                const top = document.querySelector('.app-window.active') || document.querySelector('#windows-layer .app-window:last-of-type');
                                top?.remove();
                            }
                        };
                        window.addEventListener('keydown', handler);
                        this._handler = handler;
                        setExtPillInstalling(this.name, false);
                        addExtPill(this.name, this.tag, false, true);
                        this.installed = true;
                        installedSet.add(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, true);
                    },
                    uninstall() {
                        if (this._handler) {
                            window.removeEventListener('keydown', this._handler);
                            this._handler = null;
                        }
                        this.installed = false;
                        installedSet.delete(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, false);
                    }
                },
                {
                    name: 'Rain Toggle',
                    desc: 'Adds a button to toggle brainrot rain without enabling full brainrot mode.',
                    tag: 'Fun',
                    icon: '🌧️',
                    installed: installedSet.has('Rain Toggle'),
                    _btn: null,
                    async install() {
                        if (this._btn) return;
                        addExtPill(this.name, this.tag, true, false);
                        await new Promise(res => setTimeout(res, 20000 + Math.floor(Math.random()*8000)));
                        const bar = document.querySelector('.tips-bar');
                        if (!bar) return;
                        const btn = document.createElement('button');
                        btn.textContent = 'Toggle Rain';
                        btn.className = 'px-btn';
                        btn.style.cssText = 'position:absolute;right:8px;top:5px;height:24px;padding:0 8px';
                        let on = false;
                        btn.addEventListener('click', () => {
                            on = !on;
                            if (on) { try { ensureBrainrotEffects(); startBrainrotRain(); } catch {} }
                            else { try { stopBrainrotRain(); } catch {} }
                            btn.textContent = on ? 'Stop Rain' : 'Toggle Rain';
                        });
                        bar.appendChild(btn);
                        this._btn = btn;
                        setExtPillInstalling(this.name, false);
                        addExtPill(this.name, this.tag, false, true);
                        this.installed = true;
                        installedSet.add(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, true);
                    },
                    uninstall() {
                        this._btn?.remove();
                        this._btn = null;
                        try { stopBrainrotRain(); } catch {}
                        this.installed = false;
                        installedSet.delete(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, false);
                    }
                },
                {
                    name: 'High‑Contrast Mode',
                    desc: 'Boosts text and border contrast across the UI for readability.',
                    tag: 'Accessibility',
                    icon: '🌓',
                    installed: installedSet.has('High‑Contrast Mode'),
                    async install() {
                        if (document.getElementById('ext-high-contrast-style')) return;
                        addExtPill(this.name, this.tag, true, false);
                        await new Promise(res => setTimeout(res, 20000 + Math.floor(Math.random()*8000)));
                        const s = document.createElement('style');
                        s.id = 'ext-high-contrast-style';
                        s.textContent = `
                          body { color: #e6ffe6 !important; }
                          .px-btn, .tab, .app-window, .games-grid, .proxy-shell, .content {
                            border-color: rgba(0,255,0,0.45) !important;
                          }
                          .tab.active { box-shadow: inset 0 0 0 1px rgba(0,255,0,0.35), 0 0 24px rgba(0,255,0,0.22) !important; }
                        `;
                        document.head.appendChild(s);
                        setExtPillInstalling(this.name, false);
                        addExtPill(this.name, this.tag, false, true);
                        this.installed = true;
                        installedSet.add(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, true);
                    },
                    uninstall() {
                        document.getElementById('ext-high-contrast-style')?.remove();
                        this.installed = false;
                        installedSet.delete(this.name);
                        saveInstalledSet(installedSet);
                        setExtPillActive(this.name, false);
                    }
                }
            ];

            // Build UI
            const cardHtml = EXTENSIONS.map(c => `
                <div class="ext-card" data-name="${c.name}">
                    <div class="ext-row">
                        <div class="ext-icon">${c.icon}</div>
                        <div class="ext-meta">
                            <div class="ext-title">${c.name}</div>
                            <div class="ext-desc">${c.desc}</div>
                            <div class="ext-tag">${c.tag}</div>
                        </div>
                        <div class="ext-actions">
                            <button class="px-btn ext-install" data-name="${c.name}">${c.installed ? 'Installed' : 'Install'}</button>
                            <button class="px-btn ext-uninstall" data-name="${c.name}" style="margin-left:6px">Uninstall</button>
                        </div>
                    </div>
                </div>
            `).join('');

            body.innerHTML = `
                <div style="display:grid;grid-template-rows:auto 1fr;gap:10px;height:100%">
                    <div style="display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid rgba(0,255,0,0.18);background:rgba(0,30,0,0.45)">
                        <input id="ext-search" placeholder="Search extensions…" style="flex:1;min-width:120px;background:#000;border:1px solid rgba(0,255,0,0.35);color:#cfc;border-radius:8px;padding:8px 10px;font-family:Consolas,monospace"/>
                        <button id="ext-refresh" class="px-btn">Refresh</button>
                        <button id="ext-install-all" class="px-btn">Install All</button>
                        <button id="ext-uninstall-all" class="px-btn">Uninstall All</button>
                    </div>
                    <div id="ext-list" style="overflow:auto;padding:10px;display:grid;gap:10px">
                        ${cardHtml}
                    </div>
                </div>
            `;

            // Styles scoped to window
            const style = document.createElement('style');
            style.textContent = `
                .ext-card {
                    border:1px solid rgba(0,255,0,0.25);
                    border-radius:10px;
                    background:rgba(0,255,0,0.04);
                    padding:8px;
                }
                .ext-card:hover { background: rgba(0,255,0,0.08); }
                .ext-row { display:flex; gap:12px; align-items:flex-start; }
                .ext-icon { font-size:22px; filter: drop-shadow(0 0 6px rgba(0,255,0,0.35)); }
                .ext-meta { display:grid; gap:4px; flex:1; min-width:0; }
                .ext-title { font-weight:800; color:#eaffea; }
                .ext-desc { font-size:13px; color:#cfeccf; opacity:.9 }
                .ext-tag { font-size:11px; color:#9f9; opacity:.85 }
                .ext-actions { display:flex; align-items:center; }
                .ext-installed { opacity:.8; pointer-events:none; }
            `;
            win.appendChild(style);

            const list = body.querySelector('#ext-list');
            const search = body.querySelector('#ext-search');
            const btnInstallAll = body.querySelector('#ext-install-all');
            const btnUninstallAll = body.querySelector('#ext-uninstall-all');

            function toast(msg) {
                const t = document.createElement('div');
                t.textContent = msg;
                t.style.cssText = 'position:absolute;right:12px;bottom:12px;background:rgba(0,40,0,0.9);color:#cfc;border:1px solid rgba(0,255,0,0.35);padding:6px 10px;border-radius:8px;font-family:Consolas,monospace;box-shadow:0 0 12px rgba(0,255,0,0.2)';
                win.appendChild(t);
                setTimeout(()=>t.remove(), 1800);
            }

            function getExt(name) {
                return EXTENSIONS.find(e => e.name === name);
            }
            function refreshButtons() {
                list.querySelectorAll('.ext-card').forEach(card => {
                    const name = card.dataset.name;
                    const ext = getExt(name);
                    const installBtn = card.querySelector('.ext-install');
                    if (ext?.installed) {
                        installBtn.textContent = 'Installed';
                        installBtn.classList.add('ext-installed');
                        addExtPill(ext.name, ext.tag, false, true);
                        setExtPillActive(ext.name, true);
                    } else {
                        installBtn.textContent = 'Install';
                        installBtn.classList.remove('ext-installed');
                        removeExtPill(ext.name);
                    }
                });
            }

            // Clicks inside Extensions window
            list.addEventListener('click', async (e) => {
                const installBtn = e.target.closest('.ext-install');
                const uninstallBtn = e.target.closest('.ext-uninstall');
                if (installBtn) {
                    const name = installBtn.dataset.name;
                    const ext = getExt(name);
                    try {
                        // start loading spinner pill immediately
                        addExtPill(ext.name, ext.tag, true);
                        await ext?.install();
                        toast(`${name} installed`);
                    } catch {}
                    refreshButtons();
                } else if (uninstallBtn) {
                    const name = uninstallBtn.dataset.name;
                    const ext = getExt(name);
                    try { ext?.uninstall(); toast(`${name} uninstalled`); } catch {}
                    refreshButtons();
                }
            });

            btnInstallAll?.addEventListener('click', async () => {
                for (const ext of EXTENSIONS) {
                    try {
                        if (ext.installed) continue;
                        addExtPill(ext.name, ext.tag, true, false);
                        await ext.install();
                        refreshButtons();
                    } catch {}
                }
                toast('All installed');
            });
            btnUninstallAll?.addEventListener('click', () => {
                EXTENSIONS.forEach(ext => { try { if (ext.installed) ext.uninstall(); } catch {} });
                refreshButtons();
                toast('All uninstalled');
            });

            // Top bar pills: toggle on click and persist
            document.addEventListener('click', async (e) => {
                const pill = e.target.closest && e.target.closest('.ext-pill');
                if (!pill) return;
                const name = pill.getAttribute('data-name');
                const ext = getExt(name);
                if (!ext) return;

                // If currently installing, ignore clicks
                if (pill.querySelector('.spin')) return;

                if (ext.installed) {
                    // Uninstall immediately
                    try { ext.uninstall(); } catch {}
                    refreshButtons();
                } else {
                    // Install with 20–30s simulated delay
                    try {
                        addExtPill(ext.name, ext.tag, true, false);
                        await ext.install();
                    } catch {}
                    refreshButtons();
                }
            });

            // On open, rehydrate any previously installed extensions
            (async function reapplyInstalled() {
                for (const ext of EXTENSIONS) {
                    if (ext.installed) {
                        // create pill in active state
                        addExtPill(ext.name, ext.tag, false, true);
                        setExtPillActive(ext.name, true);
                        // ensure effect is actually applied (idempotent)
                        try {
                            // Call install but skip spinner and wait by short-circuiting if artifact exists
                            // Quick apply without delay: detect by artifact presence
                            if (ext.name === 'Dark Matrix++' && !document.getElementById('ext-dark-matrix-style')) {
                                await ext.install();
                            } else if (ext.name === 'High‑Contrast Mode' && !document.getElementById('ext-high-contrast-style')) {
                                await ext.install();
                            } else if (ext.name === 'Desktop Autosort' && !ext._ro) {
                                await ext.install();
                            } else if (ext.name === 'Performance HUD' && !document.getElementById('fps-hud')) {
                                await ext.install();
                            } else if (ext.name === 'Privacy Quick‑Close' && !ext._handler) {
                                await ext.install();
                            } else if (ext.name === 'Rain Toggle' && !ext._btn) {
                                await ext.install();
                            }
                        } catch {}
                    }
                }
                refreshButtons();
            })();

            search.addEventListener('input', ()=>{
                const q = search.value.trim().toLowerCase();
                list.querySelectorAll('.ext-card').forEach(card=>{
                    const name = card.dataset.name.toLowerCase();
                    card.style.display = name.includes(q) ? '' : 'none';
                });
            });

            if (focusName) {
                search.value = focusName;
                search.dispatchEvent(new Event('input'));
            }
        }

        // INTRO SEQUENCE
        (function introSequence() {
            const intro = document.getElementById('intro');
            if (!intro) return;

            document.body.classList.add('intro-lock');

            const cracks = document.getElementById('introCracks');
            const split = document.getElementById('introSplit');
            const blocked = document.querySelector('.intro-image');

            // Build 32 columns with randomized speeds and stagger
            const columns = 32;
            const charset = '01[]{}/\\<>=+-_*#@&$%';
            const makeCode = (len) => Array.from({length: len}, () => charset[Math.floor(Math.random()*charset.length)]).join('');
            for (let i = 0; i < columns; i++) {
                const col = document.createElement('div');
                col.className = 'col';
                const spdA = 1.1 + Math.random() * 0.6;
                const spdB = 0.95 + Math.random() * 0.5;
                // Stagger first pass left->right
                const delayA = 0.8 + (i * 0.03);
                // Stagger second pass right->left
                const delayB = 1.6 + ((columns - 1 - i) * 0.03);
                col.style.setProperty('--spdA', spdA.toFixed(2) + 's');
                col.style.setProperty('--delayA', delayA.toFixed(2) + 's');
                col.style.setProperty('--spdB', spdB.toFixed(2) + 's');
                col.style.setProperty('--delayB', delayB.toFixed(2) + 's');
                col.dataset.code = makeCode(120);
                cracks.appendChild(col);
            }

            // Start bidirectional sweeps that cause shake and progressive cracking
            cracks.classList.add('ltr');
            setTimeout(() => cracks.classList.add('rtl'), 700);

            // Intensify shake while sweeps pass across
            const startShakeAt = 550;
            const stopShakeAt = 1050;
            setTimeout(() => blocked && blocked.classList.add('shake','crack-left'), startShakeAt);
            setTimeout(() => blocked && blocked.classList.remove('shake'), stopShakeAt);

            // Initiate full split top-to-bottom, removing any background remnants
            setTimeout(() => {
                if (blocked) blocked.classList.add('cracked');
                if (split) split.classList.add('split');

                // After the "image breaks", show welcome and fade it away (slightly later for visibility)
                setTimeout(() => {
                    const welcome = document.getElementById('welcomeBanner');
                    if (welcome) {
                        welcome.classList.add('show');
                        // Remove after animation completes
                        setTimeout(() => {
                            welcome.remove();
                        }, 2000);
                    }
                }, 150); // appear shortly after the split begins

                // Hide the blocked layer so nothing is left faded in the background
                setTimeout(() => {
                    if (blocked) blocked.style.display = 'none';
                }, 300);
            }, 950);

            // Fade out the entire intro overlay to reveal site
            const total = 2600;
            setTimeout(() => intro.classList.add('intro-out'), 1900);
            setTimeout(() => {
                intro.remove();
                document.body.classList.remove('intro-lock');
            }, total);
        })();
        /* ===========
           FREE-FORM DESKTOP ICONS WITH PERSISTENCE
           =========== */
        (function desktopFreeForm() {
            // Folder persistence (name, position, and contained card IDs)
            const STORAGE_FOLDERS = 'wavex.folders.v1';
            const STORAGE_CARD_FOLDER = 'wavex.card2folder.v1'; // cardId -> folderId mapping

            function loadFolders() {
                try { return JSON.parse(localStorage.getItem(STORAGE_FOLDERS) || '[]'); } catch { return []; }
            }
            function saveFolders(folders) {
                try { localStorage.setItem(STORAGE_FOLDERS, JSON.stringify(folders)); } catch {}
            }
            function loadCardFolderMap() {
                try { return JSON.parse(localStorage.getItem(STORAGE_CARD_FOLDER) || '{}'); } catch { return {}; }
            }
            function saveCardFolderMap(map) {
                try { localStorage.setItem(STORAGE_CARD_FOLDER, JSON.stringify(map)); } catch {}
            }

            // Create a folder card DOM element from a folder model
            function createFolderCard(folder) {
                const card = document.createElement('div');
                card.className = 'game-card folder-card';
                card.id = folder.id;
                card.setAttribute('data-title', folder.name || 'Folder');
                card.style.left = (folder.x ?? 12) + 'px';
                card.style.top  = (folder.y ?? 12) + 'px';
                card.innerHTML = `
                    <div class="folder-thumb" aria-hidden="true">📁</div>
                    <div class="game-caption"></div>
                `;
                // editable caption
                const cap = card.querySelector('.game-caption');
                cap.contentEditable = 'true';
                cap.spellcheck = false;
                cap.textContent = folder.name || 'Folder';
                cap.addEventListener('blur', () => {
                    const name = (cap.textContent || 'Folder').trim() || 'Folder';
                    card.setAttribute('data-title', name);
                    // persist rename
                    const folders = loadFolders();
                    const f = folders.find(f => f.id === folder.id);
                    if (f) { f.name = name; saveFolders(folders); }
                });
                cap.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); cap.blur(); }
                });
                return card;
            }

            // Ensure any existing plain folder visuals get editable captions and persisted names
            function upgradeExistingFolderCards(gridRoot) {
                const folders = Array.from(gridRoot.querySelectorAll('.game-card.folder-card'));
                folders.forEach(card => {
                    const caption = card.querySelector('.game-caption');
                    if (caption && caption.getAttribute('contenteditable') !== 'true') {
                        caption.contentEditable = 'true';
                        caption.spellcheck = false;
                        caption.addEventListener('blur', () => {
                            const name = (caption.textContent || 'Folder').trim() || 'Folder';
                            card.setAttribute('data-title', name);
                            // sync to model
                            const list = loadFolders();
                            const id = card.id || (card.id = 'folder-' + Date.now());
                            let f = list.find(x => x.id === id);
                            if (!f) { f = { id, name, x: parseFloat(card.style.left)||12, y: parseFloat(card.style.top)||12, items: [] }; list.push(f); }
                            f.name = name;
                            saveFolders(list);
                        });
                        caption.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') { e.preventDefault(); caption.blur(); }
                        });
                    }
                });
            }
            const GRID_SIZE = 44; // px snap size (matches background grid)
            const STORAGE_POS_GAMES = 'wavex.games.pos.v1';
            const STORAGE_POS_APPS  = 'wavex.apps.pos.v1';
            const STORAGE_POS_CUSTOM = 'wavex.custom.pos.v1';

            const desktops = [
                { root: document.querySelector('#games .games-grid'), key: STORAGE_POS_GAMES, type: 'games' },
                { root: document.querySelector('#apps  .games-grid'), key: STORAGE_POS_APPS,  type: 'apps'  },
                { root: document.querySelector('#customization #customization-grid'), key: STORAGE_POS_CUSTOM, type: 'custom' }
            ].filter(x => x.root);

            function ensureId(el, idx) {
                if (!el.id) {
                    el.id = el.getAttribute('data-title')?.toLowerCase().replace(/\s+/g,'-') || `card-${idx}-${Date.now()}`;
                }
                return el.id;
            }

            function loadPositions(key) {
                try { return JSON.parse(localStorage.getItem(key) || '{}'); }
                catch { return {}; }
            }
            function savePositions(key, positions) {
                localStorage.setItem(key, JSON.stringify(positions));
            }

            function snap(v) {
                return Math.max(4, Math.round(v / GRID_SIZE) * GRID_SIZE);
            }

            desktops.forEach(({ root, key, type }) => {
                const bounds = () => root.getBoundingClientRect();
                const positions = loadPositions(key);

                // Rehydrate persisted folders into the Games grid only
                if (type === 'games') {
                    // Upgrade pre-existing folders to have editable captions with persistence
                    upgradeExistingFolderCards(root);
                    const existingIds = new Set(Array.from(root.querySelectorAll('.game-card')).map(e => e.id).filter(Boolean));
                    const folders = loadFolders();
                    folders.forEach(f => {
                        if (!existingIds.has(f.id)) {
                            const node = createFolderCard(f);
                            root.appendChild(node);
                            existingIds.add(f.id);
                        } else {
                            // apply saved position/name to existing node
                            const node = document.getElementById(f.id);
                            if (node) {
                                node.style.left = (f.x ?? 12) + 'px';
                                node.style.top  = (f.y ?? 12) + 'px';
                                node.setAttribute('data-title', f.name || 'Folder');
                                const cap = node.querySelector('.game-caption');
                                if (cap) cap.textContent = f.name || 'Folder';
                            }
                        }
                    });
                }
                // Keep a copy of initial DOM order by title for sort reset/reference
                const initialOrder = Array.from(root.querySelectorAll('.game-card')).map(el => el);
                root.__initialOrder = initialOrder;

                // Reflow icons responsively on first paint and when container size changes (no saved positions)
                const ro = new ResizeObserver(() => {
                    const b = bounds();
                    const hasAnySaved = Object.keys(positions).length > 0;
                    if (hasAnySaved) return; // keep user's saved layout
                const cards = Array.from(root.querySelectorAll('.game-card'));
                root.__cards = cards;
                    const COL_W = 160;
                    const ROW_H = 140;
                    const LEFT_PAD = 12;
                    const TOP_PAD  = 12;
                    const cols = Math.max(1, Math.floor((b.width - LEFT_PAD * 2) / COL_W));
                    cards.forEach((card, idx) => {
                        const col = idx % cols;
                        const row = Math.floor(idx / cols);
                        const x = snap(LEFT_PAD + col * COL_W);
                        const y = snap(TOP_PAD  + row * ROW_H);
                        card.style.left = x + 'px';
                        card.style.top  = y + 'px';
                    });
                });
                ro.observe(root);

                // Initialize card ids and apply saved positions or auto layout (grid-like, row-first)
                const cards = Array.from(root.querySelectorAll('.game-card'));
                const b0 = bounds();
                const COL_W = 160;  // approx tile width incl. gutter
                const ROW_H = 140;  // approx tile height incl. gutter
                const LEFT_PAD = 12;
                const TOP_PAD  = 12;

                // compute how many columns fit
                const cols = Math.max(1, Math.floor((b0.width - LEFT_PAD * 2) / COL_W));
                root.__autoLayout = function(cardsList) {
                    const b = bounds();
                    const cols2 = Math.max(1, Math.floor((b.width - LEFT_PAD * 2) / COL_W));
                    (cardsList || Array.from(root.querySelectorAll('.game-card'))).forEach((card, idx) => {
                        const col = idx % cols2;
                        const row = Math.floor(idx / cols2);
                        const x = snap(LEFT_PAD + col * COL_W);
                        const y = snap(TOP_PAD  + row * ROW_H);
                        card.style.left = x + 'px';
                        card.style.top  = y + 'px';
                    });
                };

                cards.forEach((card, idx) => {
                    const id = ensureId(card, idx);
                    const pos = positions[id];
                    if (pos && Number.isFinite(pos.x) && Number.isFinite(pos.y)) {
                        // use saved position
                        card.style.left = pos.x + 'px';
                        card.style.top  = pos.y + 'px';
                    } else {
                        // lay out in rows (left-to-right, then wrap)
                        const col = idx % cols;
                        const row = Math.floor(idx / cols);
                        const x = snap(LEFT_PAD + col * COL_W);
                        const y = snap(TOP_PAD  + row * ROW_H);
                        card.style.left = x + 'px';
                        card.style.top  = y + 'px';
                    }
                    card.setAttribute('draggable', 'false'); // we will use pointer/mouse DnD
                    if (!card.hasAttribute('tabindex')) card.setAttribute('tabindex','0');
                });

                // Selection box and multi-select
                let selecting = false, selBox, startSel = {x:0,y:0};
                function clearSelection() { cards.forEach(c => c.classList.remove('selected')); }
                root.addEventListener('pointerdown', (e) => {
                    if (!(e.target.closest('.game-card'))) {
                        selecting = true;
                        startSel = { x: e.clientX, y: e.clientY };
                        selBox = document.createElement('div');
                        selBox.className = 'selection-box';
                        root.appendChild(selBox);
                        selBox.style.left = startSel.x - bounds().left + 'px';
                        selBox.style.top  = startSel.y - bounds().top  + 'px';
                        clearSelection();
                        root.setPointerCapture(e.pointerId);
                    }
                });
                root.addEventListener('pointermove', (e) => {
                    if (!selecting || !selBox) return;
                    const b = bounds();
                    const x1 = Math.min(startSel.x, e.clientX) - b.left;
                    const y1 = Math.min(startSel.y, e.clientY) - b.top;
                    const x2 = Math.max(startSel.x, e.clientX) - b.left;
                    const y2 = Math.max(startSel.y, e.clientY) - b.top;
                    selBox.style.left = x1 + 'px';
                    selBox.style.top  = y1 + 'px';
                    selBox.style.width  = (x2 - x1) + 'px';
                    selBox.style.height = (y2 - y1) + 'px';
                    // hit test cards
                    const rSel = { left:x1, top:y1, right:x2, bottom:y2 };
                    cards.forEach(c => {
                        const r = c.getBoundingClientRect();
                        const cx1 = r.left - b.left, cy1 = r.top - b.top;
                        const cx2 = cx1 + r.width, cy2 = cy1 + r.height;
                        const overlaps = !(cx2 < rSel.left || cx1 > rSel.right || cy2 < rSel.top || cy1 > rSel.bottom);
                        c.classList.toggle('selected', overlaps);
                    });
                });
                root.addEventListener('pointerup', (e) => {
                    if (selecting) {
                        selecting = false;
                        selBox && selBox.remove();
                        selBox = null;
                        root.releasePointerCapture(e.pointerId);
                    }
                });

                // Drag single or multiple selected icons with pointer events
                let dragging = false;
                let dragStart = { x:0, y:0 };
                let originals = new Map(); // card -> {x,y}

                function beginDrag(target, e) {
                    const selected = cards.filter(c => c.classList.contains('selected'));
                    const group = selected.length ? selected : [target];
                    group.forEach(c => {
                        c.classList.add('dragging');
                        originals.set(c, {
                            x: parseFloat(c.style.left) || 0,
                            y: parseFloat(c.style.top) || 0
                        });
                    });
                    dragStart = { x: e.clientX, y: e.clientY };
                    dragging = true;
                    root.setPointerCapture(e.pointerId);
                }

                function moveDrag(e) {
                    if (!dragging) return;
                    const dx = e.clientX - dragStart.x;
                    const dy = e.clientY - dragStart.y;
                    const b = bounds();
                    originals.forEach((pos, card) => {
                        let nx = pos.x + dx;
                        let ny = pos.y + dy;
                        nx = Math.min(Math.max(4, nx), b.width - card.offsetWidth - 4);
                        ny = Math.min(Math.max(4, ny), b.height - card.offsetHeight - 4);
                        card.style.left = nx + 'px';
                        card.style.top  = ny + 'px';
                    });
                }

                function endDrag(e) {
                    if (!dragging) return;
                    // snap and save
                    originals.forEach((_, card) => {
                        const nx = snap(parseFloat(card.style.left) || 0);
                        const ny = snap(parseFloat(card.style.top)  || 0);
                        card.style.left = nx + 'px';
                        card.style.top  = ny + 'px';
                        const id = ensureId(card, 0);
                        positions[id] = { x: nx, y: ny };
                        // if it's a folder card on games grid, persist its position in folder model too
                        if (type === 'games' && card.classList.contains('folder-card')) {
                            const folders = loadFolders();
                            const f = folders.find(x => x.id === card.id);
                            if (f) { f.x = nx; f.y = ny; saveFolders(folders); }
                        }
                    });
                    savePositions(key, positions);
                    originals.forEach((_, card) => card.classList.remove('dragging'));
                    originals.clear();
                    dragging = false;
                    try { root.releasePointerCapture(e.pointerId); } catch {}
                }

                // Pointer event handlers on cards
                const DRAG_THRESHOLD = 6; // pixels before starting drag
                const clickTimers = new WeakMap(); // for distinguishing click vs dblclick
                const suppressOpenAfterDrag = new WeakSet(); // prevent open after a drag completes
                const lastOpenAt = new WeakMap(); // debounce open per-card (ms timestamp)
                const OPEN_DEBOUNCE_MS = 300;

                cards.forEach(card => {
                    let pressStart = null;
                    let startedDrag = false;

                    card.addEventListener('pointerdown', (e) => {
                        // left button only for drag/select
                        if (e.button !== 0) return;
                        pressStart = { x: e.clientX, y: e.clientY };
                        startedDrag = false;

                        // toggle selection with Ctrl/Meta, otherwise select only this
                        if (!e.ctrlKey && !e.metaKey && !card.classList.contains('selected')) {
                            cards.forEach(c => c.classList.remove('selected'));
                        }
                        card.classList.add('selected');
                    });

                    card.addEventListener('pointermove', (e) => {
                        if (!pressStart) return;
                        const dx = Math.abs(e.clientX - pressStart.x);
                        const dy = Math.abs(e.clientY - pressStart.y);
                        if (!startedDrag && (dx > DRAG_THRESHOLD || dy > DRAG_THRESHOLD)) {
                            // begin drag only after threshold exceeded
                            startedDrag = true;
                            beginDrag(card, e);
                        }
                        if (startedDrag) {
                            moveDrag(e);
                        }
                    });

                    card.addEventListener('pointerup', (e) => {
                        // if we were dragging, end it and mark to suppress open
                        if (startedDrag) {
                            endDrag(e);
                            suppressOpenAfterDrag.add(card);
                            pressStart = null;
                            startedDrag = false;
                            return;
                        }

                        // Treat as click (no movement). Use timer to detect double-click distinctly.
                        const prev = clickTimers.get(card);
                        if (prev) {
                            clearTimeout(prev);
                            clickTimers.delete(card);
                            if (!suppressOpenAfterDrag.has(card)) {
                                // open on "double-click" but guard against duplicate within debounce window
                                const now = performance.now();
                                const last = lastOpenAt.get(card) || 0;
                                if (now - last > OPEN_DEBOUNCE_MS) {
                                    lastOpenAt.set(card, now);
                                    openCard(card);
                                }
                            }
                        } else {
                            // single click just selects; set short timer so dblclick can cancel it
                            const t = setTimeout(() => {
                                clickTimers.delete(card);
                            }, 220);
                            clickTimers.set(card, t);
                        }

                        pressStart = null;
                        startedDrag = false;
                        // clear suppression after the click completes
                        suppressOpenAfterDrag.delete(card);
                    });

                    card.addEventListener('pointercancel', (e) => {
                        if (startedDrag) endDrag(e);
                        pressStart = null;
                        startedDrag = false;
                    });
                });

                // helper to open a card (mirrors dblclick handler below)
                function openCard(card) {
                    const title = card.getAttribute('data-title') || 'App';
                    // Tools open inside app windows, matching game-card behavior
                    if (card.classList.contains('tool-fps'))  { ensureFpsHud(); return; }
                    if (card.classList.contains('tool-bg'))   { openBackgroundChanger(); return; }
                    if (card.classList.contains('tool-test')) { openTestFeatures(); return; }
                    if (card.classList.contains('tool-bgvideo')) {
                        setBackgroundVideo("https://rr6---sn-bvvbaxivnuxqjvhj5nu-2qml.googlevideo.com/videoplayback?expire=1754370691&ei=Iz6RaKKnDvKVsfIPz4fNsQE&ip=185.211.32.164&id=o-AMxw-gu5MhKw46ERWCmcjHXm-1uTd2NtCtq3XiDys8wM&itag=135&aitags=133%2C134%2C135%2C160%2C242%2C243%2C244%2C278%2C394%2C395%2C396%2C397%2C598&source=youtube&requiressl=yes&xpc=EgVo2aDSNQ%3D%3D&rms=au%2Cau&gcr=us&bui=AY1jyLPyn9JuXdWGHfAd32XmKHaTcJJmEbKpwqZqhj65wRn-wOkqJVszfN4PLv0ntoCJRRW6rtYneUOa&vprv=1&svpuc=1&mime=video%2Fmp4&ns=oIWvmvPmhymFCkSAv5USy8gQ&rqh=1&gir=yes&clen=8872451&dur=232.231&lmt=1705576934958163&keepalive=yes&fexp=24350590,24350737,24350827,24351316,24351318,24351528,24352220,24352460,24352517,24352519,24352559,24352568,24352573,24352697,24352699,24352960,51331020&c=MWEB&sefc=1&txp=4532434&n=MGk-I5H6QhWpUg&sparams=expire%2Cei%2Cip%2Cid%2Caitags%2Csource%2Crequiressl%2Cxpc%2Cgcr%2Cbui%2Cvprv%2Csvpuc%2Cmime%2Cns%2Crqh%2Cgir%2Cclen%2Cdur%2Clmt&sig=AJfQdSswRQIhALmpC7cUBd5d8XFvp1FKjcPBYPHlrE8c9VIXhgp5SmBZAiB_da0Lcgkb-78IdeXvi7yvbE8UO0nALxckLD2QUYN-9Q%3D%3D&pot=MnY9jOjQ7s9ytD2yrAIwk5kYnMJiwPYI0ZPs3JZEcazjKZc0ED6-XrklO2Fea7334ulaZQpw1Jt44urTVWyrzIZiUUUZruQCRKvSqI-3VS4PqQpLJgy5cR92QFTmkdN6SZDHdfhMiBau_nrjJcrU9K8atjwfVFpM&redirect_counter=1&rm=sn-o09se7e&rrc=104&req_id=5e81209163a3a3ee&cms_redirect=yes&cmsv=e&ipbypass=yes&met=1754349155,&mh=Tv&mip=2601:1c2:4082:d3d0:5dac:6b6:93de:3283&mm=31&mn=sn-bvvbaxivnuxqjvhj5nu-2qml&ms=au&mt=1754348741&mv=m&mvi=6&pl=38&lsparams=ipbypass,met,mh,mip,mm,mn,ms,mv,mvi,pl,rms&lsig=APaTxxMwRQIgfHOoCPaBARSC_e5AUOo7STDCvkrbusTboDGxotKNDQUCIQCi2tq1TZWCaavk1Cw-5k_lAWLhFAf2i-ocE2pWmn-BZw%3D%3D");
                        return;
                    }
                    if (card.classList.contains('tool-brainrot')) {
                        // open a small window to toggle brainrot with a button
                        const win = createAppWindow('about:blank', 'Toggle Brainrot');
                        const body = win.querySelector('.app-body');
                        body.innerHTML = `
                          <div style="padding:12px;display:grid;gap:10px;color:#cfc;font-family:Consolas,monospace">
                            <div>Brainrot is currently <b>${document.body.classList.contains('brainrot') ? 'ON' : 'OFF'}</b>.</div>
                            <button id="br-toggle" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">
                              Toggle Brainrot
                            </button>
                          </div>`;
                        const btn = body.querySelector('#br-toggle');
                        btn?.addEventListener('click', () => {
                            const on = !document.body.classList.contains('brainrot');
                            toggleBrainrot(on);
                            btn.previousElementSibling.innerHTML = `Brainrot is currently <b>${on ? 'ON' : 'OFF'}</b>.`;
                            // sync outer quick toggle if present
                            const outer = document.getElementById('brainrot-toggle');
                            if (outer) outer.checked = on;
                        });
                        return;
                    }
                    if (card.classList.contains('tool-settings')) {
                        // open settings panel in a window, embedding current panel DOM
                        const win = createAppWindow('about:blank', 'Settings');
                        const body = win.querySelector('.app-body');
                        // Create simple controls that proxy to existing panel
                        body.innerHTML = `
                          <div style="padding:12px;display:grid;gap:10px;color:#cfc;font-family:Consolas,monospace">
                            <div>Open the slide-out Settings panel or pick a favicon theme.</div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                              <button id="st-open" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">Open Panel</button>
                              <button id="st-close" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,255,0,0.35);background:rgba(0,255,0,0.08);color:#bfffbf;cursor:pointer">Close Panel</button>
                            </div>
                          </div>
                        `;
                        const stOpen = body.querySelector('#st-open');
                        const stClose = body.querySelector('#st-close');
                        stOpen?.addEventListener('click', () => {
                            const panel = document.getElementById('settingsPanel');
                            if (!panel.classList.contains('open')) toggleSettings();
                        });
                        stClose?.addEventListener('click', () => {
                            const panel = document.getElementById('settingsPanel');
                            if (panel.classList.contains('open')) toggleSettings();
                        });
                        return;
                    }
                    if (card.classList.contains('tool-none')) { createAppWindow('about:blank', '(None now)'); return; }
                    const url = card.getAttribute('data-url') || 'about:blank';
                    createAppWindow(url, title);
                }

                // Keep separate dblclick as well (e.g., for touchpads). Stop propagation and debounce to single open.
                cards.forEach(card => {
                    card.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        // Guard: if a drag just happened, do not open
                        if (suppressOpenAfterDrag.has(card)) {
                            suppressOpenAfterDrag.delete(card);
                            return;
                        }
                        const now = performance.now();
                        const last = lastOpenAt.get(card) || 0;
                        if (now - last > OPEN_DEBOUNCE_MS) {
                            lastOpenAt.set(card, now);
                            openCard(card);
                        }
                    });
                });

                root.addEventListener('pointermove', moveDrag);
                root.addEventListener('pointerup', endDrag);
                root.addEventListener('pointercancel', endDrag);

                // Keyboard nudging (Alt+Arrows moves 1 grid step, Shift+Alt moves 1px)
                root.addEventListener('keydown', (e) => {
                    const selected = cards.filter(c => c.classList.contains('selected'));
                    if (!selected.length) return;
                    if (!e.altKey) return;
                    let dx = 0, dy = 0;
                    if (e.key === 'ArrowLeft')  dx = -1;
                    if (e.key === 'ArrowRight') dx = 1;
                    if (e.key === 'ArrowUp')    dy = -1;
                    if (e.key === 'ArrowDown')  dy = 1;
                    if (dx === 0 && dy === 0) return;
                    e.preventDefault();
                    const step = e.shiftKey ? 1 : GRID_SIZE;
                    const b = bounds();
                    selected.forEach(card => {
                        let nx = (parseFloat(card.style.left) || 0) + dx * step;
                        let ny = (parseFloat(card.style.top)  || 0) + dy * step;
                        nx = Math.min(Math.max(4, nx), b.width - card.offsetWidth - 4);
                        ny = Math.min(Math.max(4, ny), b.height - card.offsetHeight - 4);
                        // snap unless shift (fine movement)
                        if (!e.shiftKey) { nx = snap(nx); ny = snap(ny); }
                        card.style.left = nx + 'px';
                        card.style.top  = ny + 'px';
                        positions[card.id] = { x: nx, y: ny };
                    });
                    savePositions(key, positions);
                });

                // Persist on window resize by re-clamping icons in bounds
                window.addEventListener('resize', () => {
                    const b = bounds();
                    cards.forEach(card => {
                        let nx = parseFloat(card.style.left) || 0;
                        let ny = parseFloat(card.style.top)  || 0;
                        nx = Math.min(Math.max(4, nx), b.width - card.offsetWidth - 4);
                        ny = Math.min(Math.max(4, ny), b.height - card.offsetHeight - 4);
                        card.style.left = nx + 'px';
                        card.style.top  = ny + 'px';
                        positions[card.id] = { x: nx, y: ny };
                    });
                    savePositions(key, positions);
                });

                // Hook up header controls for games desktop only
                if (type === 'games' && root.id !== 'windows-layer') {
                    const sortBtn = document.getElementById('games-sort-alpha');
                    const resetBtn = document.getElementById('games-reset-layout');

                    // Sort A→Z by data-title, clear saved positions, reflow neatly
                    sortBtn && sortBtn.addEventListener('click', () => {
                        const list = Array.from(root.querySelectorAll('.game-card'));
                        list.sort((a,b) => {
                            const ta = (a.getAttribute('data-title') || '').toLowerCase();
                            const tb = (b.getAttribute('data-title') || '').toLowerCase();
                            return ta.localeCompare(tb);
                        });
                        // Append in sorted order to keep DOM order (drag logic unaffected)
                        list.forEach(el => root.appendChild(el));
                        // Clear saved positions so auto layout applies
                        localStorage.removeItem(STORAGE_POS_GAMES);
                        // Lay out neatly in rows
                        root.__autoLayout(list);
                    });

                    // Reset Layout: restore original DOM order and auto layout, clearing saved positions
                    resetBtn && resetBtn.addEventListener('click', () => {
                        const original = root.__initialOrder || [];
                        if (original.length) {
                            original.forEach(el => root.appendChild(el));
                        }
                        localStorage.removeItem(STORAGE_POS_GAMES);
                        root.__autoLayout(original.length ? original : Array.from(root.querySelectorAll('.game-card')));
                    });

                    // Context menu: add New Folder action with persistence
                    const gridEl = document.getElementById('games-grid');
                    if (gridEl && !gridEl.__foldersWired) {
                        gridEl.__foldersWired = true;

                        // build a shared context menu if not present
                        let deskMenu = document.querySelector('.desktop-context');
                        function findDesktopMenuWithNewFolder() {
                            const menus = Array.from(document.querySelectorAll('.desktop-context'));
                            return menus.find(m => m.textContent && m.textContent.includes('New Folder'));
                        }
                        deskMenu = findDesktopMenuWithNewFolder() || deskMenu;
                        // Click handler on document to catch "New Folder"
                        document.addEventListener('click', (ev) => {
                            const item = ev.target.closest && ev.target.closest('.desktop-context .menu-item[data-action="new-folder"]');
                            if (!item) return;
                            // Create model
                            const folders = loadFolders();
                            const id = 'folder-' + Date.now();
                            const name = 'New Folder';
                            // drop near viewport center of grid
                            const b = gridEl.getBoundingClientRect();
                            const x = Math.max(12, Math.round((b.width / 2) / 44) * 44);
                            const y = Math.max(12, Math.round((b.height / 3) / 44) * 44);
                            const folder = { id, name, x, y, items: [] };
                            folders.push(folder);
                            saveFolders(folders);
                            // Create DOM
                            const node = createFolderCard(folder);
                            gridEl.appendChild(node);
                            // focus caption to rename
                            const cap = node.querySelector('.game-caption');
                            if (cap) {
                                // small delay to ensure in DOM
                                setTimeout(() => { cap.focus(); document.execCommand && document.execCommand('selectAll', false, null); }, 30);
                            }
                        });

                        // Wire per-card "Add to Folder…" flow if the lightweight picker exists in page
                        const cardMenu = Array.from(document.querySelectorAll('.desktop-context')).find(m => m.textContent && m.textContent.includes('Add to Folder'));
                        if (cardMenu) {
                            // The existing code that opens the picker will ultimately call into this utility:
                            window.__wavexAddCardToFolder = function(cardId, folderId) {
                                const folders = loadFolders();
                                const map = loadCardFolderMap();
                                const f = folders.find(x => x.id === folderId);
                                if (!f) return;
                                // ensure items array
                                f.items = Array.isArray(f.items) ? f.items : [];
                                if (!f.items.includes(cardId)) f.items.push(cardId);
                                map[cardId] = folderId;
                                saveFolders(folders);
                                saveCardFolderMap(map);
                            };
                        }
                    }
                }
            });
        })();
    </script>
</body>
</html>
